{"version":3,"file":"forum.js","sources":["../src/forum/components/withdrawal/utils/constants.ts","../src/common/utils/IconResolver.ts","../src/forum/components/withdrawal/common/PlatformIcon.tsx","../src/forum/components/withdrawal/utils/modelHelpers.ts","../src/forum/components/withdrawal/forms/PlatformSelector.tsx","../src/forum/components/withdrawal/forms/AmountInput.tsx","../src/forum/components/withdrawal/forms/AddressInput.tsx","../src/forum/components/withdrawal/forms/MessageInput.tsx","../src/forum/components/withdrawal/forms/SubmitButton.tsx","../src/forum/components/withdrawal/forms/WithdrawalForm.tsx","../src/forum/components/withdrawal/common/StatusBadge.tsx","../src/forum/components/withdrawal/common/EmptyState.tsx","../src/forum/components/withdrawal/common/LoadingState.tsx","../src/forum/components/shared/TransactionHistory.tsx","../src/forum/components/deposit/forms/DepositForm.tsx","../src/common/services/DepositService.ts","../src/common/types/services.ts","../src/common/services/WithdrawalService.ts","../src/common/services/PlatformService.ts","../src/common/types/api.ts","../src/forum/components/FundsPage.tsx","../src/common/utils/PlatformValidation.ts","../src/common/models/WithdrawalPlatform.ts","../src/common/types/index.ts","../src/common/models/WithdrawalRequest.ts","../src/common/models/DepositPlatform.ts","../src/common/models/DepositRecord.ts","../src/forum/components/MoneyDisplay.tsx","../src/forum/components/MobileMoneyDisplay.tsx","../src/forum/utils/ConfigManager.ts","../src/forum/utils/MobileDetector.ts","../src/forum/index.ts"],"sourcesContent":["import type { StatusType, StatusClass } from '../types/interfaces';\r\n\r\n/**\r\n * Withdrawal request status constants\r\n */\r\nexport const WITHDRAWAL_STATUS: Record<string, StatusType> = {\r\n  PENDING: 'pending',\r\n  APPROVED: 'approved',\r\n  REJECTED: 'rejected',\r\n} as const;\r\n\r\n/**\r\n * Status class mapping for UI styling\r\n */\r\nexport const STATUS_CLASS_MAP: Record<StatusType, StatusClass> = {\r\n  pending: 'warning',\r\n  approved: 'success',\r\n  rejected: 'danger',\r\n} as const;\r\n\r\n/**\r\n * Tab types\r\n */\r\nexport const TABS = {\r\n  WITHDRAWAL: 'funds',\r\n  HISTORY: 'history',\r\n} as const;\r\n\r\n/**\r\n * Default values\r\n */\r\nexport const DEFAULTS = {\r\n  MIN_AMOUNT: 0.001,\r\n  MAX_AMOUNT: 10,\r\n  FEE: 0.0005,\r\n  BALANCE_PRECISION: 8,\r\n} as const;\r\n\r\n/**\r\n * CSS class names\r\n */\r\nexport const CSS_CLASSES = {\r\n  WITHDRAWAL_PAGE: 'WithdrawalPage',\r\n  MODAL: 'WithdrawalPage-modal',\r\n  HEADER: 'WithdrawalPage-header',\r\n  TABS: 'WithdrawalPage-tabs',\r\n  TAB: 'WithdrawalPage-tab',\r\n  TAB_ACTIVE: 'active',\r\n  CONTENT: 'WithdrawalPage-content',\r\n  LOADING: 'WithdrawalPage-loading',\r\n  EMPTY_STATE: 'WithdrawalPage-emptyState',\r\n} as const;\r\n\r\n/**\r\n * Icon names\r\n */\r\nexport const ICONS = {\r\n  CLOSE: 'fas fa-times',\r\n  COINS: 'fas fa-coins',\r\n  HISTORY: 'fas fa-history',\r\n  BITCOIN: 'fas fa-bitcoin',\r\n  CHEVRON_DOWN: 'fas fa-chevron-down',\r\n  PASTE: 'fas fa-paste',\r\n  BOOKMARK: 'fas fa-bookmark',\r\n} as const;","import { IconRepresentation } from '../models/CurrencyIcon';\n\ndeclare const m: any;\n\n/**\n * Icon priority order for display resolution\n */\nexport enum IconPriority {\n  PLATFORM_SPECIFIC = 1,\n  NETWORK = 2,\n  CURRENCY = 3,\n  FALLBACK = 4\n}\n\n/**\n * Helper function to get the best available icon from a platform\n */\nexport function getBestPlatformIcon(platform: any): IconRepresentation {\n  // Priority 1: Platform-specific icons\n  const platformIconUrl = platform.platformSpecificIconUrl?.();\n  if (platformIconUrl) {\n    return {\n      type: 'currency_url',\n      value: platformIconUrl,\n      alt: platform.name?.() || 'Platform icon'\n    };\n  }\n\n  const platformIconClass = platform.platformSpecificIconClass?.();\n  if (platformIconClass) {\n    return {\n      type: 'currency_class',\n      value: platformIconClass\n    };\n  }\n\n  // Priority 2: Network icons\n  const networkIconUrl = platform.networkIconUrl?.();\n  if (networkIconUrl) {\n    return {\n      type: 'currency_url',\n      value: networkIconUrl,\n      alt: platform.network?.() || 'Network icon'\n    };\n  }\n\n  const networkIconClass = platform.networkIconClass?.();\n  if (networkIconClass) {\n    return {\n      type: 'currency_class',\n      value: networkIconClass\n    };\n  }\n\n  // Priority 3: Currency icons\n  const currencyIconUrl = platform.currencyIconUrl?.();\n  if (currencyIconUrl) {\n    return {\n      type: 'currency_url',\n      value: currencyIconUrl,\n      alt: platform.symbol?.() || 'Currency icon'\n    };\n  }\n\n  const currencyIconClass = platform.currencyIconClass?.();\n  if (currencyIconClass) {\n    return {\n      type: 'currency_class',\n      value: currencyIconClass\n    };\n  }\n\n  const currencyUnicodeSymbol = platform.currencyUnicodeSymbol?.();\n  if (currencyUnicodeSymbol) {\n    return {\n      type: 'currency_unicode',\n      value: currencyUnicodeSymbol\n    };\n  }\n\n  // Priority 4: Fallback\n  return {\n    type: 'fallback',\n    value: 'fas fa-coins'\n  };\n}\n\n/**\n * Helper function to get currency icon specifically\n */\nexport function getCurrencyIcon(platform: any): IconRepresentation {\n  // Check currency icon override fields first\n  const currencyIconOverrideUrl = platform.currencyIconOverrideUrl?.();\n  if (currencyIconOverrideUrl) {\n    return {\n      type: 'currency_url',\n      value: currencyIconOverrideUrl,\n      alt: platform.symbol?.() || 'Currency icon'\n    };\n  }\n\n  const currencyIconOverrideClass = platform.currencyIconOverrideClass?.();\n  if (currencyIconOverrideClass) {\n    return {\n      type: 'currency_class',\n      value: currencyIconOverrideClass\n    };\n  }\n\n  // Fall back to computed currency icon\n  const currencyIcon = platform.currencyIcon?.();\n  if (currencyIcon) {\n    return currencyIcon;\n  }\n\n  // Direct currency icon fields\n  const currencyIconUrl = platform.currencyIconUrl?.();\n  if (currencyIconUrl) {\n    return {\n      type: 'currency_url',\n      value: currencyIconUrl,\n      alt: platform.symbol?.() || 'Currency icon'\n    };\n  }\n\n  const currencyIconClass = platform.currencyIconClass?.();\n  if (currencyIconClass) {\n    return {\n      type: 'currency_class',\n      value: currencyIconClass\n    };\n  }\n\n  const currencyUnicodeSymbol = platform.currencyUnicodeSymbol?.();\n  if (currencyUnicodeSymbol) {\n    return {\n      type: 'currency_unicode',\n      value: currencyUnicodeSymbol\n    };\n  }\n\n  return {\n    type: 'fallback',\n    value: 'fas fa-coins'\n  };\n}\n\n/**\n * Helper function to get network icon specifically\n */\nexport function getNetworkIcon(platform: any): IconRepresentation {\n  // Check network icon override fields first\n  const networkIconOverrideUrl = platform.networkIconOverrideUrl?.();\n  if (networkIconOverrideUrl) {\n    return {\n      type: 'currency_url',\n      value: networkIconOverrideUrl,\n      alt: platform.network?.() || 'Network icon'\n    };\n  }\n\n  const networkIconOverrideClass = platform.networkIconOverrideClass?.();\n  if (networkIconOverrideClass) {\n    return {\n      type: 'currency_class',\n      value: networkIconOverrideClass\n    };\n  }\n\n  // Fall back to computed network icon\n  const networkIcon = platform.networkIcon?.();\n  if (networkIcon) {\n    return networkIcon;\n  }\n\n  // Direct network icon fields\n  const networkIconUrl = platform.networkIconUrl?.();\n  if (networkIconUrl) {\n    return {\n      type: 'currency_url',\n      value: networkIconUrl,\n      alt: platform.network?.() || 'Network icon'\n    };\n  }\n\n  const networkIconClass = platform.networkIconClass?.();\n  if (networkIconClass) {\n    return {\n      type: 'currency_class',\n      value: networkIconClass\n    };\n  }\n\n  return {\n    type: 'fallback',\n    value: 'fas fa-network-wired'\n  };\n}\n\n/**\n * Render an icon representation as a Mithril element\n */\nexport function renderIcon(iconRep: IconRepresentation, additionalClasses: string = ''): Mithril.Children {\n  const baseClasses = 'icon';\n  const classes = additionalClasses ? `${baseClasses} ${additionalClasses}` : baseClasses;\n\n  switch (iconRep.type) {\n    case 'currency_url':\n      return m('img', {\n        src: iconRep.value,\n        alt: iconRep.alt || 'Icon',\n        className: `${classes} icon--image`,\n        style: {\n          width: '1em',\n          height: '1em',\n          objectFit: 'contain',\n          display: 'inline-block',\n          verticalAlign: 'middle'\n        }\n      });\n\n    case 'currency_class':\n      return m('i', {\n        className: `${classes} ${iconRep.value}`,\n        'aria-hidden': 'true'\n      });\n\n    case 'currency_unicode':\n      return m('span', {\n        className: `${classes} icon--unicode`,\n        'aria-hidden': 'true'\n      }, iconRep.value);\n\n    case 'fallback':\n    default:\n      return m('i', {\n        className: `${classes} ${iconRep.value}`,\n        'aria-hidden': 'true'\n      });\n  }\n}\n\n/**\n * Get icon priority level for sorting/comparison\n */\nexport function getIconPriority(platform: any): IconPriority {\n  if (platform.platformSpecificIconUrl?.() || platform.platformSpecificIconClass?.()) {\n    return IconPriority.PLATFORM_SPECIFIC;\n  }\n\n  if (platform.networkIconUrl?.() || platform.networkIconClass?.()) {\n    return IconPriority.NETWORK;\n  }\n\n  if (platform.currencyIconUrl?.() || platform.currencyIconClass?.() || platform.currencyUnicodeSymbol?.()) {\n    return IconPriority.CURRENCY;\n  }\n\n  return IconPriority.FALLBACK;\n}","import icon from 'flarum/common/helpers/icon';\nimport type Mithril from 'mithril';\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\nimport { ICONS } from '../utils/constants';\nimport { getBestPlatformIcon, renderIcon } from '../../../../common/utils/IconResolver';\n\ninterface PlatformIconProps {\n  platform: WithdrawalPlatform | null;\n  className?: string;\n  size?: 'small' | 'medium' | 'large';\n}\n\nexport default class PlatformIcon {\n  view(vnode: Mithril.Vnode<PlatformIconProps>): Mithril.Children {\n    const { platform, className = '', size = 'medium' } = vnode.attrs;\n\n    // Add null checks to prevent errors\n    if (!platform) {\n      return icon(ICONS.COINS, { className: `crypto-icon default ${className}` });\n    }\n\n    // Size classes\n    const sizeClass = `platform-icon-${size}`;\n    const finalClasses = `crypto-icon ${sizeClass} ${className}`;\n\n    // Use the new three-tier icon system\n    const bestIcon = getBestPlatformIcon(platform);\n    \n    return renderIcon(bestIcon, finalClasses);\n  }\n}","/**\n * Helper functions for accessing Flarum model data\n * These handle both Model instances and plain object data\n */\n\n/**\n * Get ID from Flarum model or plain object\n */\nexport const getId = (obj: any): string | number => {\n  return typeof obj.id === 'function' ? obj.id() : obj.id;\n};\n\n/**\n * Get attribute value from Flarum model or plain object\n */\nexport const getAttr = (obj: any, attr: string): any => {\n  if (typeof obj[attr] === 'function') {\n    return obj[attr]();\n  }\n  return obj.attributes ? obj.attributes[attr] : obj[attr];\n};\n\n/**\n * Get string representation of ID for comparison\n */\nexport const getIdString = (obj: any): string => {\n  return String(getId(obj));\n};\n\n/**\n * Find platform by ID with proper type handling\n */\nexport const findPlatformById = (platforms: any[], platformId: string | number): any => {\n  const platformIdStr = String(platformId);\n  return platforms.find(p => {\n    const pId = getId(p);\n    return String(pId) === platformIdStr;\n  });\n};\n\n/**\n * Safely extract and convert date attribute to Date object\n */\nexport const getDateFromAttr = (obj: any, attr: string): Date => {\n  const dateStr = getAttr(obj, attr);\n  return dateStr ? new Date(dateStr) : new Date();\n};","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport icon from 'flarum/common/helpers/icon';\r\nimport type Mithril from 'mithril';\r\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\r\nimport PlatformIcon from '../common/PlatformIcon';\r\nimport { getAttr } from '../utils/modelHelpers';\r\nimport { ICONS } from '../utils/constants';\r\n\r\ninterface PlatformSelectorProps {\r\n  platforms: WithdrawalPlatform[];\r\n  selectedPlatform: WithdrawalPlatform | null;\r\n  onPlatformSelect: (platform: WithdrawalPlatform) => void;\r\n  onAmountChange?: () => void; // Callback when platform changes to clear amount\r\n}\r\n\r\ninterface PlatformSelectorState {\r\n  showDropdown: boolean;\r\n}\r\n\r\nexport default class PlatformSelector extends Component<PlatformSelectorProps, PlatformSelectorState> {\r\n  oninit(vnode: Mithril.Vnode<PlatformSelectorProps, PlatformSelectorState>) {\r\n    super.oninit(vnode);\r\n    this.state = {\r\n      showDropdown: false,\r\n    };\r\n  }\r\n\r\n  view(): Mithril.Children {\r\n    const { selectedPlatform } = this.attrs;\r\n    const { showDropdown } = this.state;\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-platformSelector\">\r\n        <div className=\"WithdrawalPage-label\">提取平台</div>\r\n        <div \r\n          className=\"WithdrawalPage-platformDropdown\" \r\n          onclick={() => this.toggleDropdown()}\r\n        >\r\n          <div className=\"WithdrawalPage-platformSelected\">\r\n            <div className=\"WithdrawalPage-platformInfo\">\r\n              <div className=\"WithdrawalPage-platformIcon\">\r\n                <PlatformIcon \r\n                  platform={selectedPlatform} \r\n                  size=\"medium\"\r\n                />\r\n              </div>\r\n              <div className=\"WithdrawalPage-platformDetails\">\r\n                <div className=\"WithdrawalPage-platformName\">\r\n                  {this.getPlatformName(selectedPlatform)}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {icon(ICONS.CHEVRON_DOWN, { className: 'WithdrawalPage-dropdownIcon' })}\r\n        </div>\r\n\r\n        {showDropdown && this.renderPlatformDropdown()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private toggleDropdown(): void {\r\n    this.state.showDropdown = !this.state.showDropdown;\r\n  }\r\n\r\n  private getPlatformName(platform: WithdrawalPlatform | null): string {\r\n    if (!platform) {\r\n      return '请选择平台';\r\n    }\r\n    return getAttr(platform, 'displayName') || getAttr(platform, 'name') || '请选择平台';\r\n  }\r\n\r\n  private renderPlatformDropdown(): Mithril.Children {\r\n    const { platforms } = this.attrs;\r\n\r\n    // Ensure platforms array is valid and filter out invalid items\r\n    const validPlatforms = (platforms || []).filter(platform => !!platform);\r\n\r\n    if (validPlatforms.length === 0) {\r\n      return (\r\n        <div className=\"WithdrawalPage-dropdownMenu\">\r\n          <div className=\"WithdrawalPage-dropdownItem WithdrawalPage-noData\">\r\n            {app.translator.trans('funds.forum.no_platforms')}\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-dropdownMenu\">\r\n        {validPlatforms.map(platform => (\r\n          <div \r\n            key={platform.id()}\r\n            className=\"WithdrawalPage-dropdownItem\"\r\n            onclick={() => this.selectPlatform(platform)}\r\n          >\r\n            <div className=\"WithdrawalPage-platformIcon\">\r\n              <PlatformIcon platform={platform} size=\"small\" />\r\n            </div>\r\n            <div className=\"WithdrawalPage-platformName\">\r\n              {getAttr(platform, 'displayName') || getAttr(platform, 'name')}\r\n            </div>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private selectPlatform(platform: WithdrawalPlatform): void {\r\n    const { onPlatformSelect, onAmountChange } = this.attrs;\r\n    \r\n    onPlatformSelect(platform);\r\n    this.state.showDropdown = false;\r\n    \r\n    // Clear amount when switching platforms\r\n    if (onAmountChange) {\r\n      onAmountChange();\r\n    }\r\n  }\r\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport Button from 'flarum/common/components/Button';\r\nimport icon from 'flarum/common/helpers/icon';\r\nimport type Mithril from 'mithril';\r\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\r\nimport { getAttr } from '../utils/modelHelpers';\r\nimport { DEFAULTS, ICONS } from '../utils/constants';\r\n\r\ninterface AmountInputProps {\r\n  amount: string;\r\n  selectedPlatform: WithdrawalPlatform | null;\r\n  loadingBalance: boolean;\r\n  onAmountChange: (amount: string) => void;\r\n  onFillAllAmount: () => void;\r\n}\r\n\r\nexport default class AmountInput extends Component<AmountInputProps> {\r\n  view(): Mithril.Children {\r\n    const { \r\n      amount, \r\n      selectedPlatform, \r\n      loadingBalance,\r\n      onAmountChange,\r\n      onFillAllAmount \r\n    } = this.attrs;\r\n\r\n    const minAmount = this.getMinAmount(selectedPlatform);\r\n    const maxAmount = this.getMaxAmount(selectedPlatform);\r\n    const fee = this.getFee(selectedPlatform);\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-amountSection\">\r\n        <div className=\"WithdrawalPage-formGroup\">\r\n          <div className=\"WithdrawalPage-label\">\r\n            {app.translator.trans('funds.forum.form.amount')}\r\n          </div>\r\n\r\n          <div className=\"WithdrawalPage-amountInput\">\r\n            <input\r\n              type=\"text\"\r\n              className=\"WithdrawalPage-input\"\r\n              placeholder=\"0.00000000\"\r\n              value={amount}\r\n              oninput={(e: Event) => onAmountChange((e.target as HTMLInputElement).value)}\r\n            />\r\n            <Button\r\n              className=\"WithdrawalPage-allButton\"\r\n              onclick={onFillAllAmount}\r\n              disabled={loadingBalance}\r\n            >\r\n              {app.translator.trans('funds.forum.form.all_button')}\r\n            </Button>\r\n          </div>\r\n\r\n          <div className=\"WithdrawalPage-amountLimits\">\r\n            <div className=\"WithdrawalPage-limitRow\">\r\n              <span className=\"WithdrawalPage-limitLabel\">\r\n                {app.translator.trans('funds.forum.limits.min_max')}\r\n              </span>\r\n              <span className=\"WithdrawalPage-limitValue\">\r\n                {icon(ICONS.COINS)} {minAmount} ~ {maxAmount}\r\n              </span>\r\n            </div>\r\n            <div className=\"WithdrawalPage-limitRow\">\r\n              <span className=\"WithdrawalPage-limitLabel\">\r\n                {app.translator.trans('funds.forum.limits.fee')}\r\n              </span>\r\n              <span className=\"WithdrawalPage-limitValue\">\r\n                {icon(ICONS.COINS)} {fee}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private getMinAmount(platform: WithdrawalPlatform | null): number {\r\n    if (!platform) return DEFAULTS.MIN_AMOUNT;\r\n    return getAttr(platform, 'minAmount') || DEFAULTS.MIN_AMOUNT;\r\n  }\r\n\r\n  private getMaxAmount(platform: WithdrawalPlatform | null): number {\r\n    if (!platform) return DEFAULTS.MAX_AMOUNT;\r\n    return getAttr(platform, 'maxAmount') || DEFAULTS.MAX_AMOUNT;\r\n  }\r\n\r\n  private getFee(platform: WithdrawalPlatform | null): number {\r\n    if (!platform) return DEFAULTS.FEE;\r\n    return getAttr(platform, 'fee') || DEFAULTS.FEE;\r\n  }\r\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport icon from 'flarum/common/helpers/icon';\r\nimport type Mithril from 'mithril';\r\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\r\nimport { getAttr } from '../utils/modelHelpers';\r\nimport { ICONS } from '../utils/constants';\r\nimport m from 'mithril';\r\n\r\ninterface AddressInputProps {\r\n  accountDetails: string;\r\n  selectedPlatform: WithdrawalPlatform | null;\r\n  onAccountDetailsChange: (details: string) => void;\r\n}\r\n\r\nexport default class AddressInput extends Component<AddressInputProps> {\r\n  view(): Mithril.Children {\r\n    const { \r\n      accountDetails, \r\n      selectedPlatform, \r\n      onAccountDetailsChange\r\n    } = this.attrs;\r\n\r\n    const symbol = this.getSymbol(selectedPlatform);\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-addressSection\">\r\n        <div className=\"WithdrawalPage-formGroup\">\r\n          <div className=\"WithdrawalPage-addressHeader\">\r\n            <span className=\"WithdrawalPage-label\">\r\n              {app.translator.trans('funds.forum.form.address', { symbol })}\r\n              <span className=\"WithdrawalPage-required\">*</span>\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"WithdrawalPage-addressInput\">\r\n            <input\r\n              type=\"text\"\r\n              className=\"WithdrawalPage-input\"\r\n              placeholder={app.translator.trans('funds.forum.form.address_placeholder')}\r\n              value={accountDetails}\r\n              oninput={(e: Event) => onAccountDetailsChange((e.target as HTMLInputElement).value)}\r\n            />\r\n            <button \r\n              className=\"WithdrawalPage-pasteButton\" \r\n              onclick={() => this.pasteFromClipboard()}\r\n            >\r\n              {icon(ICONS.PASTE)}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private getSymbol(platform: WithdrawalPlatform | null): string {\r\n    if (!platform) return '';\r\n    return getAttr(platform, 'symbol') || '';\r\n  }\r\n\r\n  private async pasteFromClipboard(): Promise<void> {\r\n    const { onAccountDetailsChange } = this.attrs;\r\n    \r\n    try {\r\n      if (navigator.clipboard && navigator.clipboard.readText) {\r\n        const text = await navigator.clipboard.readText();\r\n        onAccountDetailsChange(text.trim());\r\n        m.redraw();\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to read from clipboard:', error);\r\n      app.alerts.show({\r\n        type: 'error',\r\n        dismissible: true\r\n      }, app.translator.trans('funds.forum.clipboard_error'));\r\n    }\r\n  }\r\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport type Mithril from 'mithril';\r\n\r\ninterface MessageInputProps {\r\n  message: string;\r\n  onMessageChange: (message: string) => void;\r\n}\r\n\r\nexport default class MessageInput extends Component<MessageInputProps> {\r\n  view(): Mithril.Children {\r\n    const { \r\n      message,\r\n      onMessageChange\r\n    } = this.attrs;\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-messageSection\">\r\n        <div className=\"WithdrawalPage-formGroup\">\r\n          <span className=\"WithdrawalPage-label\">\r\n            {app.translator.trans('funds.forum.form.message')}\r\n          </span>\r\n          <textarea\r\n            className=\"WithdrawalPage-textarea\"\r\n            placeholder={app.translator.trans('funds.forum.form.message_placeholder')}\r\n            value={message}\r\n            rows={3}\r\n            maxlength={500}\r\n            oninput={(e: Event) => onMessageChange((e.target as HTMLTextAreaElement).value)}\r\n          />\r\n          <div className=\"WithdrawalPage-helperText\">\r\n            {app.translator.trans('funds.forum.form.message_helper')} ({message.length}/500)\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport Button from 'flarum/common/components/Button';\r\nimport type Mithril from 'mithril';\r\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\r\nimport { getAttr } from '../utils/modelHelpers';\r\nimport { DEFAULTS } from '../utils/constants';\r\n\r\ninterface SubmitButtonProps {\r\n  amount: string;\r\n  selectedPlatform: WithdrawalPlatform | null;\r\n  accountDetails: string;\r\n  submitting: boolean;\r\n  canSubmit: boolean;\r\n  onSubmit: () => void;\r\n}\r\n\r\nexport default class SubmitButton extends Component<SubmitButtonProps> {\r\n  view(): Mithril.Children {\r\n    const { \r\n      amount, \r\n      selectedPlatform, \r\n      submitting, \r\n      canSubmit, \r\n      onSubmit \r\n    } = this.attrs;\r\n\r\n    const numericAmount = parseFloat(amount) || 0;\r\n    const fee = this.getFee(selectedPlatform);\r\n    const finalAmount = Math.max(0, numericAmount - fee);\r\n    const symbol = this.getSymbol(selectedPlatform);\r\n\r\n    return (\r\n      <div className=\"WithdrawalPage-submitSection\">\r\n        <Button\r\n          className=\"WithdrawalPage-submitButton\"\r\n          loading={submitting}\r\n          disabled={!canSubmit}\r\n          onclick={onSubmit}\r\n        >\r\n          {app.translator.trans('funds.forum.form.submit')}\r\n        </Button>\r\n\r\n        {numericAmount > 0 && (\r\n          <div className=\"WithdrawalPage-finalAmount\">\r\n            {app.translator.trans('funds.forum.final_amount', { \r\n              amount: finalAmount.toFixed(DEFAULTS.BALANCE_PRECISION), \r\n              symbol \r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private getFee(platform: WithdrawalPlatform | null): number {\r\n    if (!platform) return DEFAULTS.FEE;\r\n    return getAttr(platform, 'fee') || DEFAULTS.FEE;\r\n  }\r\n\r\n  private getSymbol(platform: WithdrawalPlatform | null): string {\r\n    if (!platform) return '';\r\n    return getAttr(platform, 'symbol') || '';\r\n  }\r\n}","import Component from 'flarum/common/Component';\nimport type Mithril from 'mithril';\nimport type { WithdrawalFormData } from '../types/interfaces';\nimport WithdrawalPlatform from '../../../../common/models/WithdrawalPlatform';\nimport PlatformSelector from './PlatformSelector';\nimport AmountInput from './AmountInput';\nimport AddressInput from './AddressInput';\nimport MessageInput from './MessageInput';\nimport SubmitButton from './SubmitButton';\n\ninterface WithdrawalFormProps {\n  platforms: WithdrawalPlatform[];\n  formData: WithdrawalFormData;\n  loadingBalance: boolean;\n  submitting: boolean;\n  onFormDataChange: (data: Partial<WithdrawalFormData>) => void;\n  onFillAllAmount: () => void;\n  onSubmit: () => void;\n}\n\nexport default class WithdrawalForm extends Component<WithdrawalFormProps> {\n  view(): Mithril.Children {\n    const { \n      platforms, \n      formData, \n      loadingBalance,\n      submitting,\n      onFormDataChange,\n      onFillAllAmount,\n      onSubmit \n    } = this.attrs;\n\n    return [\n      <PlatformSelector \n        platforms={platforms}\n        selectedPlatform={formData.selectedPlatform}\n        onPlatformSelect={(platform: any) => onFormDataChange({ selectedPlatform: platform })}\n        onAmountChange={() => onFormDataChange({ amount: '' })}\n      />,\n      \n      <AmountInput \n        amount={formData.amount}\n        selectedPlatform={formData.selectedPlatform}\n        loadingBalance={loadingBalance}\n        onAmountChange={(amount: any) => onFormDataChange({ amount })}\n        onFillAllAmount={onFillAllAmount}\n      />,\n      \n      <AddressInput \n        accountDetails={formData.accountDetails}\n        selectedPlatform={formData.selectedPlatform}\n        onAccountDetailsChange={(accountDetails: any) => onFormDataChange({ accountDetails })}\n      />,\n      \n      <MessageInput \n        message={formData.message}\n        onMessageChange={(message: any) => onFormDataChange({ message })}\n      />,\n      \n      <SubmitButton \n        amount={formData.amount}\n        selectedPlatform={formData.selectedPlatform}\n        accountDetails={formData.accountDetails}\n        submitting={submitting}\n        canSubmit={this.canSubmit()}\n        onSubmit={onSubmit}\n      />\n    ];\n  }\n\n  private canSubmit(): boolean {\n    const { formData, submitting } = this.attrs;\n    const { selectedPlatform, amount, accountDetails } = formData;\n\n    return !!(\n      selectedPlatform &&\n      amount &&\n      accountDetails &&\n      !submitting &&\n      parseFloat(amount) > 0\n    );\n  }\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport type Mithril from 'mithril';\r\nimport type { StatusType } from '../types/interfaces';\r\nimport { STATUS_CLASS_MAP } from '../utils/constants';\r\n\r\ninterface StatusBadgeProps {\r\n  status: StatusType;\r\n  className?: string;\r\n}\r\n\r\nexport default class StatusBadge extends Component<StatusBadgeProps> {\r\n  view(): Mithril.Children {\r\n    const { status, className = '' } = this.attrs;\r\n    \r\n    const statusClass = this.getStatusClass(status);\r\n    const statusLabel = this.getStatusLabel(status);\r\n\r\n    return (\r\n      <div className={`WithdrawalPage-historyStatus ${statusClass} ${className}`}>\r\n        {statusLabel}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private getStatusClass(status: StatusType): string {\r\n    return STATUS_CLASS_MAP[status] || STATUS_CLASS_MAP.pending;\r\n  }\r\n\r\n  private getStatusLabel(status: StatusType): string {\r\n    return app.translator.trans(`funds.forum.status.${status}`).toString();\r\n  }\r\n}","import Component from 'flarum/common/Component';\nimport icon from 'flarum/common/helpers/icon';\nimport type Mithril from 'mithril';\n\ninterface EmptyStateProps {\n  iconName: string;\n  title: string;\n  description: string;\n  className?: string;\n}\n\nexport default class EmptyState extends Component<EmptyStateProps> {\n  view(): Mithril.Children {\n    const { iconName, title, description, className = '' } = this.attrs;\n    \n    return (\n      <div className={`WithdrawalPage-emptyState ${className}`}>\n        <div className=\"WithdrawalPage-emptyIcon\">\n          {icon(iconName)}\n        </div>\n        <h3 className=\"WithdrawalPage-emptyTitle\">\n          {title}\n        </h3>\n        <p className=\"WithdrawalPage-emptyDescription\">\n          {description}\n        </p>\n      </div>\n    );\n  }\n}","import LoadingIndicator from 'flarum/common/components/LoadingIndicator';\n\ninterface LoadingStateProps {\n  className?: string;\n}\n\nexport default function LoadingState(props: LoadingStateProps): JSX.Element {\n  const { className = '' } = props;\n  \n  return (\n    <div className={`WithdrawalPage-loading ${className}`}>\n      <LoadingIndicator />\n    </div>\n  );\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport icon from 'flarum/common/helpers/icon';\r\nimport humanTime from 'flarum/common/helpers/humanTime';\r\nimport type Mithril from 'mithril';\r\nimport WithdrawalRequest from '../../../common/models/WithdrawalRequest';\r\nimport WithdrawalPlatform from '../../../common/models/WithdrawalPlatform';\r\nimport type DepositPlatform from '../../../common/models/DepositPlatform';\r\nimport type DepositRecord from '../../../common/models/DepositRecord';\r\nimport { getAttr, findPlatformById, getDateFromAttr, getIdString } from '../withdrawal/utils/modelHelpers';\r\nimport PlatformIcon from '../withdrawal/common/PlatformIcon';\r\nimport StatusBadge from '../withdrawal/common/StatusBadge';\r\nimport EmptyState from '../withdrawal/common/EmptyState';\r\nimport LoadingState from '../withdrawal/common/LoadingState';\r\n\r\n// Generic transaction type that can represent withdrawal requests or deposit records\r\ninterface Transaction {\r\n  id?: () => string | number;\r\n  amount?: () => number;\r\n  status?: () => string;\r\n  createdAt?: () => Date;\r\n  platform?: () => any;\r\n  platformId?: () => string | number;\r\n  // Withdrawal request specific fields\r\n  accountDetails?: () => string;\r\n  // Deposit record specific fields\r\n  platformAccount?: () => string;\r\n  realName?: () => string;\r\n  depositTime?: () => Date;\r\n  screenshotUrl?: () => string;\r\n  userMessage?: () => string;\r\n  processedAt?: () => Date;\r\n  adminNotes?: () => string;\r\n  creditedAmount?: () => number;\r\n  [key: string]: any;\r\n}\r\n\r\ninterface TransactionHistoryAttrs {\r\n  transactions: (WithdrawalRequest | DepositRecord)[];\r\n  platforms: (WithdrawalPlatform | DepositPlatform)[];\r\n  loading: boolean;\r\n  type: 'funds' | 'deposit';\r\n}\r\n\r\nexport default class TransactionHistory extends Component<TransactionHistoryAttrs> {\r\n  view(vnode: Mithril.Vnode<TransactionHistoryAttrs>): Mithril.Children {\r\n    const { transactions, platforms, loading, type } = vnode.attrs;\r\n\r\n    if (loading) {\r\n      return <LoadingState className={`${type}History-loading`} />;\r\n    }\r\n\r\n    if (!transactions || transactions.length === 0) {\r\n      return (\r\n        <EmptyState\r\n          iconName={type === 'funds' ? 'fas fa-history' : 'fas fa-inbox'}\r\n          title={app.translator.trans('funds.forum.history.empty.title')}\r\n          description={app.translator.trans('funds.forum.history.empty.description')}\r\n          className={`${type}History-empty`}\r\n        />\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className={`${type}History`}>\r\n        <div className={`${type}History-header`}>\r\n          <h3>{app.translator.trans('funds.forum.history.title')}</h3>\r\n          <span className={`${type}History-count`}>{transactions.length} {app.translator.trans('funds.forum.history.transactions')}</span>\r\n        </div>\r\n        \r\n        <div className={`${type}History-list`}>\r\n          {transactions.map(transaction => this.renderTransaction(transaction as Transaction, platforms, type))}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderTransaction(transaction: Transaction, platforms: any[], type: string): Mithril.Children {\r\n    const transactionId = this.getTransactionId(transaction);\r\n    const platform = this.getPlatform(transaction, platforms);\r\n    const amount = getAttr(transaction, 'amount') || 0;\r\n    const status = getAttr(transaction, 'status') || 'pending';\r\n    const statusColor = getAttr(transaction, 'statusColor') || this.getStatusColor(status);\r\n    const createdAt = getDateFromAttr(transaction, 'createdAt');\r\n\r\n    if (type === 'deposit') {\r\n      // Only deposit records now\r\n      return this.renderDepositRecord(transaction, platform, amount, status, statusColor, createdAt, transactionId);\r\n    } else {\r\n      return this.renderWithdrawalTransaction(transaction, platform, amount, status, createdAt, transactionId);\r\n    }\r\n  }\r\n\r\n  private renderWithdrawalTransaction(\r\n    transaction: Transaction, \r\n    platform: any, \r\n    amount: number, \r\n    status: string, \r\n    createdAt: Date, \r\n    transactionId: string\r\n  ): Mithril.Children {\r\n    const accountDetails = getAttr(transaction, 'accountDetails') || '';\r\n\r\n    return (\r\n      <div key={transactionId} className=\"WithdrawalPage-historyItem\">\r\n        <div className=\"WithdrawalPage-historyHeader\">\r\n          <div className=\"WithdrawalPage-historyPlatform\">\r\n            <div className=\"WithdrawalPage-platformIcon\">\r\n              <PlatformIcon platform={platform} size=\"small\" />\r\n            </div>\r\n            <div className=\"WithdrawalPage-historyInfo\">\r\n              <div className=\"WithdrawalPage-historyPlatformName\">\r\n                {this.getPlatformName(platform)}\r\n              </div>\r\n              <div className=\"WithdrawalPage-historyDate\">\r\n                {createdAt.toLocaleDateString()} {createdAt.toLocaleTimeString()}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <StatusBadge status={status as any} />\r\n        </div>\r\n        <div className=\"WithdrawalPage-historyDetails\">\r\n          <div className=\"WithdrawalPage-historyAmount\">\r\n            <span className=\"WithdrawalPage-historyLabel\">\r\n              {app.translator.trans('funds.forum.history.amount')}:\r\n            </span>\r\n            <span className=\"WithdrawalPage-historyValue\">\r\n              {amount} {this.getPlatformSymbol(platform)}\r\n            </span>\r\n          </div>\r\n          <div className=\"WithdrawalPage-historyAddress\">\r\n            <span className=\"WithdrawalPage-historyLabel\">\r\n              {app.translator.trans('funds.forum.history.address')}:\r\n            </span>\r\n            <span className=\"WithdrawalPage-historyValue\">\r\n              {accountDetails}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderDepositRecord(\r\n    transaction: Transaction,\r\n    platform: any,\r\n    amount: number,\r\n    status: string,\r\n    statusColor: string,\r\n    createdAt: Date,\r\n    transactionId: string\r\n  ): Mithril.Children {\r\n    const platformAccount = getAttr(transaction, 'platformAccount');\r\n    const realName = getAttr(transaction, 'realName');\r\n    const depositTime = getDateFromAttr(transaction, 'depositTime');\r\n    const screenshotUrl = getAttr(transaction, 'screenshotUrl');\r\n    const userMessage = getAttr(transaction, 'userMessage');\r\n    const processedAt = getDateFromAttr(transaction, 'processedAt');\r\n    const adminNotes = getAttr(transaction, 'adminNotes');\r\n    const creditedAmount = getAttr(transaction, 'creditedAmount');\r\n\r\n    return (\r\n      <div key={transactionId} className=\"DepositRecord-item\">\r\n        <div className=\"DepositRecord-itemHeader\">\r\n          <div className=\"DepositRecord-itemPlatform\">\r\n            {platform && (\r\n              <>\r\n                <div className=\"DepositRecord-itemIcon\">\r\n                  {this.renderPlatformIcon(platform)}\r\n                </div>\r\n                <div className=\"DepositRecord-itemInfo\">\r\n                  <span className=\"DepositRecord-itemCurrency\">\r\n                    {getAttr(platform, 'symbol')} {getAttr(platform, 'network') && `(${getAttr(platform, 'network')})`}\r\n                  </span>\r\n                  <span className=\"DepositRecord-itemType\">\r\n                    Manual Deposit\r\n                  </span>\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n          \r\n          <div className=\"DepositRecord-itemAmount\">\r\n            <span className=\"DepositRecord-itemAmountValue\">\r\n              +{amount} {platform ? getAttr(platform, 'symbol') : ''}\r\n            </span>\r\n            <div className={`DepositRecord-itemStatus status-${statusColor}`}>\r\n              {this.getStatusIcon(status)}\r\n              {this.getStatusText(status)}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"DepositRecord-itemDetails\">\r\n          <div className=\"DepositRecord-itemMeta\">\r\n            <span className=\"DepositRecord-itemTime\">\r\n              Submitted: {createdAt ? humanTime(createdAt) : 'Unknown time'}\r\n            </span>\r\n            \r\n            {depositTime && (\r\n              <span className=\"DepositRecord-itemDepositTime\">\r\n                Deposit Time: {depositTime.toLocaleDateString()} {depositTime.toLocaleTimeString()}\r\n              </span>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"DepositRecord-itemInfo\">\r\n            <div className=\"DepositRecord-itemRow\">\r\n              <span className=\"DepositRecord-itemLabel\">Platform Account:</span>\r\n              <span className=\"DepositRecord-itemValue\">{platformAccount}</span>\r\n            </div>\r\n            \r\n            {realName && (\r\n              <div className=\"DepositRecord-itemRow\">\r\n                <span className=\"DepositRecord-itemLabel\">Real Name:</span>\r\n                <span className=\"DepositRecord-itemValue\">{realName}</span>\r\n              </div>\r\n            )}\r\n            \r\n            {userMessage && (\r\n              <div className=\"DepositRecord-itemRow\">\r\n                <span className=\"DepositRecord-itemLabel\">Message:</span>\r\n                <span className=\"DepositRecord-itemValue\">{userMessage}</span>\r\n              </div>\r\n            )}\r\n            \r\n            {screenshotUrl && (\r\n              <div className=\"DepositRecord-itemRow\">\r\n                <span className=\"DepositRecord-itemLabel\">Screenshot:</span>\r\n                <a href={screenshotUrl} target=\"_blank\" rel=\"noopener noreferrer\" className=\"DepositRecord-itemLink\">\r\n                  View Screenshot {icon('fas fa-external-link-alt')}\r\n                </a>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {processedAt && (\r\n            <div className=\"DepositRecord-itemProcessed\">\r\n              <div className=\"DepositRecord-itemProcessedTime\">\r\n                Processed: {humanTime(processedAt)}\r\n              </div>\r\n              \r\n              {creditedAmount && creditedAmount !== amount && (\r\n                <div className=\"DepositRecord-itemCredited\">\r\n                  Credited Amount: {creditedAmount} {platform ? getAttr(platform, 'symbol') : ''}\r\n                </div>\r\n              )}\r\n              \r\n              {adminNotes && (\r\n                <div className=\"DepositRecord-itemNotes\">\r\n                  <span className=\"DepositRecord-itemLabel\">Admin Notes:</span>\r\n                  <span className=\"DepositRecord-itemValue\">{adminNotes}</span>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n\r\n  private getTransactionId(transaction: Transaction): string {\r\n    if (typeof transaction.id === 'function') {\r\n      return `transaction-${transaction.id()}`;\r\n    }\r\n    return `transaction-${getIdString(transaction) || Math.random()}`;\r\n  }\r\n\r\n  private getPlatform(transaction: Transaction, platforms: any[]): any {\r\n    const platformId = this.getPlatformId(transaction);\r\n    return findPlatformById(platforms, platformId);\r\n  }\r\n\r\n  private getPlatformId(transaction: Transaction): string | number {\r\n    return getAttr(transaction, 'platformId') || \r\n           (transaction.relationships?.platform?.data?.id) || '';\r\n  }\r\n\r\n  private getPlatformName(platform: any): string {\r\n    if (!platform) return 'Unknown Platform';\r\n    return getAttr(platform, 'name') || 'Unknown Platform';\r\n  }\r\n\r\n  private getPlatformSymbol(platform: any): string {\r\n    if (!platform) return '';\r\n    return getAttr(platform, 'symbol') || '';\r\n  }\r\n\r\n  private getStatusColor(status: string): string {\r\n    switch (status) {\r\n      case 'pending':\r\n        return 'warning';\r\n      case 'approved':\r\n      case 'confirmed':\r\n      case 'completed':\r\n        return 'success';\r\n      case 'rejected':\r\n      case 'failed':\r\n      case 'cancelled':\r\n        return 'danger';\r\n      default:\r\n        return 'secondary';\r\n    }\r\n  }\r\n\r\n  private renderPlatformIcon(platform: any): Mithril.Children {\r\n    const iconUrl = getAttr(platform, 'iconUrl');\r\n    const iconClass = getAttr(platform, 'iconClass');\r\n    const symbol = getAttr(platform, 'symbol');\r\n\r\n    if (iconUrl) {\r\n      return <img src={iconUrl} alt={symbol} className=\"DepositHistory-platformImg\" />;\r\n    }\r\n\r\n    if (iconClass) {\r\n      return icon(iconClass);\r\n    }\r\n\r\n    // Fallback to generic icon - use platform-configurable icons only\r\n    return icon('fas fa-coins');\r\n  }\r\n\r\n  private getStatusIcon(status: string): Mithril.Children {\r\n    switch (status) {\r\n      case 'pending':\r\n        return icon('fas fa-clock');\r\n      case 'approved':\r\n      case 'confirmed':\r\n        return icon('fas fa-check-circle');\r\n      case 'completed':\r\n        return icon('fas fa-check-double');\r\n      case 'rejected':\r\n      case 'failed':\r\n        return icon('fas fa-times-circle');\r\n      case 'cancelled':\r\n        return icon('fas fa-ban');\r\n      default:\r\n        return icon('fas fa-question-circle');\r\n    }\r\n  }\r\n\r\n  private getStatusText(status: string): string {\r\n    switch (status) {\r\n      case 'pending':\r\n        return 'Pending';\r\n      case 'approved':\r\n        return 'Approved';\r\n      case 'confirmed':\r\n        return 'Confirmed';\r\n      case 'completed':\r\n        return 'Completed';\r\n      case 'rejected':\r\n        return 'Rejected';\r\n      case 'failed':\r\n        return 'Failed';\r\n      case 'cancelled':\r\n        return 'Cancelled';\r\n      default:\r\n        return 'Unknown';\r\n    }\r\n  }\r\n\r\n}","import app from 'flarum/forum/app';\r\nimport Component from 'flarum/common/Component';\r\nimport Button from 'flarum/common/components/Button';\r\nimport Stream from 'flarum/common/utils/Stream';\r\nimport withAttr from 'flarum/common/utils/withAttr';\r\nimport type Mithril from 'mithril';\r\n\r\nexport interface DepositFormData {\r\n  depositAddress: string;\r\n  qrCodeUrl?: string;\r\n  userMessage?: string;\r\n}\r\n\r\ninterface DepositFormProps {\r\n  onSubmit: (data: DepositFormData) => Promise<void>;\r\n  onCancel: () => void;\r\n  submitting: boolean;\r\n}\r\n\r\ninterface DepositFormState {\r\n  depositAddress: Stream<string>;\r\n  qrCodeUrl: Stream<string>;\r\n  userMessage: Stream<string>;\r\n}\r\n\r\nexport default class DepositForm extends Component<DepositFormProps, DepositFormState> {\r\n  oninit(vnode: Mithril.Vnode<DepositFormProps>) {\r\n    super.oninit(vnode);\r\n    \r\n    this.state = {\r\n      depositAddress: Stream(''),\r\n      qrCodeUrl: Stream(''),\r\n      userMessage: Stream('')\r\n    };\r\n  }\r\n\r\n  view(vnode: Mithril.Vnode<DepositFormProps>): Mithril.Children {\r\n    const { submitting } = vnode.attrs;\r\n\r\n    return (\r\n      <div className=\"DepositForm\">\r\n        <div className=\"DepositForm-header\">\r\n          <div className=\"DepositForm-title\">\r\n            <i className=\"fas fa-plus-circle\"></i>\r\n            {app.translator.trans('funds.forum.deposit.form.form_title')}\r\n          </div>\r\n          <div className=\"DepositForm-description\">\r\n            {app.translator.trans('funds.forum.deposit.form.form_description')}\r\n          </div>\r\n        </div>\r\n\r\n        <form onsubmit={this.handleSubmit.bind(this)} className=\"DepositForm-form\">\r\n          {/* 存款地址字段 */}\r\n          <div className=\"DepositForm-field\">\r\n            <label className=\"DepositForm-label\">\r\n              {app.translator.trans('funds.forum.deposit.form.deposit_address')}\r\n              <span className=\"DepositForm-required\">*</span>\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"DepositForm-input\"\r\n              placeholder={app.translator.trans('funds.forum.deposit.form.deposit_address_placeholder')}\r\n              value={this.state.depositAddress()}\r\n              oninput={withAttr('value', this.state.depositAddress)}\r\n              required\r\n              disabled={submitting}\r\n            />\r\n            <div className=\"DepositForm-help\">\r\n              {app.translator.trans('funds.forum.deposit.form.deposit_address_help')}\r\n            </div>\r\n          </div>\r\n\r\n          {/* 收款二维码字段 */}\r\n          <div className=\"DepositForm-field\">\r\n            <label className=\"DepositForm-label\">\r\n              {app.translator.trans('funds.forum.deposit.form.qr_code_url')}\r\n              <span className=\"DepositForm-optional\">\r\n                ({app.translator.trans('funds.forum.deposit.form.optional')})\r\n              </span>\r\n            </label>\r\n            <input\r\n              type=\"url\"\r\n              className=\"DepositForm-input\"\r\n              placeholder={app.translator.trans('funds.forum.deposit.form.qr_code_url_placeholder')}\r\n              value={this.state.qrCodeUrl()}\r\n              oninput={withAttr('value', this.state.qrCodeUrl)}\r\n              disabled={submitting}\r\n            />\r\n            <div className=\"DepositForm-help\">\r\n              {app.translator.trans('funds.forum.deposit.form.qr_code_url_help')}\r\n            </div>\r\n          </div>\r\n\r\n          {/* 留言字段 */}\r\n          <div className=\"DepositForm-field\">\r\n            <label className=\"DepositForm-label\">\r\n              {app.translator.trans('funds.forum.deposit.form.user_message')}\r\n              <span className=\"DepositForm-optional\">\r\n                ({app.translator.trans('funds.forum.deposit.form.optional')})\r\n              </span>\r\n            </label>\r\n            <textarea\r\n              className=\"DepositForm-textarea\"\r\n              placeholder={app.translator.trans('funds.forum.deposit.form.user_message_placeholder')}\r\n              value={this.state.userMessage()}\r\n              oninput={withAttr('value', this.state.userMessage)}\r\n              rows={4}\r\n              disabled={submitting}\r\n            ></textarea>\r\n            <div className=\"DepositForm-help\">\r\n              {app.translator.trans('funds.forum.deposit.form.user_message_help')}\r\n            </div>\r\n          </div>\r\n\r\n          {/* 表单操作按钮 */}\r\n          <div className=\"DepositForm-actions\">\r\n            <Button\r\n              type=\"button\"\r\n              className=\"Button Button--secondary DepositForm-cancelButton\"\r\n              onclick={vnode.attrs.onCancel}\r\n              disabled={submitting}\r\n            >\r\n              {app.translator.trans('funds.forum.deposit.form.cancel')}\r\n            </Button>\r\n            \r\n            <Button\r\n              type=\"submit\"\r\n              className=\"Button Button--primary DepositForm-submitButton\"\r\n              loading={submitting}\r\n              disabled={submitting}\r\n            >\r\n              {app.translator.trans('funds.forum.deposit.form.submit')}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private handleSubmit(e: Event): void {\r\n    e.preventDefault();\r\n\r\n    const { onSubmit } = this.attrs;\r\n    \r\n    // 基本验证\r\n    if (!this.state.depositAddress()) {\r\n      app.alerts.show(\r\n        { type: 'error', dismissible: true },\r\n        app.translator.trans('funds.forum.deposit.form.validation.address_required')\r\n      );\r\n      return;\r\n    }\r\n\r\n    // 验证二维码URL格式（如果提供的话）\r\n    const qrCodeUrl = this.state.qrCodeUrl();\r\n    if (qrCodeUrl && !this.isValidUrl(qrCodeUrl)) {\r\n      app.alerts.show(\r\n        { type: 'error', dismissible: true },\r\n        app.translator.trans('funds.forum.deposit.form.validation.invalid_url')\r\n      );\r\n      return;\r\n    }\r\n\r\n    // 准备表单数据\r\n    const formData: DepositFormData = {\r\n      depositAddress: this.state.depositAddress(),\r\n      qrCodeUrl: qrCodeUrl || undefined,\r\n      userMessage: this.state.userMessage() || undefined\r\n    };\r\n\r\n    onSubmit(formData);\r\n  }\r\n\r\n  private isValidUrl(url: string): boolean {\r\n    try {\r\n      // eslint-disable-next-line no-new\r\n      new URL(url);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // 清空表单\r\n  resetForm(): void {\r\n    this.state.depositAddress('');\r\n    this.state.qrCodeUrl('');\r\n    this.state.userMessage('');\r\n  }\r\n}","import app from 'flarum/common/app';\r\nimport DepositRecord from '../models/DepositRecord';\r\nimport { DepositFormData } from '../../forum/components/deposit/forms/DepositForm';\r\n\r\nexport interface DepositService {\r\n  /**\r\n   * 创建新的存款记录\r\n   */\r\n  create(data: DepositFormData): Promise<DepositRecord>;\r\n\r\n  /**\r\n   * 获取用户的存款历史记录\r\n   */\r\n  getUserHistory(): Promise<DepositRecord[]>;\r\n\r\n  /**\r\n   * 获取所有存款记录（管理员）\r\n   */\r\n  getAll(filters?: DepositFilters): Promise<DepositRecord[]>;\r\n\r\n  /**\r\n   * 更新存款记录\r\n   */\r\n  update(recordId: number, data: Partial<DepositUpdateData>): Promise<DepositRecord>;\r\n\r\n  /**\r\n   * 审核存款记录（管理员）\r\n   */\r\n  approve(recordId: number, adminNotes?: string): Promise<DepositRecord>;\r\n\r\n  /**\r\n   * 拒绝存款记录（管理员）\r\n   */\r\n  reject(recordId: number, adminNotes?: string): Promise<DepositRecord>;\r\n}\r\n\r\nexport interface DepositFilters {\r\n  status?: string;\r\n  user?: number;\r\n  search?: string;\r\n  createdAfter?: string;\r\n  createdBefore?: string;\r\n}\r\n\r\nexport interface DepositUpdateData {\r\n  depositAddress?: string;\r\n  qrCodeUrl?: string;\r\n  userMessage?: string;\r\n  status?: string;\r\n  adminNotes?: string;\r\n}\r\n\r\nclass DepositServiceImpl implements DepositService {\r\n  async create(data: DepositFormData): Promise<DepositRecord> {\r\n    const response = await app.request({\r\n      method: 'POST',\r\n      url: app.forum.attribute('apiUrl') + '/deposit-records-simple',\r\n      body: {\r\n        data: {\r\n          type: 'deposit-records-simple',\r\n          attributes: {\r\n            depositAddress: data.depositAddress,\r\n            qrCodeUrl: data.qrCodeUrl,\r\n            userMessage: data.userMessage\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const record = app.store.pushPayload<DepositRecord>(response);\r\n    return Array.isArray(record) ? record[0] : record;\r\n  }\r\n\r\n  async getUserHistory(): Promise<DepositRecord[]> {\r\n    const response = await app.request({\r\n      method: 'GET',\r\n      url: app.forum.attribute('apiUrl') + '/deposit-records-simple',\r\n      params: {\r\n        include: 'user,processedByUser'\r\n      }\r\n    });\r\n\r\n    return app.store.pushPayload<DepositRecord[]>(response);\r\n  }\r\n\r\n  async getAll(filters: DepositFilters = {}): Promise<DepositRecord[]> {\r\n    const params: any = {\r\n      include: 'user,processedByUser'\r\n    };\r\n\r\n    // 应用过滤器\r\n    if (Object.keys(filters).length > 0) {\r\n      params.filter = filters;\r\n    }\r\n\r\n    const response = await app.request({\r\n      method: 'GET',\r\n      url: app.forum.attribute('apiUrl') + '/deposit-records-simple',\r\n      params\r\n    });\r\n\r\n    return app.store.pushPayload<DepositRecord[]>(response);\r\n  }\r\n\r\n  async update(recordId: number, data: Partial<DepositUpdateData>): Promise<DepositRecord> {\r\n    const response = await app.request({\r\n      method: 'PATCH',\r\n      url: `${app.forum.attribute('apiUrl')}/deposit-records-simple/${recordId}`,\r\n      body: {\r\n        data: {\r\n          type: 'deposit-records-simple',\r\n          id: recordId,\r\n          attributes: data\r\n        }\r\n      }\r\n    });\r\n\r\n    const record = app.store.pushPayload<DepositRecord>(response);\r\n    return Array.isArray(record) ? record[0] : record;\r\n  }\r\n\r\n  async approve(recordId: number, adminNotes?: string): Promise<DepositRecord> {\r\n    return this.update(recordId, {\r\n      status: 'approved',\r\n      adminNotes\r\n    });\r\n  }\r\n\r\n  async reject(recordId: number, adminNotes?: string): Promise<DepositRecord> {\r\n    return this.update(recordId, {\r\n      status: 'rejected',\r\n      adminNotes\r\n    });\r\n  }\r\n}\r\n\r\n// 导出单例服务实例\r\nexport const depositService: DepositService = new DepositServiceImpl();\r\nexport default depositService;","import Model from 'flarum/common/Model';\r\n\r\n/**\r\n * Standard pagination parameters for Flarum API requests\r\n */\r\nexport interface PaginationOptions {\r\n  limit?: number;\r\n  offset?: number;\r\n  page?: {\r\n    limit?: number;\r\n    offset?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Standard filter options for API requests\r\n */\r\nexport interface FilterOptions {\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Standard sort options for API requests\r\n */\r\nexport interface SortOptions {\r\n  field: string;\r\n  direction: 'asc' | 'desc';\r\n}\r\n\r\n/**\r\n * Standard query options for finding records\r\n */\r\nexport interface QueryOptions {\r\n  include?: string | string[];\r\n  filter?: FilterOptions;\r\n  sort?: string | SortOptions | SortOptions[];\r\n  page?: PaginationOptions;\r\n}\r\n\r\n/**\r\n * Service response wrapper for better error handling\r\n */\r\nexport interface ServiceResponse<T> {\r\n  data: T;\r\n  meta?: {\r\n    total?: number;\r\n    count?: number;\r\n    hasMore?: boolean;\r\n  };\r\n  errors?: Array<{\r\n    detail: string;\r\n    source?: any;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Base service interface that all services should implement\r\n */\r\nexport interface BaseService<TModel extends Model> {\r\n  /**\r\n   * Find multiple records\r\n   */\r\n  find(options?: QueryOptions): Promise<TModel[]>;\r\n\r\n  /**\r\n   * Find a single record by ID\r\n   */\r\n  findById(id: string | number, options?: QueryOptions): Promise<TModel | null>;\r\n\r\n  /**\r\n   * Create a new record\r\n   */\r\n  create(attributes: Record<string, any>): Promise<TModel>;\r\n\r\n  /**\r\n   * Update an existing record\r\n   */\r\n  update(model: TModel, attributes: Record<string, any>): Promise<TModel>;\r\n\r\n  /**\r\n   * Delete a record\r\n   */\r\n  delete(model: TModel): Promise<void>;\r\n\r\n  /**\r\n   * Check if a record can be modified by current user\r\n   */\r\n  canModify(model: TModel): boolean;\r\n\r\n  /**\r\n   * Check if current user can create new records\r\n   */\r\n  canCreate(): boolean;\r\n\r\n  /**\r\n   * Check if current user can delete a record\r\n   */\r\n  canDelete(model: TModel): boolean;\r\n}\r\n\r\n/**\r\n * Withdrawal-specific service interface\r\n */\r\nexport interface WithdrawalServiceInterface extends BaseService<any> {\r\n  /**\r\n   * Submit a funds request\r\n   */\r\n  submitRequest(data: {\r\n    platformId: number;\r\n    amount: number;\r\n    accountDetails: string;\r\n    message?: string;\r\n  }): Promise<any>;\r\n\r\n  /**\r\n   * Get user's funds history\r\n   */\r\n  getUserHistory(userId?: number, options?: QueryOptions): Promise<any[]>;\r\n\r\n  /**\r\n   * Get pending requests (admin only)\r\n   */\r\n  getPendingRequests(options?: QueryOptions): Promise<any[]>;\r\n\r\n  /**\r\n   * Approve a funds request (admin only)\r\n   */\r\n  approve(request: any, message?: string): Promise<any>;\r\n\r\n  /**\r\n   * Reject a funds request (admin only)\r\n   */\r\n  reject(request: any, reason?: string): Promise<any>;\r\n\r\n  /**\r\n   * Cancel a pending request (user only)\r\n   */\r\n  cancel(request: any): Promise<any>;\r\n}\r\n\r\n/**\r\n * Deposit-specific service interface\r\n */\r\nexport interface DepositServiceInterface extends BaseService<any> {\r\n  /**\r\n   * Generate deposit address for user\r\n   */\r\n  generateAddress(platformId: number): Promise<string>;\r\n\r\n  /**\r\n   * Get user's deposit history\r\n   */\r\n  getUserHistory(userId?: number, options?: QueryOptions): Promise<any[]>;\r\n\r\n  /**\r\n   * Create deposit record\r\n   */\r\n  createRecord(data: {\r\n    platformId: number;\r\n    amount: number;\r\n    note?: string;\r\n  }): Promise<any>;\r\n\r\n  /**\r\n   * Get pending deposits (admin only)\r\n   */\r\n  getPendingDeposits(options?: QueryOptions): Promise<any[]>;\r\n\r\n  /**\r\n   * Confirm a deposit (admin only)\r\n   */\r\n  confirm(deposit: any, confirmedAmount?: number): Promise<any>;\r\n}\r\n\r\n/**\r\n * Platform service interface for both funds and deposit platforms\r\n */\r\nexport interface PlatformServiceInterface extends BaseService<any> {\r\n  /**\r\n   * Get active platforms only\r\n   */\r\n  getActive(type: 'funds' | 'deposit', options?: QueryOptions): Promise<any[]>;\r\n\r\n  /**\r\n   * Toggle platform status (admin only)\r\n   */\r\n  toggleStatus(platform: any): Promise<any>;\r\n\r\n  /**\r\n   * Update platform configuration (admin only)\r\n   */\r\n  updateConfig(platform: any, config: Record<string, any>): Promise<any>;\r\n\r\n  /**\r\n   * Get platforms by symbol\r\n   */\r\n  getBySymbol(symbol: string, type: 'funds' | 'deposit'): Promise<any[]>;\r\n}\r\n\r\n/**\r\n * Settings service interface for managing Flarum admin settings\r\n */\r\nexport interface SettingsServiceInterface {\r\n  getSetting(key: string, defaultValue?: any): Promise<any>;\r\n  saveSetting(key: string, value: any): Promise<void>;\r\n  saveSettings(settings: Record<string, any>): Promise<void>;\r\n  deleteSetting(key: string): Promise<void>;\r\n  getSettingsWithPrefix(prefix: string): Promise<Record<string, any>>;\r\n  canManageSettings(): boolean;\r\n  getExtensionSetting(extension: string, key: string, defaultValue?: any): Promise<any>;\r\n  saveExtensionSetting(extension: string, key: string, value: any): Promise<void>;\r\n  getWithdrawalSetting(key: string, defaultValue?: any): Promise<any>;\r\n  saveWithdrawalSetting(key: string, value: any): Promise<void>;\r\n  getAllWithdrawalSettings(): Promise<Record<string, any>>;\r\n}\r\n\r\n/**\r\n * Address service interface for managing deposit addresses\r\n */\r\nexport interface AddressServiceInterface {\r\n  generateAddress(platformId: number, userId?: number): Promise<string>;\r\n  canGenerateAddress(): boolean;\r\n}\r\n\r\n/**\r\n * Cache service for managing local data storage\r\n */\r\nexport interface CacheOptions {\r\n  ttl?: number; // Time to live in milliseconds\r\n  key?: string; // Custom cache key\r\n  refresh?: boolean; // Force refresh from server\r\n}\r\n\r\n/**\r\n * Common service configuration\r\n */\r\nexport interface ServiceConfig {\r\n  apiUrl?: string;\r\n  timeout?: number;\r\n  retries?: number;\r\n  cache?: boolean;\r\n  defaultPageSize?: number;\r\n}\r\n\r\n/**\r\n * Service error types\r\n */\r\nexport enum ServiceErrorType {\r\n  NETWORK_ERROR = 'network_error',\r\n  PERMISSION_DENIED = 'permission_denied',\r\n  VALIDATION_ERROR = 'validation_error',\r\n  NOT_FOUND = 'not_found',\r\n  SERVER_ERROR = 'server_error',\r\n  TIMEOUT = 'timeout'\r\n}\r\n\r\n/**\r\n * Service error class\r\n */\r\nexport class ServiceError extends Error {\r\n  public type: ServiceErrorType;\r\n  public code?: string;\r\n  public details?: any;\r\n\r\n  constructor(\r\n    message: string, \r\n    type: ServiceErrorType = ServiceErrorType.SERVER_ERROR, \r\n    code?: string, \r\n    details?: any\r\n  ) {\r\n    super(message);\r\n    this.name = 'ServiceError';\r\n    this.type = type;\r\n    this.code = code;\r\n    this.details = details;\r\n  }\r\n}","import app from 'flarum/common/app';\r\nimport WithdrawalRequest from '../models/WithdrawalRequest';\r\nimport WithdrawalPlatform from '../models/WithdrawalPlatform';\r\nimport { \r\n  WithdrawalServiceInterface, \r\n  QueryOptions, \r\n  ServiceError, \r\n  ServiceErrorType\r\n} from '../types/services';\r\n\r\n/**\r\n * Service for managing funds requests with proper CRUD operations\r\n */\r\nexport default class WithdrawalService implements WithdrawalServiceInterface {\r\n  private readonly modelType = 'funds-requests';\r\n  private readonly platformModelType = 'funds-platforms';\r\n\r\n  /**\r\n   * Find multiple funds requests\r\n   */\r\n  async find(options: QueryOptions = {}): Promise<WithdrawalRequest[]> {\r\n    try {\r\n      const queryParams: any = {\r\n        include: options.include || 'user,platform',\r\n        sort: options.sort || '-created_at',\r\n        ...options\r\n      };\r\n\r\n      // Add pagination if specified\r\n      if (options.page) {\r\n        queryParams.page = options.page;\r\n      }\r\n\r\n      // Add filters if specified\r\n      if (options.filter) {\r\n        queryParams.filter = options.filter;\r\n      }\r\n\r\n      const results = await app.store.find(this.modelType, queryParams);\r\n      return Array.isArray(results) ? results : [results];\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to fetch funds requests');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find a single funds request by ID\r\n   */\r\n  async findById(id: string | number, options: QueryOptions = {}): Promise<WithdrawalRequest | null> {\r\n    try {\r\n      const queryParams: any = {\r\n        include: options.include || 'user,platform'\r\n      };\r\n\r\n      const result = await app.store.find(this.modelType, id, queryParams);\r\n      return result as WithdrawalRequest;\r\n    } catch (error) {\r\n      if (this.isNotFoundError(error)) {\r\n        return null;\r\n      }\r\n      throw this.handleError(error, `Failed to fetch funds request ${id}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a new funds request\r\n   */\r\n  async create(attributes: Record<string, any>): Promise<WithdrawalRequest> {\r\n    try {\r\n      // Validate required fields\r\n      this.validateCreateAttributes(attributes);\r\n\r\n      const request = app.store.createRecord(this.modelType) as WithdrawalRequest;\r\n      \r\n      const savedRequest = await request.save(attributes);\r\n      return savedRequest as WithdrawalRequest;\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to create funds request');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update an existing funds request\r\n   */\r\n  async update(model: WithdrawalRequest, attributes: Record<string, any>): Promise<WithdrawalRequest> {\r\n    try {\r\n      if (!this.canModify(model)) {\r\n        throw new ServiceError(\r\n          'You do not have permission to modify this funds request',\r\n          ServiceErrorType.PERMISSION_DENIED\r\n        );\r\n      }\r\n\r\n      const updatedModel = await model.save(attributes);\r\n      return updatedModel as WithdrawalRequest;\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to update funds request');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a funds request\r\n   */\r\n  async delete(model: WithdrawalRequest): Promise<void> {\r\n    try {\r\n      if (!this.canDelete(model)) {\r\n        throw new ServiceError(\r\n          'You do not have permission to delete this funds request',\r\n          ServiceErrorType.PERMISSION_DENIED\r\n        );\r\n      }\r\n\r\n      await model.delete();\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to delete funds request');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Submit a new funds request with validation\r\n   */\r\n  async submitRequest(data: {\r\n    platformId: number;\r\n    amount: number;\r\n    accountDetails: string;\r\n    message?: string;\r\n  }): Promise<WithdrawalRequest> {\r\n    try {\r\n      // Validate user balance and platform limits\r\n      await this.validateWithdrawalRequest(data);\r\n\r\n      const attributes = {\r\n        platformId: data.platformId,\r\n        amount: data.amount,\r\n        accountDetails: data.accountDetails,\r\n        message: data.message || '',\r\n        status: 'pending'\r\n      };\r\n\r\n      return await this.create(attributes);\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to submit funds request');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user's funds history\r\n   */\r\n  async getUserHistory(userId?: number, options: QueryOptions = {}): Promise<WithdrawalRequest[]> {\r\n    const targetUserId = userId || app.session.user?.id();\r\n    \r\n    if (!targetUserId) {\r\n      throw new ServiceError(\r\n        'User not authenticated',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    const queryOptions = {\r\n      ...options,\r\n      filter: {\r\n        user: targetUserId,\r\n        ...options.filter\r\n      },\r\n      include: options.include || 'platform',\r\n      sort: options.sort || '-created_at'\r\n    };\r\n\r\n    return await this.find(queryOptions);\r\n  }\r\n\r\n  /**\r\n   * Get pending requests (admin only)\r\n   */\r\n  async getPendingRequests(options: QueryOptions = {}): Promise<WithdrawalRequest[]> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    const queryOptions = {\r\n      ...options,\r\n      filter: {\r\n        status: 'pending',\r\n        ...options.filter\r\n      },\r\n      include: options.include || 'user,platform',\r\n      sort: options.sort || 'created_at'\r\n    };\r\n\r\n    return await this.find(queryOptions);\r\n  }\r\n\r\n  /**\r\n   * Approve a funds request (admin only)\r\n   */\r\n  async approve(request: WithdrawalRequest, message?: string): Promise<WithdrawalRequest> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    if (!request.isPending()) {\r\n      throw new ServiceError(\r\n        'Only pending requests can be approved',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    const attributes: any = {\r\n      status: 'approved'\r\n    };\r\n\r\n    if (message) {\r\n      attributes.adminNote = message;\r\n    }\r\n\r\n    return await this.update(request, attributes);\r\n  }\r\n\r\n  /**\r\n   * Reject a funds request (admin only)\r\n   */\r\n  async reject(request: WithdrawalRequest, reason?: string): Promise<WithdrawalRequest> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    if (!request.isPending()) {\r\n      throw new ServiceError(\r\n        'Only pending requests can be rejected',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    const attributes: any = {\r\n      status: 'rejected'\r\n    };\r\n\r\n    if (reason) {\r\n      attributes.adminNote = reason;\r\n    }\r\n\r\n    return await this.update(request, attributes);\r\n  }\r\n\r\n  /**\r\n   * Cancel a pending request (user only)\r\n   */\r\n  async cancel(request: WithdrawalRequest): Promise<any> {\r\n    if (!request.canBeModified()) {\r\n      throw new ServiceError(\r\n        'This request cannot be cancelled',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    const currentUser = app.session.user;\r\n    if (!currentUser || (request.userId() !== currentUser.id() && !currentUser.isAdmin())) {\r\n      throw new ServiceError(\r\n        'You can only cancel your own requests',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return await this.delete(request);\r\n  }\r\n\r\n  /**\r\n   * Check if current user can modify a funds request\r\n   */\r\n  canModify(model: WithdrawalRequest): boolean {\r\n    const currentUser = app.session.user;\r\n    if (!currentUser) return false;\r\n\r\n    // Admin can modify any request\r\n    if (currentUser.isAdmin()) return true;\r\n\r\n    // Users can only modify their own pending requests\r\n    return model.userId() === currentUser.id() && model.canBeModified();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can create new funds requests\r\n   */\r\n  canCreate(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && !currentUser.isGuest();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can delete a funds request\r\n   */\r\n  canDelete(model: WithdrawalRequest): boolean {\r\n    const currentUser = app.session.user;\r\n    if (!currentUser) return false;\r\n\r\n    // Admin can delete any request\r\n    if (currentUser.isAdmin()) return true;\r\n\r\n    // Users can only delete their own pending requests\r\n    return model.userId() === currentUser.id() && model.canBeModified();\r\n  }\r\n\r\n  /**\r\n   * Get available funds platforms\r\n   */\r\n  async getPlatforms(): Promise<WithdrawalPlatform[]> {\r\n    try {\r\n      const platforms = await app.store.find(this.platformModelType, {\r\n        filter: { isActive: true },\r\n        sort: 'name'\r\n      });\r\n      \r\n      return Array.isArray(platforms) ? platforms : [platforms];\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to fetch funds platforms');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate funds request data\r\n   */\r\n  private async validateWithdrawalRequest(data: any): Promise<void> {\r\n    const { platformId, amount } = data;\r\n\r\n    // Get platform details\r\n    const platform = await app.store.find(this.platformModelType, platformId);\r\n    if (!platform) {\r\n      throw new ServiceError(\r\n        'Invalid platform selected',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    // Check if platform is active\r\n    if (!platform.isActive()) {\r\n      throw new ServiceError(\r\n        'Selected platform is not available',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    // Validate amount limits\r\n    const minAmount = platform.minAmount();\r\n    const maxAmount = platform.maxAmount();\r\n    \r\n    if (amount < minAmount) {\r\n      throw new ServiceError(\r\n        `Minimum funds amount is ${minAmount}`,\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    if (maxAmount && amount > maxAmount) {\r\n      throw new ServiceError(\r\n        `Maximum funds amount is ${maxAmount}`,\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    // Check user balance\r\n    const currentUser = app.session.user;\r\n    if (currentUser) {\r\n      const userBalance = parseFloat(currentUser.attribute('money') || '0');\r\n      const fee = platform.fee ? platform.fee() : 0;\r\n      const totalRequired = amount + fee;\r\n\r\n      if (userBalance < totalRequired) {\r\n        throw new ServiceError(\r\n          `Insufficient balance. Required: ${totalRequired}, Available: ${userBalance}`,\r\n          ServiceErrorType.VALIDATION_ERROR\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate create attributes\r\n   */\r\n  private validateCreateAttributes(attributes: any): void {\r\n    const required = ['platformId', 'amount', 'accountDetails'];\r\n    \r\n    for (const field of required) {\r\n      if (!attributes[field]) {\r\n        throw new ServiceError(\r\n          `${field} is required`,\r\n          ServiceErrorType.VALIDATION_ERROR\r\n        );\r\n      }\r\n    }\r\n\r\n    if (typeof attributes.amount !== 'number' || attributes.amount <= 0) {\r\n      throw new ServiceError(\r\n        'Amount must be a positive number',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle service errors with proper typing\r\n   */\r\n  private handleError(error: any, defaultMessage: string): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle Flarum API errors\r\n    if (error.response && error.response.errors) {\r\n      const apiError = error.response.errors[0];\r\n      return new ServiceError(\r\n        apiError.detail || defaultMessage,\r\n        ServiceErrorType.VALIDATION_ERROR,\r\n        apiError.code,\r\n        apiError\r\n      );\r\n    }\r\n\r\n    // Handle network errors\r\n    if (error.name === 'TypeError' || error.message?.includes('fetch')) {\r\n      return new ServiceError(\r\n        'Network error occurred',\r\n        ServiceErrorType.NETWORK_ERROR\r\n      );\r\n    }\r\n\r\n    // Default error handling\r\n    return new ServiceError(\r\n      error.message || defaultMessage,\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Check if error is a not found error\r\n   */\r\n  private isNotFoundError(error: any): boolean {\r\n    return error.status === 404 || \r\n           error.response?.status === 404 ||\r\n           error.message?.includes('not found');\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const withdrawalService = new WithdrawalService();","import app from 'flarum/common/app';\r\nimport { \r\n  PlatformServiceInterface, \r\n  QueryOptions, \r\n  ServiceError, \r\n  ServiceErrorType \r\n} from '../types/services';\r\n\r\n/**\r\n * Service for managing both funds and deposit platforms\r\n */\r\nexport default class PlatformService implements PlatformServiceInterface {\r\n  private readonly withdrawalModelType = 'funds-platforms';\r\n  private readonly depositModelType = 'deposit-platforms';\r\n\r\n  /**\r\n   * Find multiple platforms of specified type\r\n   */\r\n  async find(type: 'funds' | 'deposit', options: QueryOptions = {}): Promise<any[]> {\r\n    const modelType = type === 'funds' ? this.withdrawalModelType : this.depositModelType;\r\n    \r\n    try {\r\n      const queryParams: any = {\r\n        sort: options.sort || 'name',\r\n        ...options\r\n      };\r\n\r\n      // Add pagination if specified\r\n      if (options.page) {\r\n        queryParams.page = options.page;\r\n      }\r\n\r\n      // Add filters if specified\r\n      if (options.filter) {\r\n        queryParams.filter = options.filter;\r\n      }\r\n\r\n      // Include relationships if specified\r\n      if (options.include) {\r\n        queryParams.include = options.include;\r\n      }\r\n\r\n      const results = await app.store.find(modelType, queryParams);\r\n      return Array.isArray(results) ? results : [results];\r\n    } catch (error) {\r\n      throw this.handleError(error, `Failed to fetch ${type} platforms`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find a single platform by ID\r\n   */\r\n  async findById(\r\n    type: 'funds' | 'deposit', \r\n    id: string | number, \r\n    options: QueryOptions = {}\r\n  ): Promise<any | null> {\r\n    const modelType = type === 'funds' ? this.withdrawalModelType : this.depositModelType;\r\n    \r\n    try {\r\n      const queryParams: any = {};\r\n      \r\n      // Include relationships if specified\r\n      if (options.include) {\r\n        queryParams.include = options.include;\r\n      }\r\n\r\n      const result = await app.store.find(modelType, id, queryParams);\r\n      return result;\r\n    } catch (error) {\r\n      if (this.isNotFoundError(error)) {\r\n        return null;\r\n      }\r\n      throw this.handleError(error, `Failed to fetch ${type} platform ${id}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a new platform\r\n   */\r\n  async create(type: 'funds' | 'deposit', attributes: Record<string, any>): Promise<any> {\r\n    const modelType = type === 'funds' ? this.withdrawalModelType : this.depositModelType;\r\n    \r\n    try {\r\n      // Validate required fields based on platform type\r\n      this.validateCreateAttributes(type, attributes);\r\n\r\n      const platform = app.store.createRecord(modelType);\r\n      \r\n      const savedPlatform = await platform.save(attributes);\r\n      return savedPlatform;\r\n    } catch (error) {\r\n      throw this.handleError(error, `Failed to create ${type} platform`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update an existing platform\r\n   */\r\n  async update(platform: any, attributes: Record<string, any>): Promise<any> {\r\n    try {\r\n      if (!this.canModify(platform)) {\r\n        throw new ServiceError(\r\n          'You do not have permission to modify this platform',\r\n          ServiceErrorType.PERMISSION_DENIED\r\n        );\r\n      }\r\n\r\n      const updatedPlatform = await platform.save(attributes);\r\n      return updatedPlatform;\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to update platform');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a platform\r\n   */\r\n  async delete(platform: any): Promise<void> {\r\n    try {\r\n      if (!this.canDelete(platform)) {\r\n        throw new ServiceError(\r\n          'You do not have permission to delete this platform',\r\n          ServiceErrorType.PERMISSION_DENIED\r\n        );\r\n      }\r\n\r\n      await platform.delete();\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to delete platform');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get active platforms only\r\n   */\r\n  async getActive(type: 'funds' | 'deposit', options: QueryOptions = {}): Promise<any[]> {\r\n    const queryOptions = {\r\n      ...options,\r\n      filter: {\r\n        isActive: true,\r\n        ...options.filter\r\n      }\r\n    };\r\n\r\n    return await this.find(type, queryOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle platform status (admin only)\r\n   */\r\n  async toggleStatus(platform: any): Promise<any> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    const currentStatus = platform.isActive();\r\n    return await this.update(platform, { isActive: !currentStatus });\r\n  }\r\n\r\n  /**\r\n   * Update platform configuration (admin only)\r\n   */\r\n  async updateConfig(platform: any, config: Record<string, any>): Promise<any> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return await this.update(platform, config);\r\n  }\r\n\r\n  /**\r\n   * Get platforms by symbol\r\n   */\r\n  async getBySymbol(symbol: string, type: 'funds' | 'deposit'): Promise<any[]> {\r\n    return await this.find(type, {\r\n      filter: { symbol: symbol },\r\n      sort: 'name'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate platform limits for an amount\r\n   */\r\n  validateAmount(platform: any, amount: number): { valid: boolean; errors: string[] } {\r\n    const errors: string[] = [];\r\n\r\n    if (typeof amount !== 'number' || amount <= 0) {\r\n      errors.push('Amount must be a positive number');\r\n      return { valid: false, errors };\r\n    }\r\n\r\n    const minAmount = platform.minAmount ? platform.minAmount() : 0;\r\n    const maxAmount = platform.maxAmount ? platform.maxAmount() : null;\r\n\r\n    if (amount < minAmount) {\r\n      errors.push(`Amount must be at least ${minAmount}`);\r\n    }\r\n\r\n    if (maxAmount && amount > maxAmount) {\r\n      errors.push(`Amount cannot exceed ${maxAmount}`);\r\n    }\r\n\r\n    return { valid: errors.length === 0, errors };\r\n  }\r\n\r\n  /**\r\n   * Get platform statistics (admin only)\r\n   */\r\n  async getPlatformStats(type: 'funds' | 'deposit', platformId: number): Promise<any> {\r\n    if (!app.session.user?.isAdmin()) {\r\n      throw new ServiceError(\r\n        'Admin permissions required',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    const requestType = type === 'funds' ? 'funds-requests' : 'deposit-records';\r\n    \r\n    try {\r\n      // Get all requests/records for this platform\r\n      const records = await app.store.find(requestType, {\r\n        filter: { platform: platformId },\r\n        include: 'platform'\r\n      });\r\n\r\n      const recordArray = Array.isArray(records) ? records : [records];\r\n\r\n      // Calculate statistics\r\n      const stats = {\r\n        total: recordArray.length,\r\n        pending: recordArray.filter(r => r.status() === 'pending').length,\r\n        approved: recordArray.filter(r => r.status() === 'approved' || r.status() === 'confirmed').length,\r\n        rejected: recordArray.filter(r => r.status() === 'rejected').length,\r\n        totalAmount: recordArray.reduce((sum, r) => sum + (r.amount() || 0), 0)\r\n      };\r\n\r\n      return stats;\r\n    } catch (error) {\r\n      throw this.handleError(error, 'Failed to fetch platform statistics');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get platforms grouped by symbol\r\n   */\r\n  async getPlatformsBySymbolGrouped(type: 'funds' | 'deposit'): Promise<Record<string, any[]>> {\r\n    const platforms = await this.getActive(type);\r\n    const grouped: Record<string, any[]> = {};\r\n\r\n    for (const platform of platforms) {\r\n      const symbol = platform.symbol();\r\n      if (!grouped[symbol]) {\r\n        grouped[symbol] = [];\r\n      }\r\n      grouped[symbol].push(platform);\r\n    }\r\n\r\n    return grouped;\r\n  }\r\n\r\n  /**\r\n   * Sort platforms by criteria\r\n   */\r\n  async getSortedPlatforms(\r\n    type: 'funds' | 'deposit', \r\n    sortBy: 'name' | 'symbol' | 'createdAt' | 'fee' = 'name',\r\n    direction: 'asc' | 'desc' = 'asc'\r\n  ): Promise<any[]> {\r\n    const sortString = direction === 'desc' ? `-${sortBy}` : sortBy;\r\n    \r\n    return await this.getActive(type, {\r\n      sort: sortString\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check if current user can modify platforms\r\n   */\r\n  canModify(_platform: any): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can create new platforms\r\n   */\r\n  canCreate(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can delete platforms\r\n   */\r\n  canDelete(_platform: any): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Validate create attributes based on platform type\r\n   */\r\n  private validateCreateAttributes(type: 'funds' | 'deposit', attributes: any): void {\r\n    const commonRequired = ['name', 'symbol', 'minAmount'];\r\n    \r\n    // Only common fields are required (removed address requirement)\r\n    const required = commonRequired;\r\n\r\n    for (const field of required) {\r\n      if (!attributes[field]) {\r\n        throw new ServiceError(\r\n          `${field} is required for ${type} platforms`,\r\n          ServiceErrorType.VALIDATION_ERROR\r\n        );\r\n      }\r\n    }\r\n\r\n    if (typeof attributes.minAmount !== 'number' || attributes.minAmount < 0) {\r\n      throw new ServiceError(\r\n        'minAmount must be a non-negative number',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    if (attributes.maxAmount !== undefined) {\r\n      if (typeof attributes.maxAmount !== 'number' || attributes.maxAmount < attributes.minAmount) {\r\n        throw new ServiceError(\r\n          'maxAmount must be a number greater than or equal to minAmount',\r\n          ServiceErrorType.VALIDATION_ERROR\r\n        );\r\n      }\r\n    }\r\n\r\n    if (attributes.fee !== undefined) {\r\n      if (typeof attributes.fee !== 'number' || attributes.fee < 0) {\r\n        throw new ServiceError(\r\n          'fee must be a non-negative number',\r\n          ServiceErrorType.VALIDATION_ERROR\r\n        );\r\n      }\r\n    }\r\n\r\n    // Validate symbol format (basic validation)\r\n    if (typeof attributes.symbol !== 'string' || !attributes.symbol.trim()) {\r\n      throw new ServiceError(\r\n        'Symbol is required',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle service errors with proper typing\r\n   */\r\n  private handleError(error: any, defaultMessage: string): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle Flarum API errors\r\n    if (error.response && error.response.errors) {\r\n      const apiError = error.response.errors[0];\r\n      return new ServiceError(\r\n        apiError.detail || defaultMessage,\r\n        ServiceErrorType.VALIDATION_ERROR,\r\n        apiError.code,\r\n        apiError\r\n      );\r\n    }\r\n\r\n    // Handle network errors\r\n    if (error.name === 'TypeError' || error.message?.includes('fetch')) {\r\n      return new ServiceError(\r\n        'Network error occurred',\r\n        ServiceErrorType.NETWORK_ERROR\r\n      );\r\n    }\r\n\r\n    // Default error handling\r\n    return new ServiceError(\r\n      error.message || defaultMessage,\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Check if error is a not found error\r\n   */\r\n  private isNotFoundError(error: any): boolean {\r\n    return error.status === 404 || \r\n           error.response?.status === 404 ||\r\n           error.message?.includes('not found');\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const platformService = new PlatformService();","/**\r\n * Flarum API error interface for proper error handling\r\n */\r\nexport interface FlarumApiError {\r\n  response?: {\r\n    status?: number;\r\n    errors?: Array<{\r\n      detail?: string;\r\n      code?: string;\r\n    }>;\r\n  };\r\n  responseText?: string;\r\n  status?: number;\r\n}\r\n\r\n/**\r\n * Helper function to extract error message from Flarum API error\r\n */\r\nexport function extractErrorMessage(error: any, fallback = 'An error occurred'): string {\r\n  if (!error) return fallback;\r\n\r\n  // Check for JSON:API error format\r\n  if (error.response && error.response.errors && Array.isArray(error.response.errors)) {\r\n    const firstError = error.response.errors[0];\r\n    if (firstError && firstError.detail) {\r\n      return firstError.detail;\r\n    }\r\n  }\r\n\r\n  // Check for HTML error responses (PHP Fatal Errors)\r\n  if (error.responseText) {\r\n    if (error.responseText.includes('<b>Fatal error</b>') || error.responseText.includes('<!DOCTYPE')) {\r\n      return 'Server error occurred. Please try again later.';\r\n    }\r\n    \r\n    // Try to parse JSON response\r\n    try {\r\n      const response = JSON.parse(error.responseText);\r\n      if (response.errors && Array.isArray(response.errors)) {\r\n        return response.errors[0].detail || fallback;\r\n      }\r\n    } catch {\r\n      // Not valid JSON, return server error message\r\n      return 'Server error occurred. Please try again later.';\r\n    }\r\n  }\r\n\r\n  return fallback;\r\n}\r\n\r\n/**\r\n * Type guard to check if error is a Flarum API error\r\n */\r\nexport function isFlarumApiError(error: any): error is FlarumApiError {\r\n  return error && (\r\n    (error.response && error.response.errors) ||\r\n    error.responseText ||\r\n    error.status\r\n  );\r\n}\r\n\r\n/**\r\n * Type assertion helper for API responses\r\n * This is a temporary solution until better typing is available\r\n */\r\nexport function assertApiPayload(response: unknown): any {\r\n  // In a production environment, you would add runtime validation here\r\n  return response as any;\r\n}","import app from 'flarum/forum/app';\r\nimport Page from 'flarum/common/components/Page';\r\nimport Button from 'flarum/common/components/Button';\r\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\r\nimport Stream from 'flarum/common/utils/Stream';\r\nimport icon from 'flarum/common/helpers/icon';\r\nimport m from 'mithril';\r\nimport type Mithril from 'mithril';\r\n\r\n// Withdrawal imports\r\nimport type { WithdrawalFormData } from './withdrawal/types/interfaces';\r\nimport WithdrawalPlatform from '../../common/models/WithdrawalPlatform';\r\nimport WithdrawalForm from './withdrawal/forms/WithdrawalForm';\r\nimport TransactionHistory from './shared/TransactionHistory';\r\n\r\n// Deposit imports\r\nimport type { DepositFormData } from './deposit/forms/DepositForm';\r\nimport DepositForm from './deposit/forms/DepositForm';\r\nimport DepositRecord from '../../common/models/DepositRecord';\r\nimport depositService from '../../common/services/DepositService';\r\n\r\n// Services\r\nimport { withdrawalService, platformService } from '../../common/services';\r\nimport { ServiceError } from '../../common/types/services';\r\n\r\n// Utilities\r\nimport { getAttr, getIdString } from './withdrawal/utils/modelHelpers';\r\nimport { extractErrorMessage, type FlarumApiError } from '../../common/types/api';\r\n\r\ntype TabType = 'withdrawal' | 'deposit';\r\ntype SubTabType = 'form' | 'history';\r\n\r\ninterface FundsPageState {\r\n  // Withdrawal state\r\n  withdrawalPlatforms: WithdrawalPlatform[];\r\n  withdrawalRequests: any[];\r\n  userBalance: number;\r\n  loadingBalance: boolean;\r\n  submitting: boolean;\r\n  \r\n  // Simplified deposit state - 简化的存款状态\r\n  depositRecords: DepositRecord[];\r\n  submittingDeposit: boolean;\r\n  \r\n  // Shared state\r\n  loading: boolean;\r\n  activeTab: Stream<TabType>;\r\n  withdrawalSubTab: Stream<SubTabType>;\r\n  depositSubTab: Stream<SubTabType>;\r\n}\r\n\r\nexport default class FundsPage extends Page<any, FundsPageState> {\r\n  state: FundsPageState = {\r\n    withdrawalPlatforms: [],\r\n    withdrawalRequests: [],\r\n    userBalance: 0,\r\n    loadingBalance: true,\r\n    submitting: false,\r\n    depositRecords: [],\r\n    submittingDeposit: false,\r\n    loading: true,\r\n    activeTab: Stream('withdrawal'),\r\n    withdrawalSubTab: Stream('form'),\r\n    depositSubTab: Stream('form')\r\n  };\r\n\r\n  // Withdrawal form data\r\n  private withdrawalFormData: WithdrawalFormData = {\r\n    amount: Stream(''),\r\n    selectedPlatform: Stream<WithdrawalPlatform | null>(null),\r\n    accountDetails: Stream(''),\r\n    message: Stream('')\r\n  };\r\n\r\n  // 简化的存款表单数据不需要复杂的状态管理\r\n\r\n  oninit(vnode: Mithril.VnodeDOM) {\r\n    super.oninit(vnode);\r\n\r\n    // Parse URL to determine initial tab and sub-tab\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const tabParam = urlParams.get('tab');\r\n    \r\n    // Handle legacy URL parameters and set appropriate tab/subtab\r\n    if (tabParam) {\r\n      if (tabParam === 'withdrawal' || tabParam === 'withdrawal-history') {\r\n        this.state.activeTab('withdrawal');\r\n        this.state.withdrawalSubTab(tabParam === 'withdrawal-history' ? 'history' : 'form');\r\n      } else if (tabParam === 'deposit' || tabParam === 'deposit-history') {\r\n        this.state.activeTab('deposit');\r\n        this.state.depositSubTab(tabParam === 'deposit-history' ? 'history' : 'form');\r\n      } else if (this.isValidTab(tabParam)) {\r\n        this.state.activeTab(tabParam as TabType);\r\n      }\r\n    }\r\n\r\n    // Set page title based on active tab\r\n    this.updatePageTitle();\r\n\r\n    // Load data for both systems\r\n    this.loadAllData();\r\n  }\r\n\r\n\r\n  private isValidTab(tab: string): boolean {\r\n    return ['withdrawal', 'deposit'].includes(tab);\r\n  }\r\n\r\n  private isValidSubTab(subTab: string): boolean {\r\n    return ['form', 'history'].includes(subTab);\r\n  }\r\n\r\n  private handleSubTabChange(mainTab: TabType, subTab: SubTabType): void {\r\n    if (mainTab === 'withdrawal') {\r\n      this.state.withdrawalSubTab(subTab);\r\n    } else if (mainTab === 'deposit') {\r\n      this.state.depositSubTab(subTab);\r\n    }\r\n    this.updateUrl();\r\n    m.redraw();\r\n  }\r\n\r\n  private updateUrl(): void {\r\n    const currentTab = this.state.activeTab();\r\n    const params = new URLSearchParams();\r\n    \r\n    if (currentTab === 'withdrawal') {\r\n      const subTab = this.state.withdrawalSubTab();\r\n      if (subTab === 'history') {\r\n        params.set('tab', 'withdrawal-history');\r\n      } else {\r\n        params.set('tab', 'withdrawal');\r\n      }\r\n    } else if (currentTab === 'deposit') {\r\n      const subTab = this.state.depositSubTab();\r\n      if (subTab === 'history') {\r\n        params.set('tab', 'deposit-history');\r\n      } else {\r\n        params.set('tab', 'deposit');\r\n      }\r\n    }\r\n\r\n    const newUrl = `${window.location.pathname}?${params.toString()}`;\r\n    window.history.replaceState({}, '', newUrl);\r\n  }\r\n\r\n  private updatePageTitle(): void {\r\n    const tab = this.state.activeTab();\r\n    let titleKey = 'funds.forum.page.title'; // default\r\n    \r\n    switch (tab) {\r\n      case 'withdrawal':\r\n      case 'withdrawal-history':\r\n        titleKey = 'funds.forum.page.title';\r\n        break;\r\n      case 'deposit':\r\n      case 'deposit-history':\r\n        titleKey = 'funds.forum.deposit.page.title';\r\n        break;\r\n    }\r\n    \r\n    // Fixed: Convert NestedStringArray to string using toString()\r\n    const title = app.translator.trans(titleKey);\r\n    app.setTitle(typeof title === 'string' ? title : title.toString());\r\n  }\r\n\r\n  view() {\r\n    if (this.state.loading) {\r\n      return (\r\n        <div className=\"FundsPage\">\r\n          <div className=\"FundsPage-loading\">\r\n            <LoadingIndicator />\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"FundsPage\">\r\n        <div className=\"FundsPage-modal\">\r\n          {this.renderHeader()}\r\n          <div className=\"FundsPage-content\">\r\n            {this.renderActiveTab()}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderHeader(): Mithril.Children {\r\n    const activeTab = this.state.activeTab();\r\n    \r\n    return (\r\n      <div className=\"FundsPage-header\">\r\n        <div className=\"FundsPage-tabs\">\r\n          <div \r\n            className={`FundsPage-tab ${activeTab === 'withdrawal' ? 'active' : ''}`}\r\n            onclick={() => this.handleTabChange('withdrawal')}\r\n          >\r\n            {app.translator.trans('funds.forum.tabs.funds')}\r\n          </div>\r\n          <div \r\n            className={`FundsPage-tab ${activeTab === 'deposit' ? 'active' : ''}`}\r\n            onclick={() => this.handleTabChange('deposit')}\r\n          >\r\n            {app.translator.trans('funds.forum.deposit.tabs.deposit')}\r\n          </div>\r\n        </div>\r\n        <Button\r\n          className=\"FundsPage-close\"\r\n          icon=\"fas fa-times\"\r\n          onclick={() => app.history.back()}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderActiveTab(): Mithril.Children {\r\n    const activeTab = this.state.activeTab();\r\n    \r\n    switch (activeTab) {\r\n      case 'withdrawal':\r\n        return this.renderWithdrawalTab();\r\n      case 'deposit':\r\n        return this.renderDepositTab();\r\n      default:\r\n        return this.renderWithdrawalTab();\r\n    }\r\n  }\r\n\r\n  private renderWithdrawalTab(): Mithril.Children {\r\n    const activeSubTab = this.state.withdrawalSubTab();\r\n    \r\n    return (\r\n      <div className=\"FundsPage-withdrawalTab\">\r\n        {/* Sub-tab navigation */}\r\n        <div className=\"FundsPage-subTabs\">\r\n          <div \r\n            className={`FundsPage-subTab ${activeSubTab === 'form' ? 'active' : ''}`}\r\n            onclick={() => this.handleSubTabChange('withdrawal', 'form')}\r\n          >\r\n            {app.translator.trans('funds.forum.tabs.funds')}\r\n          </div>\r\n          <div \r\n            className={`FundsPage-subTab ${activeSubTab === 'history' ? 'active' : ''}`}\r\n            onclick={() => this.handleSubTabChange('withdrawal', 'history')}\r\n          >\r\n            {app.translator.trans('funds.forum.tabs.history')}\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Sub-tab content */}\r\n        {activeSubTab === 'form' ? this.renderWithdrawalForm() : this.renderWithdrawalHistory()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderWithdrawalForm(): Mithril.Children {\r\n    const validPlatforms = (this.state.withdrawalPlatforms || []).filter(platform => !!platform);\r\n\r\n    if (validPlatforms.length === 0) {\r\n      return (\r\n        <div className=\"FundsPage-withdrawalContent\">\r\n          <div className=\"WithdrawalPage-emptyState\">\r\n            <div className=\"WithdrawalPage-emptyIcon\">\r\n              {icon('fas fa-coins')}\r\n            </div>\r\n            <h3 className=\"WithdrawalPage-emptyTitle\">\r\n              {app.translator.trans('funds.forum.no_platforms')}\r\n            </h3>\r\n            <p className=\"WithdrawalPage-emptyDescription\">\r\n              {app.translator.trans('funds.forum.no_platforms_description')}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"FundsPage-withdrawalContent\">\r\n        <WithdrawalForm\r\n          platforms={this.state.withdrawalPlatforms}\r\n          formData={this.getWithdrawalFormDataForComponent()}\r\n          loadingBalance={this.state.loadingBalance}\r\n          submitting={this.state.submitting}\r\n          onFormDataChange={this.handleWithdrawalFormDataChange.bind(this)}\r\n          onFillAllAmount={this.handleFillAllAmount.bind(this)}\r\n          onSubmit={this.handleWithdrawalSubmit.bind(this)}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderWithdrawalHistory(): Mithril.Children {\r\n    return (\r\n      <div className=\"FundsPage-withdrawalContent\">\r\n        <TransactionHistory\r\n          transactions={this.state.withdrawalRequests}\r\n          platforms={this.state.withdrawalPlatforms}\r\n          loading={false}\r\n          type=\"withdrawal\"\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderDepositTab(): Mithril.Children {\r\n    const activeSubTab = this.state.depositSubTab();\r\n    \r\n    return (\r\n      <div className=\"FundsPage-depositTab\">\r\n        {/* Sub-tab navigation */}\r\n        <div className=\"FundsPage-subTabs\">\r\n          <div \r\n            className={`FundsPage-subTab ${activeSubTab === 'form' ? 'active' : ''}`}\r\n            onclick={() => this.handleSubTabChange('deposit', 'form')}\r\n          >\r\n            {app.translator.trans('funds.forum.deposit.tabs.deposit')}\r\n          </div>\r\n          <div \r\n            className={`FundsPage-subTab ${activeSubTab === 'history' ? 'active' : ''}`}\r\n            onclick={() => this.handleSubTabChange('deposit', 'history')}\r\n          >\r\n            {app.translator.trans('funds.forum.deposit.tabs.history')}\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Sub-tab content */}\r\n        {activeSubTab === 'form' ? this.renderDepositForm() : this.renderDepositHistory()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderDepositForm(): Mithril.Children {\r\n    return (\r\n      <div className=\"FundsPage-depositContent\">\r\n        <DepositForm\r\n          onSubmit={this.handleDepositSubmit.bind(this)}\r\n          onCancel={this.handleCancelDepositForm.bind(this)}\r\n          submitting={this.state.submittingDeposit}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderDepositHistory(): Mithril.Children {\r\n    const depositRecords = this.state.depositRecords || [];\r\n\r\n    if (depositRecords.length === 0) {\r\n      return (\r\n        <div className=\"FundsPage-depositContent\">\r\n          <div className=\"FundsPage-emptyState\">\r\n            <div className=\"FundsPage-emptyIcon\">\r\n              {icon('fas fa-history')}\r\n            </div>\r\n            <h3 className=\"FundsPage-emptyTitle\">\r\n              {app.translator.trans('funds.forum.deposit.form.no_history', {}, '暂无存款记录')}\r\n            </h3>\r\n            <p className=\"FundsPage-emptyDescription\">\r\n              {app.translator.trans('funds.forum.deposit.form.no_history_description', {}, '您还没有提交过任何存款申请')}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"FundsPage-depositContent\">\r\n        <div className=\"SimpleDepositHistory\">\r\n          {depositRecords.map((record: DepositRecord) => (\r\n            <div key={record.id()} className=\"SimpleDepositHistory-item\">\r\n              <div className=\"SimpleDepositHistory-header\">\r\n                <span className={`Badge Badge--${record.getStatusColor()}`}>\r\n                  <i className={record.getStatusIcon()}></i>\r\n                  {record.statusText()}\r\n                </span>\r\n                <span className=\"SimpleDepositHistory-date\">\r\n                  {record.formattedCreatedAt()}\r\n                </span>\r\n              </div>\r\n              <div className=\"SimpleDepositHistory-content\">\r\n                <div className=\"SimpleDepositHistory-address\">\r\n                  <strong>{app.translator.trans('funds.forum.deposit.form.deposit_address', {}, '存款地址')}:</strong>\r\n                  <code>{record.getDisplayAddress()}</code>\r\n                </div>\r\n                {record.hasQrCode() && (\r\n                  <div className=\"SimpleDepositHistory-qr\">\r\n                    <strong>{app.translator.trans('funds.forum.deposit.form.qr_code_url', {}, '收款二维码')}:</strong>\r\n                    <a href={record.qrCodeUrl()} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                      {app.translator.trans('funds.forum.deposit.form.view_qr', {}, '查看二维码')}\r\n                    </a>\r\n                  </div>\r\n                )}\r\n                {record.userMessage() && (\r\n                  <div className=\"SimpleDepositHistory-message\">\r\n                    <strong>{app.translator.trans('funds.forum.deposit.form.user_message', {}, '留言')}:</strong>\r\n                    <p>{record.userMessage()}</p>\r\n                  </div>\r\n                )}\r\n                {record.adminNotes() && (\r\n                  <div className=\"SimpleDepositHistory-adminNotes\">\r\n                    <strong>{app.translator.trans('funds.forum.deposit.form.admin_notes', {}, '管理员备注')}:</strong>\r\n                    <p>{record.adminNotes()}</p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // 移除复杂的存款选择器和信息显示 - 简化版本不再需要这些方法\r\n\r\n\r\n  private handleTabChange(tab: TabType): void {\r\n    this.state.activeTab(tab);\r\n    this.updatePageTitle();\r\n    \r\n    // Update URL without page reload\r\n    const url = new URL(window.location.href);\r\n    url.searchParams.set('tab', tab);\r\n    \r\n    // Include current sub-tab in URL\r\n    const currentSubTab = tab === 'withdrawal' ? this.state.withdrawalSubTab() : this.state.depositSubTab();\r\n    url.searchParams.set('subtab', currentSubTab);\r\n    \r\n    window.history.replaceState({}, '', url.toString());\r\n  }\r\n\r\n\r\n  // Withdrawal methods (copied from WithdrawalPage)\r\n  private getWithdrawalFormDataForComponent() {\r\n    // Fixed: Added null check to prevent invoking null objects\r\n    const selectedPlatform = this.withdrawalFormData.selectedPlatform();\r\n    return {\r\n      selectedPlatform: selectedPlatform,\r\n      amount: this.withdrawalFormData.amount(),\r\n      accountDetails: this.withdrawalFormData.accountDetails(),\r\n      message: this.withdrawalFormData.message()\r\n    };\r\n  }\r\n\r\n  private handleWithdrawalFormDataChange(data: Partial<WithdrawalFormData>): void {\r\n    if (data.selectedPlatform !== undefined) {\r\n      this.withdrawalFormData.selectedPlatform(data.selectedPlatform);\r\n    }\r\n    if (data.amount !== undefined) {\r\n      this.withdrawalFormData.amount(data.amount);\r\n    }\r\n    if (data.accountDetails !== undefined) {\r\n      this.withdrawalFormData.accountDetails(data.accountDetails);\r\n    }\r\n    if (data.message !== undefined) {\r\n      this.withdrawalFormData.message(data.message);\r\n    }\r\n  }\r\n\r\n  private async handleFillAllAmount(): Promise<void> {\r\n    const selectedPlatform = this.withdrawalFormData.selectedPlatform();\r\n    if (!selectedPlatform) return;\r\n\r\n    if (this.state.loadingBalance) return;\r\n\r\n    try {\r\n      await this.loadUserBalance(true);\r\n\r\n      const fee = getAttr(selectedPlatform, 'fee') || 0;\r\n      const maxAmount = getAttr(selectedPlatform, 'maxAmount') || Infinity;\r\n      let availableAmount = this.state.userBalance - fee;\r\n      \r\n      if (maxAmount < Infinity && availableAmount > maxAmount) {\r\n        availableAmount = maxAmount;\r\n      }\r\n      \r\n      if (availableAmount > 0) {\r\n        this.withdrawalFormData.amount(availableAmount.toString());\r\n      } else {\r\n        app.alerts.show(\r\n          { type: 'warning', dismissible: true },\r\n          app.translator.trans('funds.forum.insufficient_balance')\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error('Error refreshing balance:', error);\r\n      app.alerts.show(\r\n        { type: 'error', dismissible: true },\r\n        app.translator.trans('funds.forum.balance_refresh_error')\r\n      );\r\n    }\r\n  }\r\n\r\n  private async handleWithdrawalSubmit(): Promise<void> {\r\n    if (this.state.submitting) return;\r\n\r\n    const selectedPlatform = this.withdrawalFormData.selectedPlatform();\r\n    const amount = this.withdrawalFormData.amount();\r\n    const accountDetails = this.withdrawalFormData.accountDetails();\r\n\r\n    if (!selectedPlatform || !amount || !accountDetails) {\r\n      return;\r\n    }\r\n\r\n    // Basic validation\r\n    const amountNum = parseFloat(amount);\r\n    if (isNaN(amountNum) || amountNum <= 0) {\r\n      app.alerts.show(\r\n        { type: 'warning', dismissible: true },\r\n        app.translator.trans('funds.forum.invalid_amount')\r\n      );\r\n      return;\r\n    }\r\n\r\n    this.state.submitting = true;\r\n\r\n    try {\r\n      await withdrawalService.submitRequest({\r\n        platformId: parseInt(getIdString(selectedPlatform), 10),\r\n        amount: amountNum,\r\n        accountDetails,\r\n        message: this.withdrawalFormData.message()\r\n      });\r\n\r\n      // Clear form\r\n      this.withdrawalFormData.amount('');\r\n      this.withdrawalFormData.accountDetails('');\r\n      this.withdrawalFormData.message('');\r\n      this.withdrawalFormData.selectedPlatform(null);\r\n\r\n      // Refresh data\r\n      await Promise.all([\r\n        this.loadUserBalance(true),\r\n        this.loadWithdrawalRequests()\r\n      ]);\r\n\r\n      app.alerts.show(\r\n        { type: 'success', dismissible: true },\r\n        app.translator.trans('funds.forum.submit_success')\r\n      );\r\n\r\n    } catch (error: unknown) {\r\n      console.error('Withdrawal request failed:', error);\r\n      \r\n      let errorMessage = app.translator.trans('funds.forum.error').toString();\r\n      \r\n      if (error instanceof ServiceError) {\r\n        errorMessage = error.message;\r\n      } else {\r\n        errorMessage = extractErrorMessage(\r\n          error as FlarumApiError, \r\n          errorMessage\r\n        );\r\n      }\r\n      \r\n      app.alerts.show(\r\n        { type: 'error', dismissible: true },\r\n        errorMessage\r\n      );\r\n    } finally {\r\n      this.state.submitting = false;\r\n    }\r\n  }\r\n\r\n  // Deposit methods - simplified platform selection\r\n  \r\n  // 简化的存款处理方法\r\n  private handleCancelDepositForm(): void {\r\n    // 简单的取消操作，可以添加清空表单逻辑\r\n    m.redraw();\r\n  }\r\n\r\n  private async handleDepositSubmit(data: DepositFormData): Promise<void> {\r\n    if (this.state.submittingDeposit) return;\r\n\r\n    this.state.submittingDeposit = true;\r\n    m.redraw();\r\n\r\n    try {\r\n      await depositService.create(data);\r\n      \r\n      app.alerts.show(\r\n        { type: 'success', dismissible: true },\r\n        app.translator.trans('funds.forum.deposit.form.submit_success', {}, '存款申请提交成功，请等待管理员审核')\r\n      );\r\n\r\n      // 重新加载存款记录\r\n      await this.loadDepositRecords();\r\n\r\n      // 切换到历史标签页显示刚提交的记录\r\n      this.state.depositSubTab('history');\r\n\r\n    } catch (error: unknown) {\r\n      console.error('Simple deposit submission failed:', error);\r\n      \r\n      let errorMessage = app.translator.trans('funds.forum.deposit.form.submit_error', {}, '提交失败，请重试').toString();\r\n      \r\n      if (error instanceof ServiceError) {\r\n        errorMessage = error.message;\r\n      } else {\r\n        errorMessage = extractErrorMessage(\r\n          error as FlarumApiError,\r\n          errorMessage\r\n        );\r\n      }\r\n      \r\n      app.alerts.show(\r\n        { type: 'error', dismissible: true },\r\n        errorMessage\r\n      );\r\n    } finally {\r\n      this.state.submittingDeposit = false;\r\n      m.redraw();\r\n    }\r\n  }\r\n\r\n\r\n  // Data loading methods\r\n  private async loadAllData(): Promise<void> {\r\n    try {\r\n      await Promise.all([\r\n        this.loadWithdrawalData(),\r\n        this.loadDepositRecords(),\r\n        this.loadUserBalance()\r\n      ]);\r\n      \r\n      this.state.loading = false;\r\n      m.redraw();\r\n    } catch (error) {\r\n      console.error('Error loading data:', error);\r\n      this.state.loading = false;\r\n      m.redraw();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load funds platforms and user requests using service layer\r\n   */\r\n  private async loadWithdrawalData(): Promise<void> {\r\n    try {\r\n      const [platforms, requests] = await Promise.all([\r\n        platformService.getActive('withdrawal'),\r\n        withdrawalService.getUserHistory()\r\n      ]);\r\n\r\n      this.state.withdrawalPlatforms = platforms as WithdrawalPlatform[];\r\n      this.state.withdrawalRequests = requests;\r\n    } catch (error) {\r\n      console.error('Error loading funds data:', error);\r\n      // Fallback to empty arrays\r\n      this.state.withdrawalPlatforms = [];\r\n      this.state.withdrawalRequests = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 加载简化的存款记录\r\n   */\r\n  private async loadDepositRecords(): Promise<void> {\r\n    try {\r\n      const records = await depositService.getUserHistory();\r\n      this.state.depositRecords = records;\r\n    } catch (error) {\r\n      console.error('Error loading simple deposit records:', error);\r\n      this.state.depositRecords = [];\r\n    }\r\n  }\r\n\r\n  private async loadUserBalance(forceRefresh = false): Promise<void> {\r\n    try {\r\n      this.state.loadingBalance = true;\r\n      \r\n      if (forceRefresh && app.session.user) {\r\n        const userId = app.session.user.id();\r\n        if (!userId) {\r\n          throw new Error('User ID not available');\r\n        }\r\n        \r\n        // Refresh user data through the store\r\n        const updatedUser = await app.store.find('users', userId);\r\n        \r\n        if (updatedUser) {\r\n          this.state.userBalance = parseFloat(updatedUser.attribute('money')) || 0;\r\n        } else {\r\n          this.state.userBalance = 0;\r\n        }\r\n      } else {\r\n        this.state.userBalance = parseFloat(app.session.user?.attribute('money') || '0');\r\n      }\r\n      \r\n      this.state.loadingBalance = false;\r\n      m.redraw();\r\n    } catch (error) {\r\n      console.error('Error loading user balance:', error);\r\n      this.state.loadingBalance = false;\r\n      m.redraw();\r\n    }\r\n  }\r\n\r\n  private async loadWithdrawalRequests(): Promise<void> {\r\n    try {\r\n      const requests = await withdrawalService.getUserHistory();\r\n      this.state.withdrawalRequests = requests;\r\n    } catch (error) {\r\n      console.error('Error loading funds requests:', error);\r\n      this.state.withdrawalRequests = [];\r\n    }\r\n  }\r\n\r\n  // 移除复杂的地址生成逻辑 - 简化版本不再需要这个方法\r\n}","import { ServiceError, ServiceErrorType } from '../types/services';\r\n\r\n/**\r\n * Validate common platform fields\r\n */\r\nexport function validateCommonFields(attributes: Record<string, any>): string[] {\r\n  const errors: string[] = [];\r\n\r\n  // Name validation\r\n  if (attributes.name !== undefined) {\r\n    if (!attributes.name || typeof attributes.name !== 'string') {\r\n      errors.push('Platform name is required');\r\n    }\r\n  }\r\n\r\n  // Symbol validation\r\n  if (attributes.symbol !== undefined) {\r\n    if (!attributes.symbol || typeof attributes.symbol !== 'string') {\r\n      errors.push('Symbol is required');\r\n    }\r\n  }\r\n\r\n  return errors;\r\n}\r\n\r\n/**\r\n * Validate amount fields (min/max/fee)\r\n */\r\nexport function validateAmountFields(attributes: Record<string, any>, currentMinAmount?: number): string[] {\r\n  const errors: string[] = [];\r\n\r\n  // Min amount validation\r\n  if (attributes.minAmount !== undefined) {\r\n    if (typeof attributes.minAmount !== 'number' || attributes.minAmount < 0) {\r\n      errors.push('Minimum amount must be a non-negative number');\r\n    }\r\n  }\r\n\r\n  // Max amount validation\r\n  if (attributes.maxAmount !== undefined && attributes.maxAmount !== null) {\r\n    if (typeof attributes.maxAmount !== 'number' || attributes.maxAmount < 0) {\r\n      errors.push('Maximum amount must be a non-negative number');\r\n    }\r\n    \r\n    const minAmount = attributes.minAmount ?? currentMinAmount ?? 0;\r\n    if (attributes.maxAmount < minAmount) {\r\n      errors.push('Maximum amount must be greater than or equal to minimum amount');\r\n    }\r\n  }\r\n\r\n  // Fee validation\r\n  if (attributes.fee !== undefined && attributes.fee !== null) {\r\n    if (typeof attributes.fee !== 'number' || attributes.fee < 0) {\r\n      errors.push('Fee must be a non-negative number');\r\n    }\r\n  }\r\n\r\n  return errors;\r\n}\r\n\r\n/**\r\n * Validate deposit-specific fields\r\n */\r\nexport function validateDepositFields(attributes: Record<string, any>): string[] {\r\n  const errors: string[] = [];\r\n\r\n  // Network validation (for deposit platforms) - only validate if provided\r\n  if (attributes.network !== undefined && attributes.network !== null && attributes.network !== '') {\r\n    if (typeof attributes.network !== 'string') {\r\n      errors.push('Network must be a string');\r\n    }\r\n  }\r\n\r\n  // Address validation (for deposit platforms) - only validate if provided\r\n  if (attributes.address !== undefined && attributes.address !== null && attributes.address !== '') {\r\n    if (typeof attributes.address !== 'string') {\r\n      errors.push('Deposit address must be a string');\r\n    }\r\n  }\r\n\r\n  return errors;\r\n}\r\n\r\n/**\r\n * Throw validation error if there are any errors\r\n */\r\nexport function throwIfErrors(errors: string[]): void {\r\n  if (errors.length > 0) {\r\n    throw new ServiceError(\r\n      errors.join(', '),\r\n      ServiceErrorType.VALIDATION_ERROR\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Complete validation for funds platforms\r\n */\r\nexport function validateWithdrawalPlatform(attributes: Record<string, any>, currentMinAmount?: number): void {\r\n  const errors = [\r\n    ...validateCommonFields(attributes),\r\n    ...validateAmountFields(attributes, currentMinAmount)\r\n  ];\r\n  \r\n  throwIfErrors(errors);\r\n}\r\n\r\n/**\r\n * Complete validation for deposit platforms\r\n */\r\nexport function validateDepositPlatform(attributes: Record<string, any>, currentMinAmount?: number): void {\r\n  const errors = [\r\n    ...validateCommonFields(attributes),\r\n    ...validateAmountFields(attributes, currentMinAmount),\r\n    ...validateDepositFields(attributes)\r\n  ];\r\n  \r\n  throwIfErrors(errors);\r\n}","import Model from 'flarum/common/Model';\r\nimport { ServiceError, ServiceErrorType } from '../types/services';\r\nimport { validateWithdrawalPlatform } from '../utils/PlatformValidation';\r\nimport { IconRepresentation } from './CurrencyIcon';\r\nimport app from 'flarum/common/app';\r\n\r\n/**\r\n * WithdrawalPlatform model for Flarum\r\n * \r\n * This model represents a funds platform that users can use\r\n * to withdraw their virtual currency with enhanced CRUD capabilities.\r\n */\r\nexport default class WithdrawalPlatform extends Model {\r\n  // Basic attributes\r\n  name = Model.attribute<string>('name');\r\n  symbol = Model.attribute<string>('symbol');\r\n  network = Model.attribute<string | null>('network');\r\n  displayName = Model.attribute<string>('displayName');\r\n  minAmount = Model.attribute<number>('minAmount');\r\n  maxAmount = Model.attribute<number>('maxAmount');\r\n  fee = Model.attribute<number>('fee');\r\n  \r\n  // Three-tier icon system - computed properties\r\n  currencyIconUrl = Model.attribute<string>('currencyIconUrl');\r\n  currencyIconClass = Model.attribute<string>('currencyIconClass');\r\n  currencyUnicodeSymbol = Model.attribute<string>('currencyUnicodeSymbol');\r\n  networkIconUrl = Model.attribute<string>('networkIconUrl');\r\n  networkIconClass = Model.attribute<string>('networkIconClass');\r\n  platformSpecificIconUrl = Model.attribute<string>('platformSpecificIconUrl');\r\n  platformSpecificIconClass = Model.attribute<string>('platformSpecificIconClass');\r\n  \r\n  // Override fields for admin configuration\r\n  currencyIconOverrideUrl = Model.attribute<string>('currencyIconOverrideUrl');\r\n  currencyIconOverrideClass = Model.attribute<string>('currencyIconOverrideClass');\r\n  networkIconOverrideUrl = Model.attribute<string>('networkIconOverrideUrl');\r\n  networkIconOverrideClass = Model.attribute<string>('networkIconOverrideClass');\r\n  \r\n  // Status\r\n  isActive = Model.attribute<boolean>('isActive');\r\n  \r\n  // Timestamps\r\n  createdAt = Model.attribute('createdAt', Model.transformDate);\r\n  updatedAt = Model.attribute('updatedAt', Model.transformDate);\r\n\r\n  // Icon representations from serializer\r\n  bestIcon = Model.attribute<IconRepresentation>('bestIcon');\r\n  currencyIcon = Model.attribute<IconRepresentation>('currencyIcon');\r\n  networkIcon = Model.attribute<IconRepresentation>('networkIcon');\r\n  \r\n  // Computed properties\r\n  apiEndpoint() {\r\n    const id = this.id();\r\n    return id ? `/funds-platforms/${id}` : '/funds-platforms';\r\n  }\r\n  \r\n  // Helper methods\r\n  getDisplayName(): string {\r\n    return this.displayName() || this.name();\r\n  }\r\n  \r\n  isValidAmount(amount: number): boolean {\r\n    const min = this.minAmount();\r\n    const max = this.maxAmount();\r\n    return amount >= min && amount <= max;\r\n  }\r\n  \r\n  getTotalCost(amount: number): number {\r\n    return amount + this.fee();\r\n  }\r\n\r\n  // Enhanced CRUD methods\r\n\r\n  /**\r\n   * Save this platform with enhanced validation\r\n   */\r\n  async save(attributes?: Record<string, any>): Promise<WithdrawalPlatform> {\r\n    // Validate before saving if attributes provided\r\n    if (attributes) {\r\n      this.validateAttributes(attributes);\r\n    }\r\n\r\n    try {\r\n      const result = await super.save(attributes);\r\n      return result as WithdrawalPlatform;\r\n    } catch (error) {\r\n      throw this.handleSaveError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete this platform with permission check\r\n   */\r\n  async delete(): Promise<void> {\r\n    if (!this.canDelete()) {\r\n      throw new ServiceError(\r\n        'You do not have permission to delete this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    // Check if platform is in use\r\n    if (await this.isInUse()) {\r\n      throw new ServiceError(\r\n        'Cannot delete platform that has pending funds requests',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    try {\r\n      await super.delete();\r\n    } catch (error) {\r\n      throw this.handleDeleteError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Toggle platform status\r\n   */\r\n  async toggleStatus(): Promise<WithdrawalPlatform> {\r\n    if (!this.canModify()) {\r\n      throw new ServiceError(\r\n        'You do not have permission to modify this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return await this.save({\r\n      isActive: !this.isActive()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clone this platform for creating a similar one\r\n   */\r\n  clone(): WithdrawalPlatform {\r\n    const cloned = app.store.createRecord('funds-platforms') as WithdrawalPlatform;\r\n    \r\n    // Copy relevant attributes but not id/timestamps\r\n    cloned.pushAttributes({\r\n      name: this.name() + ' (Copy)',\r\n      symbol: this.symbol(),\r\n      network: this.network(),\r\n      minAmount: this.minAmount(),\r\n      maxAmount: this.maxAmount(),\r\n      fee: this.fee(),\r\n      // Copy three-tier icon fields\r\n      currencyIconOverrideUrl: this.currencyIconOverrideUrl(),\r\n      currencyIconOverrideClass: this.currencyIconOverrideClass(),\r\n      networkIconOverrideUrl: this.networkIconOverrideUrl(),\r\n      networkIconOverrideClass: this.networkIconOverrideClass(),\r\n      isActive: false // Clone as inactive by default\r\n    });\r\n\r\n    return cloned;\r\n  }\r\n\r\n  // Validation methods\r\n\r\n  /**\r\n   * Validate amount against platform limits\r\n   */\r\n  validateAmount(amount: number): { valid: boolean; errors: string[] } {\r\n    const errors: string[] = [];\r\n\r\n    if (typeof amount !== 'number' || amount <= 0) {\r\n      errors.push('Amount must be a positive number');\r\n      return { valid: false, errors };\r\n    }\r\n\r\n    if (amount < this.minAmount()) {\r\n      errors.push(`Amount must be at least ${this.minAmount()} ${this.symbol()}`);\r\n    }\r\n\r\n    if (this.maxAmount() && amount > this.maxAmount()) {\r\n      errors.push(`Amount cannot exceed ${this.maxAmount()} ${this.symbol()}`);\r\n    }\r\n\r\n    return { valid: errors.length === 0, errors };\r\n  }\r\n\r\n  /**\r\n   * Check if user has sufficient balance for funds\r\n   */\r\n  validateUserBalance(amount: number, userBalance: number): { valid: boolean; errors: string[] } {\r\n    const errors: string[] = [];\r\n    const totalCost = this.getTotalCost(amount);\r\n\r\n    if (userBalance < totalCost) {\r\n      const feeText = this.fee() > 0 ? ` (including ${this.fee()} ${this.symbol()} fee)` : '';\r\n      errors.push(`Insufficient balance. Required: ${totalCost} ${this.symbol()}${feeText}, Available: ${userBalance} ${this.symbol()}`);\r\n    }\r\n\r\n    return { valid: errors.length === 0, errors };\r\n  }\r\n\r\n  // Permission methods\r\n\r\n  /**\r\n   * Check if current user can modify this platform\r\n   */\r\n  canModify(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can delete this platform\r\n   */\r\n  canDelete(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can view this platform\r\n   */\r\n  canView(): boolean {\r\n    // All authenticated users can view active platforms\r\n    if (this.isActive()) return true;\r\n    \r\n    // Only admins can view inactive platforms\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  // Utility methods\r\n\r\n  /**\r\n   * Check if this platform is currently in use\r\n   */\r\n  async isInUse(): Promise<boolean> {\r\n    try {\r\n      const requests = await app.store.find('funds-requests', {\r\n        filter: { platform: this.id(), status: 'pending' }\r\n      });\r\n      \r\n      const requestsArray = Array.isArray(requests) ? requests : [requests];\r\n      return requestsArray.length > 0;\r\n    } catch {\r\n      // If we can't check, assume it's in use to be safe\r\n      return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get formatted fee display\r\n   */\r\n  getFormattedFee(): string {\r\n    const fee = this.fee();\r\n    if (fee === 0) {\r\n      return 'Free';\r\n    }\r\n    return `${fee} ${this.symbol()}`;\r\n  }\r\n\r\n  /**\r\n   * Get formatted limits display\r\n   */\r\n  getFormattedLimits(): string {\r\n    const min = this.minAmount();\r\n    const max = this.maxAmount();\r\n    const symbol = this.symbol();\r\n\r\n    if (max) {\r\n      return `${min} - ${max} ${symbol}`;\r\n    }\r\n    return `Min: ${min} ${symbol}`;\r\n  }\r\n\r\n  // Private validation methods\r\n\r\n  /**\r\n   * Validate attributes before saving\r\n   */\r\n  private validateAttributes(attributes: Record<string, any>): void {\r\n    validateWithdrawalPlatform(attributes, this.minAmount());\r\n  }\r\n\r\n  /**\r\n   * Handle save errors with proper typing\r\n   */\r\n  private handleSaveError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle Flarum API validation errors\r\n    if (error.response && error.response.errors) {\r\n      const apiError = error.response.errors[0];\r\n      return new ServiceError(\r\n        apiError.detail || 'Failed to save funds platform',\r\n        ServiceErrorType.VALIDATION_ERROR,\r\n        apiError.code,\r\n        apiError\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to save funds platform',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Handle delete errors with proper typing\r\n   */\r\n  private handleDeleteError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle permission errors\r\n    if (error.status === 403 || error.response?.status === 403) {\r\n      return new ServiceError(\r\n        'You do not have permission to delete this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to delete funds platform',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n}","/**\r\n * Shared type definitions for the Withdrawal extension\r\n */\r\n\r\n/**\r\n * Withdrawal platform data structure\r\n */\r\nexport interface WithdrawalPlatformData {\r\n  id: string | number;\r\n  name: string;\r\n  symbol: string;\r\n  minAmount: number;\r\n  maxAmount: number;\r\n  fee: number;\r\n  iconUrl?: string | null;\r\n  iconClass?: string | null;\r\n  isActive: boolean;\r\n  createdAt?: string;\r\n  updatedAt?: string;\r\n}\r\n\r\n/**\r\n * Withdrawal request data structure\r\n */\r\nexport interface WithdrawalRequestData {\r\n  id: string | number;\r\n  amount: number;\r\n  accountDetails: string;\r\n  status: 'pending' | 'approved' | 'rejected';\r\n  platformId: number;\r\n  userId: number;\r\n  createdAt?: string;\r\n  updatedAt?: string;\r\n}\r\n\r\n/**\r\n * User funds data extension\r\n */\r\nexport interface UserWithdrawalData {\r\n  money?: number;\r\n  withdrawalRequests?: WithdrawalRequestData[];\r\n}\r\n\r\n/**\r\n * API response structures\r\n */\r\nexport interface ApiSuccessResponse<T = any> {\r\n  data: T;\r\n}\r\n\r\nexport interface ApiErrorResponse {\r\n  errors: Array<{\r\n    status: string;\r\n    code: string;\r\n    title: string;\r\n    detail?: string;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Form validation errors\r\n */\r\nexport interface ValidationErrors {\r\n  [field: string]: string[];\r\n}\r\n\r\n/**\r\n * Configuration constants\r\n */\r\nexport const WITHDRAWAL_STATUS = {\r\n  PENDING: 'pending',\r\n  APPROVED: 'approved',\r\n  REJECTED: 'rejected',\r\n} as const;\r\n\r\nexport type WithdrawalStatus = typeof WITHDRAWAL_STATUS[keyof typeof WITHDRAWAL_STATUS];\r\n\r\n/**\r\n * Default values\r\n */\r\nexport const DEFAULT_MIN_AMOUNT = 0.001;\r\nexport const DEFAULT_MAX_AMOUNT = 10;\r\nexport const DEFAULT_FEE = 0.0005;\r\n\r\n/**\r\n * Helper type guards\r\n */\r\nexport function isWithdrawalPlatform(obj: any): obj is WithdrawalPlatformData {\r\n  return obj &&\r\n    typeof obj === 'object' &&\r\n    'id' in obj &&\r\n    'name' in obj &&\r\n    'symbol' in obj &&\r\n    'minAmount' in obj &&\r\n    'maxAmount' in obj;\r\n}\r\n\r\nexport function isWithdrawalRequest(obj: any): obj is WithdrawalRequestData {\r\n  return obj &&\r\n    typeof obj === 'object' &&\r\n    'id' in obj &&\r\n    'amount' in obj &&\r\n    'accountDetails' in obj &&\r\n    'status' in obj &&\r\n    'platformId' in obj &&\r\n    'userId' in obj;\r\n}","import Model from 'flarum/common/Model';\r\nimport User from 'flarum/common/models/User';\r\nimport WithdrawalPlatform from './WithdrawalPlatform';\r\nimport { WithdrawalStatus, WITHDRAWAL_STATUS } from '../types';\r\nimport { ServiceError, ServiceErrorType } from '../types/services';\r\nimport app from 'flarum/common/app';\r\n\r\n/**\r\n * WithdrawalRequest model for Flarum\r\n * \r\n * This model represents a user's funds request with enhanced CRUD capabilities.\r\n */\r\nexport default class WithdrawalRequest extends Model {\r\n  // Basic attributes\r\n  amount = Model.attribute<number>('amount');\r\n  accountDetails = Model.attribute<string>('accountDetails');\r\n  message = Model.attribute<string>('message');\r\n  status = Model.attribute<WithdrawalStatus>('status');\r\n  \r\n  // Foreign keys\r\n  platformId = Model.attribute<number>('platformId');\r\n  userId = Model.attribute<number>('userId');\r\n  \r\n  // Timestamps\r\n  createdAt = Model.attribute('createdAt', Model.transformDate);\r\n  updatedAt = Model.attribute('updatedAt', Model.transformDate);\r\n  \r\n  // Relationships\r\n  user = Model.hasOne<User>('user');\r\n  platform = Model.hasOne<WithdrawalPlatform>('platform');\r\n  \r\n  // Computed properties\r\n  apiEndpoint() {\r\n    const id = this.id();\r\n    return id ? `/funds-requests/${id}` : '/funds-requests';\r\n  }\r\n  \r\n  // Status helpers\r\n  isPending(): boolean {\r\n    return this.status() === WITHDRAWAL_STATUS.PENDING;\r\n  }\r\n  \r\n  isApproved(): boolean {\r\n    return this.status() === WITHDRAWAL_STATUS.APPROVED;\r\n  }\r\n  \r\n  isRejected(): boolean {\r\n    return this.status() === WITHDRAWAL_STATUS.REJECTED;\r\n  }\r\n  \r\n  canBeModified(): boolean {\r\n    return this.isPending();\r\n  }\r\n  \r\n  // Display helpers\r\n  statusLabel(): string {\r\n    const status = this.status();\r\n    return app.translator.trans(`funds.forum.status.${status}`).toString();\r\n  }\r\n  \r\n  statusColor(): string {\r\n    const status = this.status();\r\n    switch (status) {\r\n      case WITHDRAWAL_STATUS.APPROVED:\r\n        return 'success';\r\n      case WITHDRAWAL_STATUS.REJECTED:\r\n        return 'danger';\r\n      case WITHDRAWAL_STATUS.PENDING:\r\n      default:\r\n        return 'warning';\r\n    }\r\n  }\r\n\r\n  // Enhanced CRUD methods\r\n\r\n  /**\r\n   * Save this funds request with enhanced validation\r\n   */\r\n  async save(attributes?: Record<string, any>): Promise<WithdrawalRequest> {\r\n    // Validate before saving if attributes provided\r\n    if (attributes) {\r\n      this.validateAttributes(attributes);\r\n    }\r\n\r\n    try {\r\n      const result = await super.save(attributes);\r\n      return result as WithdrawalRequest;\r\n    } catch (error) {\r\n      throw this.handleSaveError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete this funds request with permission check\r\n   */\r\n  async delete(): Promise<void> {\r\n    if (!this.canDelete()) {\r\n      throw new ServiceError(\r\n        'You do not have permission to delete this request',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    // Only check if request can be modified for non-admin users\r\n    const currentUser = app.session.user;\r\n    if (currentUser && !currentUser.isAdmin() && !this.canBeModified()) {\r\n      throw new ServiceError(\r\n        'This request cannot be deleted as it has already been processed',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    try {\r\n      await super.delete();\r\n    } catch (error) {\r\n      throw this.handleDeleteError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clone this request for resubmission\r\n   */\r\n  clone(): WithdrawalRequest {\r\n    const cloned = app.store.createRecord('funds-requests') as WithdrawalRequest;\r\n    \r\n    // Copy relevant attributes but not status/timestamps\r\n    cloned.pushAttributes({\r\n      platformId: this.platformId(),\r\n      amount: this.amount(),\r\n      accountDetails: this.accountDetails(),\r\n      message: this.message()\r\n    });\r\n\r\n    return cloned;\r\n  }\r\n\r\n  /**\r\n   * Get total cost including fees\r\n   */\r\n  getTotalCost(): number {\r\n    const platform = this.platform();\r\n    const fee = platform ? platform.fee() || 0 : 0;\r\n    return this.amount() + fee;\r\n  }\r\n\r\n  /**\r\n   * Get formatted amount string\r\n   */\r\n  getFormattedAmount(): string {\r\n    const platform = this.platform();\r\n    const symbol = platform ? platform.symbol() : '';\r\n    return `${this.amount()} ${symbol}`.trim();\r\n  }\r\n\r\n  /**\r\n   * Get formatted total cost string including fees\r\n   */\r\n  getFormattedTotalCost(): string {\r\n    const platform = this.platform();\r\n    const symbol = platform ? platform.symbol() : '';\r\n    const fee = platform ? platform.fee() || 0 : 0;\r\n    \r\n    if (fee > 0) {\r\n      return `${this.amount()} + ${fee} (fee) = ${this.getTotalCost()} ${symbol}`.trim();\r\n    }\r\n    \r\n    return this.getFormattedAmount();\r\n  }\r\n\r\n  // Permission methods\r\n\r\n  /**\r\n   * Check if current user can modify this request\r\n   */\r\n  canModify(): boolean {\r\n    const currentUser = app.session.user;\r\n    if (!currentUser) return false;\r\n\r\n    // Admin can modify any request\r\n    if (currentUser.isAdmin()) return true;\r\n\r\n    // Users can only modify their own pending requests\r\n    return this.userId() === currentUser.id() && this.canBeModified();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can delete this request\r\n   */\r\n  canDelete(): boolean {\r\n    const currentUser = app.session.user;\r\n    if (!currentUser) return false;\r\n\r\n    // Admin can delete any request\r\n    if (currentUser.isAdmin()) return true;\r\n\r\n    // Users can only delete their own pending requests\r\n    return this.userId() === currentUser.id() && this.canBeModified();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can view this request's details\r\n   */\r\n  canView(): boolean {\r\n    const currentUser = app.session.user;\r\n    if (!currentUser) return false;\r\n\r\n    // Admin can view any request\r\n    if (currentUser.isAdmin()) return true;\r\n\r\n    // Users can only view their own requests\r\n    return this.userId() === currentUser.id();\r\n  }\r\n\r\n  // Validation methods\r\n\r\n  /**\r\n   * Validate attributes before saving\r\n   */\r\n  private validateAttributes(attributes: Record<string, any>): void {\r\n    const errors: string[] = [];\r\n\r\n    if (attributes.amount !== undefined) {\r\n      if (typeof attributes.amount !== 'number' || attributes.amount <= 0) {\r\n        errors.push('Amount must be a positive number');\r\n      }\r\n    }\r\n\r\n    if (attributes.accountDetails !== undefined) {\r\n      if (!attributes.accountDetails || typeof attributes.accountDetails !== 'string') {\r\n        errors.push('Account details are required');\r\n      }\r\n    }\r\n\r\n    if (attributes.platformId !== undefined) {\r\n      if (!attributes.platformId || typeof attributes.platformId !== 'number') {\r\n        errors.push('Platform selection is required');\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      throw new ServiceError(\r\n        errors.join(', '),\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle save errors with proper typing\r\n   */\r\n  private handleSaveError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle Flarum API validation errors\r\n    if (error.response && error.response.errors) {\r\n      const apiError = error.response.errors[0];\r\n      return new ServiceError(\r\n        apiError.detail || 'Failed to save funds request',\r\n        ServiceErrorType.VALIDATION_ERROR,\r\n        apiError.code,\r\n        apiError\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to save funds request',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Handle delete errors with proper typing\r\n   */\r\n  private handleDeleteError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle permission errors\r\n    if (error.status === 403 || error.response?.status === 403) {\r\n      return new ServiceError(\r\n        'You do not have permission to delete this request',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to delete funds request',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n}","import Model from 'flarum/common/Model';\r\nimport { ServiceError, ServiceErrorType } from '../types/services';\r\nimport { validateDepositPlatform } from '../utils/PlatformValidation';\r\nimport { IconRepresentation } from './CurrencyIcon';\r\nimport app from 'flarum/common/app';\r\n\r\nexport default class DepositPlatform extends Model {\r\n  name = Model.attribute<string>('name');\r\n  symbol = Model.attribute<string>('symbol');\r\n  network = Model.attribute<string>('network');\r\n  networkTypeId = Model.attribute('networkTypeId');\r\n  displayName = Model.attribute<string>('displayName');\r\n  minAmount = Model.attribute('minAmount');\r\n  maxAmount = Model.attribute('maxAmount');\r\n  fee = Model.attribute('fee');\r\n  address = Model.attribute('address');\r\n  qrCodeImageUrl = Model.attribute<string>('qrCodeImageUrl');\r\n  // Three-tier icon system - computed properties\r\n  currencyIconUrl = Model.attribute<string>('currencyIconUrl');\r\n  currencyIconClass = Model.attribute<string>('currencyIconClass');\r\n  currencyUnicodeSymbol = Model.attribute<string>('currencyUnicodeSymbol');\r\n  networkIconUrl = Model.attribute<string>('networkIconUrl');\r\n  networkIconClass = Model.attribute<string>('networkIconClass');\r\n  platformSpecificIconUrl = Model.attribute<string>('platformSpecificIconUrl');\r\n  platformSpecificIconClass = Model.attribute<string>('platformSpecificIconClass');\r\n  \r\n  // Override fields for admin configuration\r\n  currencyIconOverrideUrl = Model.attribute<string>('currencyIconOverrideUrl');\r\n  currencyIconOverrideClass = Model.attribute<string>('currencyIconOverrideClass');\r\n  networkIconOverrideUrl = Model.attribute<string>('networkIconOverrideUrl');\r\n  networkIconOverrideClass = Model.attribute<string>('networkIconOverrideClass');\r\n  warningText = Model.attribute<string>('warningText');\r\n  networkConfig = Model.attribute('networkConfig');\r\n  isActive = Model.attribute('isActive');\r\n  createdAt = Model.attribute('createdAt', Model.transformDate);\r\n  updatedAt = Model.attribute('updatedAt', Model.transformDate);\r\n\r\n  // Relationships\r\n  networkType = Model.hasOne('networkType');\r\n\r\n  // Icon representations from serializer\r\n  bestIcon = Model.attribute<IconRepresentation>('bestIcon');\r\n  currencyIcon = Model.attribute<IconRepresentation>('currencyIcon');\r\n  networkIcon = Model.attribute<IconRepresentation>('networkIcon');\r\n\r\n  // Helper methods\r\n  getDisplayName(): string {\r\n    return this.displayName() || this.name();\r\n  }\r\n\r\n  getFullDisplayName(): string {\r\n    const name = this.getDisplayName();\r\n    const network = this.network();\r\n    return network ? `${name} (${network})` : name;\r\n  }\r\n\r\n  isValidAmount(amount: number): boolean {\r\n    const min = this.minAmount() || 0;\r\n    const max = this.maxAmount();\r\n    return amount >= min && (max === null || amount <= max);\r\n  }\r\n\r\n  getTotalCost(amount: number): number {\r\n    return amount + (this.fee() || 0);\r\n  }\r\n\r\n  // Enhanced CRUD methods\r\n\r\n  /**\r\n   * Save this platform with enhanced validation\r\n   */\r\n  async save(attributes?: Record<string, any>): Promise<DepositPlatform> {\r\n    // Validate before saving if attributes provided\r\n    if (attributes) {\r\n      this.validateAttributes(attributes);\r\n    }\r\n\r\n    try {\r\n      const result = await super.save(attributes);\r\n      return result as DepositPlatform;\r\n    } catch (error) {\r\n      throw this.handleSaveError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete this platform with permission check\r\n   */\r\n  async delete(): Promise<void> {\r\n    if (!this.canDelete()) {\r\n      throw new ServiceError(\r\n        'You do not have permission to delete this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    // Check if platform is in use\r\n    if (await this.isInUse()) {\r\n      throw new ServiceError(\r\n        'Cannot delete platform that has pending deposit records',\r\n        ServiceErrorType.VALIDATION_ERROR\r\n      );\r\n    }\r\n\r\n    try {\r\n      await super.delete();\r\n    } catch (error) {\r\n      throw this.handleDeleteError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Toggle platform status\r\n   */\r\n  async toggleStatus(): Promise<DepositPlatform> {\r\n    if (!this.canModify()) {\r\n      throw new ServiceError(\r\n        'You do not have permission to modify this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return await this.save({\r\n      isActive: !this.isActive()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clone this platform for creating a similar one\r\n   */\r\n  clone(): DepositPlatform {\r\n    const cloned = app.store.createRecord('deposit-platforms') as DepositPlatform;\r\n    \r\n    // Copy relevant attributes but not id/timestamps\r\n    cloned.pushAttributes({\r\n      name: this.name() + ' (Copy)',\r\n      symbol: this.symbol(),\r\n      network: this.network(),\r\n      networkTypeId: this.networkTypeId(),\r\n      minAmount: this.minAmount(),\r\n      maxAmount: this.maxAmount(),\r\n      fee: this.fee(),\r\n      address: this.address(),\r\n      qrCodeImageUrl: this.qrCodeImageUrl(),\r\n      iconUrl: this.iconUrl(),\r\n      iconClass: this.iconClass(),\r\n      warningText: this.warningText(),\r\n      isActive: false // Clone as inactive by default\r\n    });\r\n\r\n    return cloned;\r\n  }\r\n\r\n  // Validation methods\r\n\r\n  /**\r\n   * Validate amount against platform limits\r\n   */\r\n  validateAmount(amount: number): { valid: boolean; errors: string[] } {\r\n    const errors: string[] = [];\r\n\r\n    if (typeof amount !== 'number' || amount <= 0) {\r\n      errors.push('Amount must be a positive number');\r\n      return { valid: false, errors };\r\n    }\r\n\r\n    const min = this.minAmount() || 0;\r\n    if (amount < min) {\r\n      errors.push(`Amount must be at least ${min} ${this.symbol()}`);\r\n    }\r\n\r\n    const max = this.maxAmount();\r\n    if (max && amount > max) {\r\n      errors.push(`Amount cannot exceed ${max} ${this.symbol()}`);\r\n    }\r\n\r\n    return { valid: errors.length === 0, errors };\r\n  }\r\n\r\n  // Permission methods\r\n\r\n  /**\r\n   * Check if current user can modify this platform\r\n   */\r\n  canModify(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can delete this platform\r\n   */\r\n  canDelete(): boolean {\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  /**\r\n   * Check if current user can view this platform\r\n   */\r\n  canView(): boolean {\r\n    // All authenticated users can view active platforms\r\n    if (this.isActive()) return true;\r\n    \r\n    // Only admins can view inactive platforms\r\n    const currentUser = app.session.user;\r\n    return currentUser && currentUser.isAdmin();\r\n  }\r\n\r\n  // Utility methods\r\n\r\n  /**\r\n   * Check if this platform is currently in use\r\n   */\r\n  async isInUse(): Promise<boolean> {\r\n    try {\r\n      const records = await app.store.find('deposit-records', {\r\n        filter: { platform: this.id(), status: 'pending' }\r\n      });\r\n      \r\n      const recordsArray = Array.isArray(records) ? records : [records];\r\n      return recordsArray.length > 0;\r\n    } catch {\r\n      // If we can't check, assume it's in use to be safe\r\n      return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get formatted fee display\r\n   */\r\n  getFormattedFee(): string {\r\n    const fee = this.fee() || 0;\r\n    if (fee === 0) {\r\n      return 'Free';\r\n    }\r\n    return `${fee} ${this.symbol()}`;\r\n  }\r\n\r\n  /**\r\n   * Get formatted limits display\r\n   */\r\n  getFormattedLimits(): string {\r\n    const min = this.minAmount() || 0;\r\n    const max = this.maxAmount();\r\n    const symbol = this.symbol();\r\n\r\n    if (max) {\r\n      return `${min} - ${max} ${symbol}`;\r\n    }\r\n    return `Min: ${min} ${symbol}`;\r\n  }\r\n\r\n  /**\r\n   * Generate deposit address for user\r\n   */\r\n  generateDepositAddress(_userId?: number): string {\r\n    const address = this.address();\r\n    \r\n    // For now, we return the static address\r\n    // In the future, this could be enhanced to support dynamic address generation\r\n    if (address) {\r\n      return address;\r\n    }\r\n    \r\n    throw new ServiceError(\r\n      'No deposit address configured for this platform',\r\n      ServiceErrorType.VALIDATION_ERROR\r\n    );\r\n  }\r\n\r\n  // Private validation methods\r\n\r\n  /**\r\n   * Validate attributes before saving\r\n   */\r\n  private validateAttributes(attributes: Record<string, any>): void {\r\n    validateDepositPlatform(attributes, this.minAmount());\r\n  }\r\n\r\n  /**\r\n   * Handle save errors with proper typing\r\n   */\r\n  private handleSaveError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle Flarum API validation errors\r\n    if (error.response && error.response.errors) {\r\n      const apiError = error.response.errors[0];\r\n      return new ServiceError(\r\n        apiError.detail || 'Failed to save deposit platform',\r\n        ServiceErrorType.VALIDATION_ERROR,\r\n        apiError.code,\r\n        apiError\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to save deposit platform',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Handle delete errors with proper typing\r\n   */\r\n  private handleDeleteError(error: any): ServiceError {\r\n    if (error instanceof ServiceError) {\r\n      return error;\r\n    }\r\n\r\n    // Handle permission errors\r\n    if (error.status === 403 || error.response?.status === 403) {\r\n      return new ServiceError(\r\n        'You do not have permission to delete this platform',\r\n        ServiceErrorType.PERMISSION_DENIED\r\n      );\r\n    }\r\n\r\n    return new ServiceError(\r\n      error.message || 'Failed to delete deposit platform',\r\n      ServiceErrorType.SERVER_ERROR\r\n    );\r\n  }\r\n}","import Model from 'flarum/common/Model';\r\nimport User from 'flarum/common/models/User';\r\n\r\nexport default class SimpleDepositRecord extends Model {\r\n  // 属性\r\n  userId = Model.attribute<number>('userId');\r\n  depositAddress = Model.attribute<string>('depositAddress');\r\n  qrCodeUrl = Model.attribute<string>('qrCodeUrl');\r\n  userMessage = Model.attribute<string>('userMessage');\r\n  status = Model.attribute<string>('status');\r\n  statusText = Model.attribute<string>('statusText');\r\n  processedAt = Model.attribute('processedAt', Model.transformDate);\r\n  processedBy = Model.attribute<number>('processedBy');\r\n  adminNotes = Model.attribute<string>('adminNotes');\r\n  createdAt = Model.attribute('createdAt', Model.transformDate);\r\n  updatedAt = Model.attribute('updatedAt', Model.transformDate);\r\n  formattedCreatedAt = Model.attribute<string>('formattedCreatedAt');\r\n  formattedProcessedAt = Model.attribute<string>('formattedProcessedAt');\r\n  isPending = Model.attribute<boolean>('isPending');\r\n  isApproved = Model.attribute<boolean>('isApproved');\r\n  isRejected = Model.attribute<boolean>('isRejected');\r\n\r\n  // 关联\r\n  user = Model.hasOne<User>('user');\r\n  processedByUser = Model.hasOne<User>('processedByUser');\r\n\r\n  // 辅助方法\r\n  getStatusColor(): string {\r\n    switch (this.status()) {\r\n      case 'pending':\r\n        return 'warning';\r\n      case 'approved':\r\n        return 'success';\r\n      case 'rejected':\r\n        return 'danger';\r\n      default:\r\n        return 'secondary';\r\n    }\r\n  }\r\n\r\n  getStatusIcon(): string {\r\n    switch (this.status()) {\r\n      case 'pending':\r\n        return 'fas fa-clock';\r\n      case 'approved':\r\n        return 'fas fa-check-circle';\r\n      case 'rejected':\r\n        return 'fas fa-times-circle';\r\n      default:\r\n        return 'fas fa-question-circle';\r\n    }\r\n  }\r\n\r\n  canEdit(currentUser?: User): boolean {\r\n    if (!currentUser) return false;\r\n    \r\n    // 管理员可以编辑任何记录\r\n    if (currentUser.isAdmin()) return true;\r\n    \r\n    // 用户只能编辑自己的待处理记录\r\n    return this.userId() === currentUser.id() && this.isPending();\r\n  }\r\n\r\n  canDelete(currentUser?: User): boolean {\r\n    if (!currentUser) return false;\r\n    \r\n    // 只有管理员可以删除\r\n    return currentUser.isAdmin();\r\n  }\r\n\r\n  getDisplayAddress(): string {\r\n    const address = this.depositAddress();\r\n    if (address && address.length > 20) {\r\n      return `${address.substring(0, 10)}...${address.substring(address.length - 10)}`;\r\n    }\r\n    return address || '';\r\n  }\r\n\r\n  hasQrCode(): boolean {\r\n    const qrUrl = this.qrCodeUrl();\r\n    return qrUrl !== null && qrUrl !== undefined && qrUrl.trim() !== '';\r\n  }\r\n}","import Component, { ComponentAttrs } from 'flarum/common/Component';\r\nimport app from 'flarum/forum/app';\r\nimport type Mithril from 'mithril';\r\n\r\n/**\r\n * MoneyDisplay component shows the user's money balance with funds button\r\n */\r\nexport default class MoneyDisplay extends Component<ComponentAttrs> {\r\n  view(): Mithril.Children {\r\n    if (!app.session.user) {\r\n      return null;\r\n    }\r\n\r\n    const moneyName: string = app.forum.attribute('antoinefr-money.moneyname') || '[money]';\r\n    const userMoneyText: string = moneyName.replace('[money]', app.session.user.attribute(\"money\"));\r\n    const iconUrl: string | null = app.forum.attribute('wusong8899-funds.moneyIconUrl');\r\n\r\n    return (\r\n      <div\r\n        id=\"moneyDisplayContainer\"\r\n        className=\"client1-header-adv-wrapper clientCustomizeWithdrawalHeaderTotalMoney\"\r\n      >\r\n        <div className=\"clientCustomizeWithdrawalHeaderText\">\r\n          {iconUrl && iconUrl.trim() && (\r\n            <span style={{  \r\n              borderRadius: '50%', \r\n              padding: '6px 8px', \r\n              marginRight: '8px',\r\n              display: 'inline-flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'center'\r\n            }}>\r\n              <img \r\n                src={iconUrl} \r\n                alt=\"Money icon\" \r\n                style={{ \r\n                  width: '20px', \r\n                  height: '20px'\r\n                }}\r\n                onError={(e: Event) => {\r\n                  // Hide image if it fails to load\r\n                  const target = e.target as HTMLImageElement;\r\n                  target.style.display = 'none';\r\n                }}\r\n              />\r\n            </span>\r\n          )}\r\n          {userMoneyText}\r\n        </div>\r\n        \r\n        <div className=\"clientCustomizeWithdrawalHeaderIcon\">\r\n          <i className=\"fas fa-wallet\" />\r\n        </div>\r\n\r\n        <div className=\"clientCustomizeWithdrawalButtons\">\r\n          <div\r\n            className=\"clientCustomizeWithdrawalButton\"\r\n            onclick={this.handleWithdrawalClick.bind(this)}\r\n            title=\"提款\"\r\n          >\r\n            <i className=\"fas fa-money-bill-transfer\" />\r\n            <span style={{ marginLeft: '4px', fontSize: '12px' }}>提款</span>\r\n          </div>\r\n          <div\r\n            className=\"clientCustomizeDepositButton\"\r\n            onclick={this.handleDepositClick.bind(this)}\r\n            title=\"存款\"\r\n            style={{ marginLeft: '8px' }}\r\n          >\r\n            <i className=\"fas fa-coins\" />\r\n            <span style={{ marginLeft: '4px', fontSize: '12px' }}>存款</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Handle funds button click\r\n   */\r\n  private handleWithdrawalClick(e: Event): void {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    // Navigate to funds page with funds tab\r\n    window.location.href = '/funds?tab=funds';\r\n  }\r\n\r\n  /**\r\n   * Handle deposit button click\r\n   */\r\n  private handleDepositClick(e: Event): void {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    // Navigate to funds page with deposit tab\r\n    window.location.href = '/funds?tab=deposit';\r\n  }\r\n}","import Component, { ComponentAttrs } from 'flarum/common/Component';\r\nimport app from 'flarum/forum/app';\r\nimport type Mithril from 'mithril';\r\n\r\n/**\r\n * MobileMoneyDisplay component for mobile navigation bar\r\n * Shows user's money balance with funds button in mobile navigation\r\n */\r\nexport default class MobileMoneyDisplay extends Component<ComponentAttrs> {\r\n  view(): Mithril.Children {\r\n    // Note: Mobile detection and user authentication are now handled in index.ts\r\n    // This component assumes it should render when called\r\n    const userMoney = app.session.user?.attribute('money') || 0;\r\n    const iconUrl: string | null = app.forum.attribute('wusong8899-funds.moneyIconUrl');\r\n\r\n    return (\r\n      <div className=\"Navigation-mobileMoneyDisplay\">\r\n        <div \r\n          className=\"Navigation-moneySection\"\r\n          onclick={this.handleWithdrawalClick.bind(this)}\r\n          title={`余额: ${userMoney} - 点击提款`}\r\n        >\r\n          {/* 货币图标和金额显示 */}\r\n          <div className=\"Navigation-moneyText\">\r\n            {iconUrl && iconUrl.trim() && (\r\n              <span style={{  \r\n                borderRadius: '50%', \r\n                padding: '4px 6px', \r\n                marginRight: '6px',\r\n                display: 'inline-flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center'\r\n              }}>\r\n                <img \r\n                  src={iconUrl} \r\n                  alt=\"Money icon\" \r\n                  style={{ \r\n                    width: '18px', \r\n                    height: '18px'\r\n                  }}\r\n                  onError={(e: Event) => {\r\n                    // Hide image if it fails to load\r\n                    const target = e.target as HTMLImageElement;\r\n                    target.style.display = 'none';\r\n                  }}\r\n                />\r\n              </span>\r\n            )}\r\n            <span className=\"Navigation-moneyAmount\">{userMoney}</span>\r\n          </div>\r\n          \r\n          {/* 提款按钮 */}\r\n          <div className=\"Navigation-withdrawalButton\">\r\n            <i className=\"fas fa-money-bill-transfer\" />\r\n            <span>提款</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Handle funds button click\r\n   */\r\n  private handleWithdrawalClick(e: Event): void {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    console.log('MobileMoneyDisplay clicked!'); // 调试日志\r\n    \r\n    try {\r\n      // Navigate to unified funds page with funds tab\r\n      window.location.href = '/funds?tab=funds';\r\n    } catch (error) {\r\n      console.error('Navigation error:', error);\r\n      // 备用方案\r\n      window.location.href = '/funds?tab=funds';\r\n    }\r\n  }\r\n}","import app from 'flarum/forum/app';\r\n\r\n/**\r\n * ConfigManager utility for flarum-funds extension\r\n */\r\nexport class ConfigManager {\r\n  private static instance: ConfigManager;\r\n\r\n  private constructor() {}\r\n\r\n  public static getInstance(): ConfigManager {\r\n    if (!ConfigManager.instance) {\r\n      ConfigManager.instance = new ConfigManager();\r\n    }\r\n    return ConfigManager.instance;\r\n  }\r\n\r\n  /**\r\n   * Check if current page is the tags page (main forum page)\r\n   */\r\n  public isTagsPage(): boolean {\r\n    try {\r\n      const routeName = app.current?.get('routeName');\r\n      return routeName === 'index';\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n}","/**\n * Check if the current device is mobile based on screen width\n */\nexport function isMobile(): boolean {\n  return window.innerWidth <= 767;\n}\n\n/**\n * Check if the current device is tablet\n */\nexport function isTablet(): boolean {\n  return window.innerWidth >= 768 && window.innerWidth <= 1024;\n}\n\n/**\n * Check if the current device is desktop\n */\nexport function isDesktop(): boolean {\n  return window.innerWidth > 1024;\n}\n\n/**\n * Check if the current device is mobile or tablet\n */\nexport function isMobileOrTablet(): boolean {\n  return isMobile() || isTablet();\n}\n\n/**\n * Get the current breakpoint\n */\nexport function getCurrentBreakpoint(): 'mobile' | 'tablet' | 'desktop' {\n  if (isMobile()) return 'mobile';\n  if (isTablet()) return 'tablet';\n  return 'desktop';\n}\n\n/**\n * Check if touch is supported\n */\nexport function isTouchDevice(): boolean {\n  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n}\n\n// For backward compatibility\nexport const MobileDetector = {\n  isMobile,\n  isTablet,\n  isDesktop,\n  isMobileOrTablet,\n  getCurrentBreakpoint,\n  isTouchDevice\n};","import app from 'flarum/forum/app';\r\nimport { extend } from 'flarum/common/extend';\r\nimport HeaderPrimary from 'flarum/forum/components/HeaderPrimary';\r\nimport Navigation from 'flarum/common/components/Navigation';\r\nimport FundsPage from './components/FundsPage';\r\nimport WithdrawalPlatform from '../common/models/WithdrawalPlatform';\r\nimport WithdrawalRequest from '../common/models/WithdrawalRequest';\r\nimport DepositPlatform from '../common/models/DepositPlatform';\r\nimport DepositRecord from '../common/models/DepositRecord';\r\nimport MoneyDisplay from './components/MoneyDisplay';\r\nimport MobileMoneyDisplay from './components/MobileMoneyDisplay';\r\nimport { ConfigManager } from './utils/ConfigManager';\r\nimport { MobileDetector } from './utils/MobileDetector';\r\n\r\napp.initializers.add('wusong8899-funds', () => {\r\n  // Register models in store\r\n  app.store.models['funds-platforms'] = WithdrawalPlatform;\r\n  app.store.models['funds-requests'] = WithdrawalRequest;\r\n  app.store.models['deposit-platforms'] = DepositPlatform;\r\n  app.store.models['deposit-records'] = DepositRecord;\r\n  app.store.models['deposit-records-simple'] = DepositRecord;\r\n\r\n  // New unified funds page\r\n  app.routes.funds = { path: '/funds', component: FundsPage };\r\n  \r\n  // Legacy routes for backward compatibility - redirect to funds page\r\n  app.routes.funds = { path: '/funds', component: FundsPage };\r\n  app.routes.deposit = { path: '/deposit', component: FundsPage };\r\n\r\n\r\n  // Add money display to header primary (desktop)\r\n  extend(HeaderPrimary.prototype, 'view', function (vnode) {\r\n    // Only add on tags page for logged-in users and on desktop\r\n    const configManager = ConfigManager.getInstance();\r\n    if (app.session.user && configManager.isTagsPage() && !MobileDetector.isMobile()) {\r\n      // Add money display to the header primary view\r\n      vnode.children.push(MoneyDisplay.component());\r\n    }\r\n  });\r\n\r\n  // Add mobile money display to navigation using component extension\r\n  extend(Navigation.prototype, 'view', function (vnode) {\r\n    // Only work on mobile devices (viewport width <= 768px)\r\n    if (window.innerWidth > 768) {\r\n      return;\r\n    }\r\n\r\n    // Only work on homepage\r\n    const routeName = app.current.get('routeName');\r\n    if (routeName !== 'tags') {\r\n      return;\r\n    }\r\n\r\n    // Only work for logged-in users\r\n    if (!app.session.user) {\r\n      return;\r\n    }\r\n\r\n    if (!vnode || !vnode.children || !Array.isArray(vnode.children)) {\r\n      return;\r\n    }\r\n\r\n    // Check if we already added the money display component to avoid duplication\r\n    const hasMoneyDisplay = vnode.children.some((child: any) =>\r\n      child && child.attrs && child.attrs.className &&\r\n      child.attrs.className.includes('Navigation-mobileMoneyDisplay')\r\n    );\r\n\r\n    if (!hasMoneyDisplay) {\r\n      // Add MobileMoneyDisplay component to navigation\r\n      vnode.children.push(MobileMoneyDisplay.component({\r\n        className: \"item-funds Navigation-mobileMoneyDisplay\"\r\n      }));\r\n    }\r\n  });\r\n});"],"names":["STATUS_CLASS_MAP","DEFAULTS","ICONS","getBestPlatformIcon","platform","platformIconUrl","platformIconClass","networkIconUrl","networkIconClass","currencyIconUrl","currencyIconClass","currencyUnicodeSymbol","renderIcon","iconRep","additionalClasses","baseClasses","classes","PlatformIcon","vnode","className","size","icon","finalClasses","bestIcon","getId","obj","getAttr","attr","getIdString","findPlatformById","platforms","platformId","platformIdStr","p","pId","getDateFromAttr","dateStr","PlatformSelector","Component","selectedPlatform","showDropdown","validPlatforms","app","onPlatformSelect","onAmountChange","AmountInput","amount","loadingBalance","onFillAllAmount","minAmount","maxAmount","fee","e","Button","AddressInput","accountDetails","onAccountDetailsChange","symbol","m","text","error","MessageInput","message","onMessageChange","SubmitButton","submitting","canSubmit","onSubmit","numericAmount","finalAmount","WithdrawalForm","formData","onFormDataChange","StatusBadge","status","statusClass","statusLabel","EmptyState","iconName","title","description","LoadingState","props","LoadingIndicator","TransactionHistory","transactions","loading","type","transaction","transactionId","statusColor","createdAt","platformAccount","realName","depositTime","screenshotUrl","userMessage","processedAt","adminNotes","creditedAmount","humanTime","iconUrl","iconClass","DepositForm","Stream","withAttr","qrCodeUrl","url","DepositServiceImpl","data","response","record","filters","params","recordId","depositService","ServiceErrorType","ServiceError","code","details","WithdrawalService","options","queryParams","results","id","attributes","model","userId","targetUserId","queryOptions","request","reason","currentUser","userBalance","totalRequired","required","field","defaultMessage","apiError","withdrawalService","PlatformService","modelType","currentStatus","config","errors","requestType","records","recordArray","r","sum","grouped","sortBy","direction","sortString","_platform","platformService","extractErrorMessage","fallback","firstError","FundsPage","Page","tabParam","tab","subTab","mainTab","currentTab","newUrl","titleKey","activeTab","activeSubTab","depositRecords","currentSubTab","availableAmount","amountNum","errorMessage","requests","forceRefresh","updatedUser","validateCommonFields","validateAmountFields","currentMinAmount","validateDepositFields","throwIfErrors","validateWithdrawalPlatform","validateDepositPlatform","WithdrawalPlatform","Model","min","max","cloned","totalCost","feeText","WITHDRAWAL_STATUS","WithdrawalRequest","DepositPlatform","name","network","_userId","address","SimpleDepositRecord","qrUrl","MoneyDisplay","userMoneyText","target","MobileMoneyDisplay","userMoney","ConfigManager","isMobile","isTablet","isDesktop","isMobileOrTablet","getCurrentBreakpoint","isTouchDevice","MobileDetector","DepositRecord","extend","HeaderPrimary","configManager","Navigation","child"],"mappings":"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"}