(function(f,a,r,X,B,k,b,I,A,$,p,L,F,c){"use strict";const Ft="modulepreload",Tt=function(l){return"/"+l},Ct={},D=function(t,e,s){let n=Promise.resolve();function o(i){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=i,window.dispatchEvent(u),!u.defaultPrevented)throw i}return n.then(i=>{for(const u of i||[])u.status==="rejected"&&o(u.reason);return t().catch(o)})};class T extends k{className(){return"ConfirmModal"}title(){const{title:t,dangerous:e=!1,icon:s=e?"fas fa-exclamation-triangle":"fas fa-question-circle"}=this.attrs;return m("span",null,s&&m("span",{className:`ConfirmModal-icon ${e?"dangerous":""}`},I(s)),t)}content(){const{message:t,confirmText:e="Confirm",cancelText:s="Cancel",onConfirm:n,onCancel:o,dangerous:i=!1}=this.attrs;return m("div",{className:"Modal-body"},m("div",{className:"ConfirmModal-message"},t),m("div",{className:"Form-group"},m("div",{className:"ButtonGroup"},m(b,{className:"Button",onclick:()=>{o(),f.modal.close()}},s),m(b,{className:`Button Button--${i?"danger":"primary"}`,onclick:()=>{n(),f.modal.close()}},e))))}}class tt extends X{constructor(){super(),this.platforms=[],this.transactions=[],this.loading=!0,this.submittingPlatform=!1;const t=this.getConfig();this.activeTab=t.tabs[0]?.key||""}oninit(t){super.oninit(t),this.loadData()}content(){if(this.loading)return r(B,null);const t=this.getConfig();return r("div",{className:`${t.extensionId}ManagementPage`},r("div",{className:"container"},r("h2",null,t.pageTitle),t.settingsComponent&&r("div",{className:"SettingsSection"},r(t.settingsComponent,{onSettingChange:this.saveSetting.bind(this)})),t.tabs.length>1&&r("div",{className:"AdminTabs"},r("div",{className:"AdminTabs-nav"},t.tabs.map(e=>r("button",{key:e.key,className:`AdminTabs-tab ${this.activeTab===e.key?"active":""}`,onclick:()=>{this.activeTab=e.key}},e.label))),r("div",{className:"AdminTabs-content"},this.renderActiveTabContent())),t.tabs.length===1&&r("div",{className:"SingleTabContent"},this.renderActiveTabContent())))}renderActiveTabContent(){const t=this.getConfig(),e=t.tabs.find(n=>n.key===this.activeTab);if(!e)return null;const s={platforms:this.platforms,transactions:this.transactions,submittingPlatform:this.submittingPlatform,onAddPlatform:this.addPlatform.bind(this),onEditPlatform:this.editPlatform.bind(this),onTogglePlatformStatus:this.togglePlatformStatus.bind(this),onDeletePlatform:this.deletePlatform.bind(this),...t.transactionOperations&&{onUpdateTransactionStatus:this.updateTransactionStatus.bind(this)},...e.props?e.props():{}};return r(e.component,s)}async addPlatform(t){if(this.submittingPlatform)return;this.submittingPlatform=!0;const e=this.getConfig();try{await e.platformOperations.create(t),await this.loadPlatforms()}catch(s){console.error("Error adding platform:",s)}finally{this.submittingPlatform=!1,r.redraw()}}async togglePlatformStatus(t){const e=this.getConfig();try{await e.platformOperations.toggleStatus(t),await this.loadPlatforms(),r.redraw()}catch(s){console.error("Error toggling platform status:",s)}}async editPlatform(t,e){const s=this.getConfig();if(!s.platformOperations.update){console.error("Platform update operation not supported"),a.alerts.show({type:"error",dismissible:!0},"Platform update operation not supported");return}try{const n=this.platforms.find(o=>(typeof o.id=="function"?o.id():o.id)===t);if(!n)throw new Error("Platform not found");await s.platformOperations.update(n,e),await this.loadPlatforms(),r.redraw()}catch(n){throw console.error("Error editing platform:",n),a.alerts.show({type:"error",dismissible:!0},a.translator.trans(`${s.translations.platformPrefix}.edit_error`)),n}}deletePlatform(t){const e=this.getConfig(),s=(typeof t.name=="function"?t.name():t.name)||"Unknown Platform";a.modal.show(T,{title:a.translator.trans(`${e.translations.platformPrefix}.delete_confirm_title`),message:a.translator.trans(`${e.translations.platformPrefix}.delete_confirm_message`,{name:s}),confirmText:a.translator.trans(`${e.translations.platformPrefix}.delete_confirm_button`),cancelText:a.translator.trans(`${e.translations.platformPrefix}.delete_cancel_button`),dangerous:!0,icon:"fas fa-trash",onConfirm:async()=>{try{await e.platformOperations.delete(t),await this.loadPlatforms(),r.redraw(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans(`${e.translations.platformPrefix}.delete_success`))}catch(n){console.error("Error deleting platform:",n),a.alerts.show({type:"error",dismissible:!0},a.translator.trans(`${e.translations.platformPrefix}.delete_error`))}},onCancel:()=>{a.modal.close()}})}async updateTransactionStatus(t,e){const s=this.getConfig();if(s.transactionOperations)try{await s.transactionOperations.updateStatus(t,e),await this.loadTransactions();const n=s.translations.transactionPrefix||s.translations.platformPrefix;a.alerts.show({type:"success",dismissible:!0},a.translator.trans(`${n}.${e}_success`))}catch(n){console.error("Error updating transaction:",n);const o=s.translations.transactionPrefix||s.translations.platformPrefix;a.alerts.show({type:"error",dismissible:!0},a.translator.trans(`${o}.update_error`))}}async loadData(){try{await this.loadPlatforms(),this.getConfig().transactionOperations&&await this.loadTransactions()}catch(t){console.error("Error loading data:",t)}finally{this.loading=!1,r.redraw()}}async loadPlatforms(){const t=this.getConfig();try{this.platforms=await t.platformOperations.load(),console.log("Loaded platforms:",this.platforms)}catch(e){console.error("Error loading platforms:",e),this.platforms=[]}}async loadTransactions(){const t=this.getConfig();if(t.transactionOperations)try{this.transactions=await t.transactionOperations.load(),console.log("Loaded transactions:",this.transactions)}catch(e){console.error("Error loading transactions:",e),this.transactions=[]}}async saveSetting(t,e){try{const{settingsService:s}=await D(async()=>{const{settingsService:n}=await Promise.resolve().then(()=>yt);return{settingsService:n}},void 0);await s.saveSetting(t,e)}catch(s){console.error("Error saving setting:",s),a.alerts.show({type:"error",dismissible:!0},s instanceof Error?s.message:"Failed to save setting")}}}class et extends A{view(){return m("div",{className:"WithdrawalManagementPage-section"},m("h3",null,"General Settings"),m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.settings.money_icon_url")),m("input",{type:"url",className:"FormControl",placeholder:"https://i.mji.rip/2025/08/28/cd18932c68e9bbee9502b1fb6317cba9.png",value:a.forum.attribute("wusong8899-funds.moneyIconUrl")||"",oninput:$("value",t=>this.attrs.onSettingChange("wusong8899-funds.moneyIconUrl",t))}),m("small",{className:"helpText"},a.translator.trans("funds.admin.settings.money_icon_url_help")))))}}class C{constructor(){this.errors=[]}required(t,e,s){return(!t||typeof t=="string"&&t.trim()==="")&&this.errors.push({field:e,message:`${s||e} is required`}),this}minLength(t,e,s,n){return t&&t.length<e&&this.errors.push({field:s,message:`${n||s} must be at least ${e} characters`}),this}numberRange(t,e,s,n,o){const i=typeof t=="string"?parseFloat(t):t;return isNaN(i)?(this.errors.push({field:n||"number",message:`${o||"Value"} must be a valid number`}),this):(e!==void 0&&i<e&&this.errors.push({field:n||"number",message:`${o||"Value"} must be at least ${e}`}),s!==void 0&&i>s&&this.errors.push({field:n||"number",message:`${o||"Value"} must be at most ${s}`}),this)}url(t,e,s){if(t&&t.trim())try{const n=new URL(t)}catch{this.errors.push({field:e,message:`${s||e} must be a valid URL`})}return this}custom(t,e,s){return t||this.errors.push({field:e,message:s}),this}getResult(){return{isValid:this.errors.length===0,errors:this.errors,firstErrorMessage:this.errors.length>0?this.errors[0].message:void 0}}reset(){return this.errors=[],this}}class st extends A{constructor(){super(...arguments),this.name=p(""),this.symbol=p(""),this.network=p(""),this.minAmount=p(""),this.maxAmount=p(""),this.fee=p(""),this.isActive=p(!0),this.platformIconUrl=p(""),this.platformIconClass=p("")}view(){return r("div",{className:"WithdrawalManagementPage-addPlatform"},r("div",{className:"Form-group"},r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.name")),r("input",{type:"text",className:"FormControl",placeholder:a.translator.trans("funds.admin.platforms.add_placeholder"),bidi:this.name})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.symbol")),r("input",{type:"text",className:"FormControl",placeholder:"BTC, ETH, USDT...",bidi:this.symbol})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.network")),r("input",{type:"text",className:"FormControl",placeholder:"TRC20, ERC20, BSC... (optional)",bidi:this.network}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.network_help")))),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.min_amount")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"0.001",bidi:this.minAmount})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.max_amount")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"10.0",bidi:this.maxAmount})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.fee")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"0.0005",bidi:this.fee}))),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",{className:"checkbox"},r("input",{type:"checkbox",checked:this.isActive(),onchange:t=>{const e=t.target;this.isActive(e.checked)}}),a.translator.trans("funds.admin.platforms.is_active")))),r("div",{className:"Form-section"},r("h4",null,a.translator.trans("funds.admin.platforms.platform_icon")),r("p",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_help")),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_url")),r("input",{type:"url",className:"FormControl",placeholder:"https://example.com/platform-icon.png",bidi:this.platformIconUrl}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_url_help"))),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_class")),r("input",{type:"text",className:"FormControl",placeholder:"fab fa-bitcoin",bidi:this.platformIconClass}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_class_help"))))),r("div",{className:"Form-group"},r(b,{className:"Button Button--primary",loading:this.attrs.submitting,disabled:this.attrs.submitting,onclick:this.handleSubmit.bind(this)},a.translator.trans("funds.admin.platforms.add_button")))))}validateForm(){const t=new C;try{const e=a.translator.trans("funds.admin.platforms.name").toString(),s=a.translator.trans("funds.admin.platforms.symbol").toString(),n=a.translator.trans("funds.admin.platforms.min_amount").toString(),o=a.translator.trans("funds.admin.platforms.max_amount").toString(),i=a.translator.trans("funds.admin.platforms.fee").toString();t.required(this.name(),"name",e).required(this.symbol(),"symbol",s).numberRange(this.minAmount(),0,void 0,"minAmount",n).numberRange(this.maxAmount(),0,void 0,"maxAmount",o).numberRange(this.fee(),0,void 0,"fee",i);const u=parseFloat(this.minAmount());if(parseFloat(this.maxAmount())<u){const y=a.translator.trans("funds.admin.platforms.max_min_error").toString();t.custom(!1,"maxAmount",y)}if(this.platformIconUrl()&&this.platformIconUrl().trim()){const y=a.translator.trans("funds.admin.platforms.platform_icon_url").toString();t.url(this.platformIconUrl(),"platformIconUrl",y)}const g=t.getResult();return!g.isValid&&g.firstErrorMessage&&a.alerts.show({type:"error",dismissible:!0},g.firstErrorMessage),g.isValid}catch(e){return console.error("Form validation error:",e),a.alerts.show({type:"error",dismissible:!0},"Validation failed"),!1}}async handleSubmit(){if(this.attrs.submitting||!this.validateForm())return;const t={name:this.name(),symbol:this.symbol(),network:this.network(),minAmount:this.minAmount(),maxAmount:this.maxAmount(),fee:this.fee(),isActive:this.isActive(),platformIconUrl:this.platformIconUrl(),platformIconClass:this.platformIconClass()};try{await this.attrs.onSubmit(t),this.clearForm()}catch{}}clearForm(){this.name(""),this.symbol(""),this.network(""),this.minAmount(""),this.maxAmount(""),this.fee(""),this.isActive(!0),this.platformIconUrl(""),this.platformIconClass(""),r.redraw()}}class W extends A{view(t){const{platform:e,type:s,onToggleStatus:n,onDelete:o,onEditPlatform:i,style:u="card"}=t.attrs;return u==="card"?this.renderCardStyle(e,s,n,o,i):this.renderListStyle(e,s,n,o,i)}renderCardStyle(t,e,s,n,o){const i=this.extractPlatformData(t),u=e==="funds"||e==="withdrawal"?"funds.admin.platforms":"funds.admin.deposit.platforms";return r("div",{key:i.id,className:`${e}Platform`},r("div",{className:`${e}Platform-info`},r("div",{className:`${e}Platform-primary`},r("span",{className:`${e}Platform-status ${i.isActive?"active":"inactive"}`},i.isActive?"🟢":"🔴"),r("span",{className:`${e}Platform-name`},i.displayName),r("span",{className:"platform-id"},"#",i.id),i.network&&r("span",{className:`${e}Platform-network`},"(",i.network,")")),r("div",{className:`${e}Platform-details`},r("span",{className:`${e}Platform-amounts`},"Min: ",i.minAmount," | Max: ",i.maxAmount,` | Fee: ${i.fee}`,e==="deposit"&&` | Address: ${i.address?"Static":"Template"}`),i.createdDate&&r("span",{className:`${e}Platform-date`},i.dateDisplay))),r("div",{className:`${e}Platform-actions`},r(b,{className:`Button ${i.isActive?"Button--secondary":"Button--primary"}`,onclick:()=>s(t)},a.translator.trans(`${u}.${i.isActive?"disable":"enable"}`)),o&&r(b,{className:"Button Button--secondary",onclick:()=>o(t)},a.translator.trans(`${u}.edit`)),r(b,{className:"Button Button--danger",onclick:()=>n(t)},a.translator.trans(`${u}.delete`))))}renderListStyle(t,e,s,n,o){const i=this.extractPlatformData(t),u=e==="funds"||e==="withdrawal"?"funds.admin.platforms":"funds.admin.deposit.platforms";return r("div",{className:`${e}PlatformListItem`},r("div",{className:`${e}PlatformListItem-content`},r("div",{className:`${e}PlatformListItem-icon`},this.renderPlatformIcon(t)),r("div",{className:`${e}PlatformListItem-info`},r("div",{className:`${e}PlatformListItem-primary`},r("strong",null,i.name),r("span",{className:`${e}PlatformListItem-displayName`},i.symbol,i.network&&` (${i.network})`)),r("div",{className:`${e}PlatformListItem-details`},r("span",{className:`${e}PlatformListItem-detail`},"Min: ",i.minAmount," ",i.symbol),i.maxAmount&&r("span",{className:`${e}PlatformListItem-detail`},"Max: ",i.maxAmount," ",i.symbol),i.fee&&r("span",{className:`${e}PlatformListItem-detail`},"Fee: ",i.fee," ",i.symbol),e==="deposit"&&r("span",{className:`${e}PlatformListItem-detail`},"Address: ",i.address?"Static":"Template"))),r("div",{className:`${e}PlatformListItem-actions`},r(L,{state:i.isActive,onchange:async()=>{await s(t),r.redraw()}},i.isActive?a.translator.trans(`${u}.active`):a.translator.trans(`${u}.inactive`)),o&&r(b,{className:"Button Button--icon Button--flat",icon:"fas fa-edit",onclick:()=>o(t),title:a.translator.trans(`${u}.edit`)}),r(b,{className:"Button Button--icon Button--flat",icon:"fas fa-trash",onclick:async()=>{await n(t),r.redraw()},title:a.translator.trans(`${u}.delete`)}))))}extractPlatformData(t){const e=typeof t.id=="function"?t.id():t.id,s=(typeof t.name=="function"?t.name():t.data?.attributes?.name)||"Unknown Platform",n=(typeof t.symbol=="function"?t.symbol():t.data?.attributes?.symbol)||"",o=(typeof t.network=="function"?t.network():t.data?.attributes?.network)||null,i=(typeof t.displayName=="function"?t.displayName():t.data?.attributes?.displayName)||s,u=(typeof t.minAmount=="function"?t.minAmount():t.data?.attributes?.minAmount)||"N/A",w=(typeof t.maxAmount=="function"?t.maxAmount():t.data?.attributes?.maxAmount)||"N/A",g=(typeof t.fee=="function"?t.fee():t.data?.attributes?.fee)||"N/A",y=(typeof t.address=="function"?t.address():t.data?.attributes?.address)||null,v=(typeof t.isActive=="function"?t.isActive():t.data?.attributes?.isActive)??!1,_=(typeof t.createdAt=="function"?t.createdAt():t.data?.attributes?.createdAt)||null;let S="N/A";if(_)try{S=F(_)}catch(O){console.error("Error formatting date:",O),S="Invalid Date"}return{id:e,name:s,symbol:n,network:o,displayName:i,minAmount:u,maxAmount:w,fee:g,address:y,isActive:v,createdDate:_,dateDisplay:S}}renderPlatformIcon(t){const e=typeof t.iconUrl=="function"?t.iconUrl():t.attributes?.iconUrl,s=typeof t.iconClass=="function"?t.iconClass():t.attributes?.iconClass,n=typeof t.symbol=="function"?t.symbol():t.attributes?.symbol;return e?r("img",{src:e,alt:n,className:"PlatformListItem-img"}):I(s||"fas fa-coins")}}class rt extends k{constructor(){super(...arguments),this.name=p(""),this.symbol=p(""),this.network=p(""),this.minAmount=p(""),this.maxAmount=p(""),this.fee=p(""),this.isActive=p(!0),this.platformIconUrl=p(""),this.platformIconClass=p(""),this.submitting=!1}className(){return"EditPlatformModal Modal--medium"}title(){return a.translator.trans("funds.admin.platforms.edit_title")}oninit(t){super.oninit(t),this.populateForm()}populateForm(){const{platform:t}=this.attrs;this.name(t.name()||""),this.symbol(t.symbol()||""),this.network(t.network()||""),this.minAmount(t.minAmount()?.toString()||""),this.maxAmount(t.maxAmount()?.toString()||""),this.fee(t.fee()?.toString()||""),this.isActive(t.isActive()??!0),this.platformIconUrl(t.platformIconUrl()||""),this.platformIconClass(t.platformIconClass()||"")}content(){return r("div",{className:"Modal-body"},r("div",{className:"Form"},r("div",{className:"Form-group"},r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.name")),r("input",{type:"text",className:"FormControl",placeholder:a.translator.trans("funds.admin.platforms.add_placeholder"),bidi:this.name})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.symbol")),r("input",{type:"text",className:"FormControl",placeholder:"BTC, ETH, USDT...",bidi:this.symbol})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.network")),r("input",{type:"text",className:"FormControl",placeholder:"TRC20, ERC20, BSC... (optional)",bidi:this.network}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.network_help")))),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.min_amount")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"0.001",bidi:this.minAmount})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.max_amount")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"10.0",bidi:this.maxAmount})),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.fee")),r("input",{type:"number",step:"0.00000001",className:"FormControl",placeholder:"0.0005",bidi:this.fee}))),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",{className:"checkbox"},r("input",{type:"checkbox",checked:this.isActive(),onchange:t=>{const e=t.target;this.isActive(e.checked)}}),a.translator.trans("funds.admin.platforms.is_active")))),r("div",{className:"Form-section"},r("h4",null,a.translator.trans("funds.admin.platforms.platform_icon")),r("p",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_help")),r("div",{className:"Form-row"},r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_url")),r("input",{type:"url",className:"FormControl",placeholder:"https://example.com/platform-icon.png",bidi:this.platformIconUrl}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_url_help"))),r("div",{className:"Form-col"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_class")),r("input",{type:"text",className:"FormControl",placeholder:"fab fa-bitcoin",bidi:this.platformIconClass}),r("small",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_class_help"))))),r("div",{className:"Form-group"},r(b,{className:"Button Button--primary",type:"submit",loading:this.submitting,disabled:this.submitting},a.translator.trans("funds.admin.platforms.edit_button")),r(b,{className:"Button Button--secondary",onclick:this.hide.bind(this),disabled:this.submitting},a.translator.trans("core.admin.basics.cancel_button"))))))}onsubmit(t){t.preventDefault(),this.handleEdit()}validateForm(){const t=new C;try{const e=a.translator.trans("funds.admin.platforms.name").toString(),s=a.translator.trans("funds.admin.platforms.symbol").toString(),n=a.translator.trans("funds.admin.platforms.min_amount").toString(),o=a.translator.trans("funds.admin.platforms.max_amount").toString(),i=a.translator.trans("funds.admin.platforms.fee").toString();t.required(this.name(),"name",e).required(this.symbol(),"symbol",s).numberRange(this.minAmount(),0,void 0,"minAmount",n).numberRange(this.maxAmount(),0,void 0,"maxAmount",o).numberRange(this.fee(),0,void 0,"fee",i);const u=parseFloat(this.minAmount());if(parseFloat(this.maxAmount())<u){const y=a.translator.trans("funds.admin.platforms.max_min_error").toString();t.custom(!1,"maxAmount",y)}if(this.platformIconUrl()&&this.platformIconUrl().trim()){const y=a.translator.trans("funds.admin.platforms.platform_icon_url").toString();t.url(this.platformIconUrl(),"platformIconUrl",y)}const g=t.getResult();return!g.isValid&&g.firstErrorMessage&&a.alerts.show({type:"error",dismissible:!0},g.firstErrorMessage),g.isValid}catch(e){return console.error("Form validation error:",e),a.alerts.show({type:"error",dismissible:!0},"Validation failed"),!1}}async handleEdit(){if(this.submitting||!this.validateForm())return;this.submitting=!0;const t={name:this.name(),symbol:this.symbol(),network:this.network(),minAmount:this.minAmount(),maxAmount:this.maxAmount(),fee:this.fee(),isActive:this.isActive(),platformIconUrl:this.platformIconUrl(),platformIconClass:this.platformIconClass()};try{await this.attrs.onEditPlatform(this.attrs.platform.id(),t),this.hide()}catch(e){console.error("Edit platform error:",e),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.platforms.edit_error"))}finally{this.submitting=!1,r.redraw()}}}class at extends A{constructor(){super(...arguments),this.editingPlatform=null}view(){const{platforms:t,submittingPlatform:e,onAddPlatform:s,onTogglePlatformStatus:n,onDeletePlatform:o}=this.attrs;return m("div",{className:"WithdrawalManagementPage-section"},m("h3",null,a.translator.trans("funds.admin.platforms.title")),m(st,{onSubmit:s,submitting:e}),m("div",{className:"PlatformList"},t.length===0?m("p",null,a.translator.trans("funds.admin.platforms.empty")):t.filter(i=>i!=null).map(i=>m(W,{key:i.id(),platform:i,type:"withdrawal",style:"card",onToggleStatus:n,onDelete:o,onEditPlatform:this.handleEdit.bind(this)}))))}handleEdit(t){this.editingPlatform=t,a.modal.show(rt,{platform:t,onEditPlatform:this.attrs.onEditPlatform})}}class Y extends A{view(){const t=this.attrs.request,{showActions:e,showDelete:s=!1}=this.attrs,n=t.id(),o=t.amount(),i=t.status(),u=t.accountDetails(),w=t.createdAt(),g=t.user(),y=g?g.displayName():"Unknown User",v=t.platform(),_=v?v.name():"Unknown Platform",S=v?v.symbol():"N/A",O=`status-${i}`;let j="N/A";if(w)try{j=F(w)}catch(Pt){console.error("Error formatting request date:",Pt),j="Invalid Date"}return m("div",{key:n,className:`WithdrawalRequest ${O}`},m("div",{className:"WithdrawalRequest-info"},m("div",{className:"WithdrawalRequest-user"},m("strong",null,y),m("span",{className:"request-id"},"#",n)),m("div",{className:"WithdrawalRequest-details"},m("span",{className:"amount"},o),m("span",{className:"platform"},_),m("span",{className:"symbol"},S),m("span",{className:"date"},j)),m("div",{className:"WithdrawalRequest-account"},m("strong",null,a.translator.trans("funds.admin.requests.account_details"),":"),m("span",null,u)),m("div",{className:"WithdrawalRequest-status"},m("span",{className:`Badge Badge--${i}`},a.translator.trans(`funds.admin.requests.status.${i}`)))),(e||s)&&m("div",{className:"WithdrawalRequest-actions"},e&&this.attrs.onUpdateStatus&&m("[",null,m(b,{className:"Button Button--primary",onclick:()=>this.attrs.onUpdateStatus(t,"approved")},a.translator.trans("funds.admin.requests.approve")),m(b,{className:"Button Button--danger",onclick:()=>this.attrs.onUpdateStatus(t,"rejected")},a.translator.trans("funds.admin.requests.reject"))),this.attrs.onDelete&&m(b,{className:"Button Button--link",onclick:()=>this.attrs.onDelete(t)},m("i",{className:"fas fa-trash"}),a.translator.trans("funds.admin.requests.delete"))))}}class nt extends A{view(){const{requests:t,onUpdateRequestStatus:e,onDeleteRequest:s}=this.attrs,n=t.filter(i=>i.status()==="pending"),o=t.filter(i=>i.status()!=="pending");return m("div",{className:"WithdrawalManagementPage-section"},m("h3",null,a.translator.trans("funds.admin.requests.title")),m("div",{className:"WithdrawalManagementPage-pendingRequests"},m("h4",null,a.translator.trans("funds.admin.requests.pending_title")),n.length===0?m("p",null,a.translator.trans("funds.admin.requests.no_pending")):n.map(i=>m(Y,{key:i.id(),request:i,showActions:!0,showDelete:!0,onUpdateStatus:e,onDelete:s}))),m("div",{className:"WithdrawalManagementPage-processedRequests"},m("h4",null,a.translator.trans("funds.admin.requests.processed_title")),o.length===0?m("p",null,a.translator.trans("funds.admin.requests.no_processed")):o.map(i=>m(Y,{key:i.id(),request:i,showActions:!1,showDelete:!0,onDelete:s}))))}}class ot extends A{constructor(){super(...arguments),this.state={processingRecords:new Set}}view(t){const{records:e,platforms:s,loading:n}=t.attrs;return n?r("div",{className:"DepositRecordManagementSection"},r("div",{className:"ection-header"},r("h3",null,a.translator.trans("funds.admin.deposit.records.title"))),r(B,null)):r("div",{className:"DepositRecordManagementSection"},r("div",{className:"DepositRecordManagementSection-header"},r("h3",null,a.translator.trans("funds.admin.deposit.records.title")),r("div",{className:"DepositRecordManagementSection-stats"},r("span",{className:"DepositRecordManagementSection-count"},a.translator.trans("funds.admin.deposit.records.total_count",{count:e.length})),r("span",{className:"DepositRecordManagementSection-pending"},a.translator.trans("funds.admin.deposit.records.pending_count",{count:e.filter(o=>o.isPending()).length})))),r("div",{className:"DepositRecordManagementSection-content"},e.length===0?r("div",{className:"DepositRecordManagementSection-empty"},r("div",{className:"DepositRecordManagementSection-emptyIcon"},I("fas fa-receipt")),r("h4",null,a.translator.trans("funds.admin.deposit.records.empty.title")),r("p",null,a.translator.trans("funds.admin.deposit.records.empty.description"))):r("div",{className:"DepositRecordManagementSection-list"},e.map(o=>this.renderRecord(o,s,t.attrs)))))}renderRecord(t,e,s){const n=t.id(),o=this.state.processingRecords.has(n),i=this.getPlatformId(t),u=this.findPlatform(e,i),w=t.user?.(),g=this.getRecordStatus(t),y=this.getDepositTime(t),v=this.getCreatedAt(t);return r("div",{key:`record-${n}`,className:`DepositRecordItem status-${g}`},r("div",{className:"DepositRecordItem-header"},r("div",{className:"DepositRecordItem-user"},r("span",{className:"DepositRecordItem-username"},w?.displayName?.()||"Unknown User"),r("span",{className:"DepositRecordItem-userId"},"ID: ",this.getUserId(t))),r("div",{className:"DepositRecordItem-amount"},r("span",{className:"DepositRecordItem-amountValue"},this.getAmount(t)," ",u?.symbol?.()||""),r("div",{className:`DepositRecordItem-status status-${this.getStatusColor(g)}`},this.renderStatusIcon(g),this.getStatusText(g)))),r("div",{className:"DepositRecordItem-details"},r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Platform:"),r("span",{className:"DepositRecordItem-value"},u?.name?.()||"Unknown Platform"," ",u?.network?.()?`(${u.network()})`:"")),r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Deposit Time:"),r("span",{className:"DepositRecordItem-value"},y.toLocaleDateString()," ",y.toLocaleTimeString())),r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Submitted:"),r("span",{className:"DepositRecordItem-value"},F(v))),t.userMessage?.()&&r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Message:"),r("span",{className:"DepositRecordItem-value"},t.userMessage())),t.screenshotUrl?.()&&r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Screenshot:"),r("a",{href:t.screenshotUrl(),target:"_blank",rel:"noopener noreferrer",className:"DepositRecordItem-link"},"View Screenshot ",I("fas fa-external-link-alt"))),t.processedAt?.()&&r("div",{className:"DepositRecordItem-processed"},r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Processed:"),r("span",{className:"DepositRecordItem-value"},F(t.processedAt()))),t.creditedAmount?.()&&t.creditedAmount()!==t.amount()&&r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Credited Amount:"),r("span",{className:"DepositRecordItem-value"},t.creditedAmount()," ",u?.symbol?.()||"")),t.adminNotes?.()&&r("div",{className:"DepositRecordItem-row"},r("span",{className:"DepositRecordItem-label"},"Admin Notes:"),r("span",{className:"DepositRecordItem-value"},t.adminNotes())))),g==="pending"&&r("div",{className:"DepositRecordItem-actions"},r(b,{className:"Button Button--primary DepositRecordItem-approveButton",onclick:()=>this.handleApprove(t,s),loading:o,disabled:o},a.translator.trans("funds.admin.deposit.records.approve")),r(b,{className:"Button Button--danger DepositRecordItem-rejectButton",onclick:()=>this.handleReject(t,s),loading:o,disabled:o},a.translator.trans("funds.admin.deposit.records.reject"))),r("div",{className:"DepositRecordItem-adminActions"},r(b,{className:"Button Button--link DepositRecordItem-deleteButton",onclick:()=>this.handleDelete(t,s),disabled:o},I("fas fa-trash"),a.translator.trans("funds.admin.deposit.records.delete"))))}getPlatformId(t){if(typeof t.platformId=="function")try{return t.platformId()}catch(s){console.warn("Failed to call platformId() method:",s)}const e=t;return e.platformId!==void 0?parseInt(e.platformId):e.attributes&&e.attributes.platformId!==void 0?parseInt(e.attributes.platformId):(console.error("Could not find platformId in record:",t),0)}getRecordStatus(t){if(typeof t.status=="function")try{return t.status()}catch(s){console.warn("Failed to call status() method:",s)}const e=t;return e.status?e.status:e.attributes&&e.attributes.status?e.attributes.status:"pending"}getDepositTime(t){if(typeof t.depositTime=="function")try{return t.depositTime()}catch(s){console.warn("Failed to call depositTime() method:",s)}const e=t;return e.depositTime?new Date(e.depositTime):e.attributes&&e.attributes.depositTime?new Date(e.attributes.depositTime):e.attributes&&e.attributes.deposit_time?new Date(e.attributes.deposit_time):new Date}getCreatedAt(t){if(typeof t.createdAt=="function")try{return t.createdAt()}catch(s){console.warn("Failed to call createdAt() method:",s)}const e=t;return e.createdAt?new Date(e.createdAt):e.attributes&&e.attributes.createdAt?new Date(e.attributes.createdAt):e.attributes&&e.attributes.created_at?new Date(e.attributes.created_at):new Date}getUserId(t){if(typeof t.userId=="function")try{return t.userId()}catch(s){console.warn("Failed to call userId() method:",s)}const e=t;return e.userId!==void 0?parseInt(e.userId):e.attributes&&e.attributes.userId!==void 0?parseInt(e.attributes.userId):e.attributes&&e.attributes.user_id!==void 0?parseInt(e.attributes.user_id):0}getAmount(t){if(typeof t.amount=="function")try{return t.amount()}catch(s){console.warn("Failed to call amount() method:",s)}const e=t;return e.amount!==void 0?parseFloat(e.amount):e.attributes&&e.attributes.amount!==void 0?parseFloat(e.attributes.amount):0}findPlatform(t,e){return t.find(s=>{const n=typeof s.id=="function"?s.id():s.id;return parseInt(n)===e})||null}getStatusColor(t){switch(t){case"pending":return"warning";case"approved":return"success";case"rejected":return"danger";default:return"secondary"}}renderStatusIcon(t){switch(t){case"pending":return I("fas fa-clock");case"approved":return I("fas fa-check-circle");case"rejected":return I("fas fa-times-circle");default:return I("fas fa-question-circle")}}getStatusText(t){switch(t){case"pending":return a.translator.trans("funds.admin.deposit.records.status.pending").toString();case"approved":return a.translator.trans("funds.admin.deposit.records.status.approved").toString();case"rejected":return a.translator.trans("funds.admin.deposit.records.status.rejected").toString();default:return"Unknown"}}async handleApprove(t,e){const s=t.id(),n=t.amount(),o=parseFloat(prompt(a.translator.trans("funds.admin.deposit.records.approve_prompt",{amount:n}).toString(),n.toString())||n.toString()),i=prompt(a.translator.trans("funds.admin.deposit.records.approve_notes_prompt").toString());if(isNaN(o)||o<=0){a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.records.invalid_amount"));return}this.state.processingRecords.add(s),r.redraw();try{await e.onApproveRecord(t,o,i||void 0)}catch(u){console.error("Error approving deposit record:",u),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.records.approve_error"))}finally{this.state.processingRecords.delete(s),r.redraw()}}async handleReject(t,e){const s=prompt(a.translator.trans("funds.admin.deposit.records.reject_reason_prompt").toString());if(!s||s.trim()===""){a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.records.reject_reason_required"));return}const n=t.id();this.state.processingRecords.add(n),r.redraw();try{await e.onRejectRecord(t,s)}catch(o){console.error("Error rejecting deposit record:",o),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.records.reject_error"))}finally{this.state.processingRecords.delete(n),r.redraw()}}handleDelete(t,e){const s=t.user?.(),n=t.amount();a.modal.show(T,{title:a.translator.trans("funds.admin.deposit.records.delete_confirm_title"),message:a.translator.trans("funds.admin.deposit.records.delete_confirm_message",{user:s,amount:n}),confirmText:a.translator.trans("funds.admin.deposit.records.delete_confirm_button"),cancelText:a.translator.trans("funds.admin.deposit.records.delete_cancel_button"),dangerous:!0,icon:"fas fa-trash",onConfirm:async()=>{const o=t.id();this.state.processingRecords.add(o);try{await e.onDeleteRecord(t)}catch(i){console.error("Error deleting deposit record:",i),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.records.delete_error"))}finally{this.state.processingRecords.delete(o),r.redraw()}},onCancel:()=>{a.modal.close()}})}}class it extends A{constructor(){super(...arguments),this.formData={name:p(""),symbol:p(""),network:p(""),minAmount:p(""),maxAmount:p(""),fee:p(""),address:p(""),qrCodeImageUrl:p(""),platformIconUrl:p(""),platformIconClass:p(""),warningText:p(""),isActive:p(!0)}}oninit(t){super.oninit(t)}view(t){const{submitting:e}=t.attrs;return m("form",{id:"deposit-platform-form",className:"AddDepositPlatformForm",onsubmit:s=>this.handleSubmit(t.attrs,s)},m("div",{className:"Form"},m("div",{className:"Form-row"},m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.name"),m("span",{className:"Form-required"},"*")),m("input",{type:"text",className:"FormControl",placeholder:"e.g., Tether",bidi:this.formData.name,disabled:e})),m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.symbol"),m("span",{className:"Form-required"},"*")),m("input",{type:"text",className:"FormControl",placeholder:"e.g., USDT",bidi:this.formData.symbol,disabled:e}))),m("div",{className:"Form-row"},m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.network")),m("input",{type:"text",className:"FormControl",placeholder:"e.g., TRC20, ERC20, BSC (optional)",bidi:this.formData.network,disabled:e}),m("div",{className:"helpText"},"Optional. Specify the blockchain network for this platform."))),m("div",{className:"Form-row"},m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.min_amount")),m("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"0.0",bidi:this.formData.minAmount,disabled:e})),m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.max_amount")),m("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"Leave empty for unlimited",bidi:this.formData.maxAmount,disabled:e})),m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.fee")),m("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"0.0",bidi:this.formData.fee,disabled:e}),m("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.fee_help")))),m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.address"),m("span",{className:"Form-required"},"*")),m("input",{type:"text",className:"FormControl",placeholder:"Enter deposit address for this platform",bidi:this.formData.address,disabled:e}),m("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.address_help"))),m("div",{className:"Form-group"},m("label",null,a.translator.trans("funds.admin.deposit.platforms.qr_code_image_url")),m("input",{type:"url",className:"FormControl",placeholder:"https://example.com/qr-code.png",bidi:this.formData.qrCodeImageUrl,disabled:e}),m("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.qr_code_image_help"))),m("div",{className:"Form-section"},m("h4",null,a.translator.trans("funds.admin.platforms.platform_icon")),m("p",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_help")),m("div",{className:"Form-row"},m("div",{className:"Form-group"},m("label",null,"平台图标URL"),m("input",{type:"url",className:"FormControl",placeholder:"https://example.com/platform-icon.png",bidi:this.formData.platformIconUrl,disabled:e}),m("div",{className:"helpText"},"请输入平台图标的URL")),m("div",{className:"Form-group"},m("label",null,"平台图标CSS类"),m("input",{type:"text",className:"FormControl",placeholder:"fab fa-bitcoin",bidi:this.formData.platformIconClass,disabled:e}),m("div",{className:"helpText"},"请输入平台图标的CSS类")))),m("div",{className:"Form-group"},m("label",null,"警告文本"),m("textarea",{className:"FormControl",rows:3,placeholder:"Network-specific warning for users",bidi:this.formData.warningText,disabled:e})),m("div",{className:"Form-group"},m(L,{state:this.formData.isActive(),onchange:this.formData.isActive,disabled:e},"是否激活"))))}validateForm(){const t=new C;try{const e=a.translator.trans("funds.admin.deposit.platforms.name").toString(),s=a.translator.trans("funds.admin.deposit.platforms.symbol").toString(),n=a.translator.trans("funds.admin.deposit.platforms.address").toString();if(t.required(this.formData.name(),"name",e).required(this.formData.symbol(),"symbol",s).required(this.formData.address(),"address",n),this.formData.minAmount()&&this.formData.minAmount().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.min_amount").toString();t.numberRange(this.formData.minAmount(),0,void 0,"minAmount",i)}if(this.formData.maxAmount()&&this.formData.maxAmount().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.max_amount").toString();t.numberRange(this.formData.maxAmount(),0,void 0,"maxAmount",i)}if(this.formData.fee()&&this.formData.fee().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.fee").toString();t.numberRange(this.formData.fee(),0,void 0,"fee",i)}if(this.formData.minAmount()&&this.formData.maxAmount()){const i=parseFloat(this.formData.minAmount()),u=parseFloat(this.formData.maxAmount());if(!isNaN(i)&&!isNaN(u)&&u<i){const w=a.translator.trans("funds.admin.platforms.max_min_error").toString();t.custom(!1,"maxAmount",w)}}if(this.formData.platformIconUrl()&&this.formData.platformIconUrl().trim()){const i=a.translator.trans("funds.admin.platforms.platform_icon_url").toString();t.url(this.formData.platformIconUrl(),"platformIconUrl",i)}if(this.formData.qrCodeImageUrl()&&this.formData.qrCodeImageUrl().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.qr_code_image_url").toString();t.url(this.formData.qrCodeImageUrl(),"qrCodeImageUrl",i)}const o=t.getResult();return!o.isValid&&o.firstErrorMessage&&a.alerts.show({type:"error",dismissible:!0},o.firstErrorMessage),o.isValid}catch(e){return console.error("Form validation error:",e),a.alerts.show({type:"error",dismissible:!0},"Validation failed"),!1}}clearForm(){this.formData.name(""),this.formData.symbol(""),this.formData.network(""),this.formData.minAmount(""),this.formData.maxAmount(""),this.formData.fee(""),this.formData.address(""),this.formData.qrCodeImageUrl(""),this.formData.platformIconUrl(""),this.formData.platformIconClass(""),this.formData.warningText(""),this.formData.isActive(!0)}async handleSubmit(t,e){if(e.preventDefault(),!this.validateForm())return;const s={name:this.formData.name(),symbol:this.formData.symbol(),network:this.formData.network(),minAmount:this.formData.minAmount(),maxAmount:this.formData.maxAmount(),fee:this.formData.fee(),address:this.formData.address(),qrCodeImageUrl:this.formData.qrCodeImageUrl(),platformIconUrl:this.formData.platformIconUrl(),platformIconClass:this.formData.platformIconClass(),warningText:this.formData.warningText(),isActive:this.formData.isActive()};try{await t.onSubmit(s),this.clearForm()}catch(n){console.error("Form submission error:",n)}}}class lt extends k{constructor(){super(...arguments),this.formData={name:p(""),symbol:p(""),network:p(""),minAmount:p(""),maxAmount:p(""),fee:p(""),address:p(""),qrCodeImageUrl:p(""),platformIconUrl:p(""),platformIconClass:p(""),warningText:p(""),isActive:p(!0)},this.submitting=!1}className(){return"EditDepositPlatformModal Modal--large"}title(){return a.translator.trans("funds.admin.deposit.platforms.edit_title")}oninit(t){super.oninit(t),this.populateForm()}populateForm(){const{platform:t}=this.attrs;this.formData.name(t.name||""),this.formData.symbol(t.symbol||""),this.formData.network(t.network||""),this.formData.minAmount(t.minAmount?.toString()||""),this.formData.maxAmount(t.maxAmount?.toString()||""),this.formData.fee(t.fee?.toString()||""),this.formData.address(t.address||""),this.formData.qrCodeImageUrl(t.qrCodeImageUrl||""),this.formData.platformIconUrl(t.platformIconUrl||""),this.formData.platformIconClass(t.platformIconClass||""),this.formData.warningText(t.warningText||""),this.formData.isActive(t.isActive??!0)}content(){return r("div",{className:"Modal-body"},r("form",{onsubmit:this.onsubmit.bind(this)},r("div",{className:"Form"},r("div",{className:"Form-row"},r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.name"),r("span",{className:"Form-required"},"*")),r("input",{type:"text",className:"FormControl",placeholder:"e.g., Tether",bidi:this.formData.name,disabled:this.submitting})),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.symbol"),r("span",{className:"Form-required"},"*")),r("input",{type:"text",className:"FormControl",placeholder:"e.g., USDT",bidi:this.formData.symbol,disabled:this.submitting}))),r("div",{className:"Form-row"},r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.network")),r("input",{type:"text",className:"FormControl",placeholder:"e.g., TRC20, ERC20, BSC (optional)",bidi:this.formData.network,disabled:this.submitting}),r("div",{className:"helpText"},"Optional. Specify the blockchain network for this platform."))),r("div",{className:"Form-row"},r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.min_amount")),r("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"0.0",bidi:this.formData.minAmount,disabled:this.submitting})),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.max_amount")),r("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"Leave empty for unlimited",bidi:this.formData.maxAmount,disabled:this.submitting})),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.fee")),r("input",{type:"number",step:"0.00000001",min:"0",className:"FormControl",placeholder:"0.0",bidi:this.formData.fee,disabled:this.submitting}),r("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.fee_help")))),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.address"),r("span",{className:"Form-required"},"*")),r("input",{type:"text",className:"FormControl",placeholder:"Enter deposit address for this platform",bidi:this.formData.address,disabled:this.submitting}),r("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.address_help"))),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.qr_code_image_url")),r("input",{type:"url",className:"FormControl",placeholder:"https://example.com/qr-code.png",bidi:this.formData.qrCodeImageUrl,disabled:this.submitting}),r("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.qr_code_image_help"))),r("div",{className:"Form-section"},r("h4",null,a.translator.trans("funds.admin.platforms.platform_icon")),r("p",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_help")),r("div",{className:"Form-row"},r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_url")),r("input",{type:"url",className:"FormControl",placeholder:"https://example.com/platform-icon.png",bidi:this.formData.platformIconUrl,disabled:this.submitting}),r("div",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_url_help"))),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.platforms.platform_icon_class")),r("input",{type:"text",className:"FormControl",placeholder:"fab fa-bitcoin",bidi:this.formData.platformIconClass,disabled:this.submitting}),r("div",{className:"helpText"},a.translator.trans("funds.admin.platforms.platform_icon_class_help"))))),r("div",{className:"Form-group"},r("label",null,a.translator.trans("funds.admin.deposit.platforms.warning_text")),r("textarea",{className:"FormControl",rows:3,placeholder:"Network-specific warning for users",bidi:this.formData.warningText,disabled:this.submitting})),r("div",{className:"Form-group"},r(L,{state:this.formData.isActive(),onchange:this.formData.isActive,disabled:this.submitting},a.translator.trans("funds.admin.deposit.platforms.is_active"))),r("div",{className:"Form-group"},r(b,{className:"Button Button--primary",type:"submit",loading:this.submitting,disabled:this.submitting},a.translator.trans("funds.admin.deposit.platforms.edit_button")),r(b,{className:"Button Button--secondary",onclick:this.hide.bind(this),disabled:this.submitting},a.translator.trans("core.admin.basics.cancel_button"))))))}onsubmit(t){t.preventDefault(),this.handleEdit()}validateForm(){const t=new C;try{const e=a.translator.trans("funds.admin.deposit.platforms.name").toString(),s=a.translator.trans("funds.admin.deposit.platforms.symbol").toString(),n=a.translator.trans("funds.admin.deposit.platforms.address").toString();if(t.required(this.formData.name(),"name",e).required(this.formData.symbol(),"symbol",s).required(this.formData.address(),"address",n),this.formData.minAmount()&&this.formData.minAmount().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.min_amount").toString();t.numberRange(this.formData.minAmount(),0,void 0,"minAmount",i)}if(this.formData.maxAmount()&&this.formData.maxAmount().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.max_amount").toString();t.numberRange(this.formData.maxAmount(),0,void 0,"maxAmount",i)}if(this.formData.fee()&&this.formData.fee().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.fee").toString();t.numberRange(this.formData.fee(),0,void 0,"fee",i)}if(this.formData.minAmount()&&this.formData.maxAmount()){const i=parseFloat(this.formData.minAmount()),u=parseFloat(this.formData.maxAmount());if(!isNaN(i)&&!isNaN(u)&&u<i){const w=a.translator.trans("funds.admin.platforms.max_min_error").toString();t.custom(!1,"maxAmount",w)}}if(this.formData.platformIconUrl()&&this.formData.platformIconUrl().trim()){const i=a.translator.trans("funds.admin.platforms.platform_icon_url").toString();t.url(this.formData.platformIconUrl(),"platformIconUrl",i)}if(this.formData.qrCodeImageUrl()&&this.formData.qrCodeImageUrl().trim()){const i=a.translator.trans("funds.admin.deposit.platforms.qr_code_image_url").toString();t.url(this.formData.qrCodeImageUrl(),"qrCodeImageUrl",i)}const o=t.getResult();return!o.isValid&&o.firstErrorMessage&&a.alerts.show({type:"error",dismissible:!0},o.firstErrorMessage),o.isValid}catch(e){return console.error("Form validation error:",e),a.alerts.show({type:"error",dismissible:!0},"Validation failed"),!1}}async handleEdit(){if(this.submitting||!this.validateForm())return;this.submitting=!0;const t={name:this.formData.name(),symbol:this.formData.symbol(),network:this.formData.network(),minAmount:this.formData.minAmount(),maxAmount:this.formData.maxAmount(),fee:this.formData.fee(),address:this.formData.address(),qrCodeImageUrl:this.formData.qrCodeImageUrl(),platformIconUrl:this.formData.platformIconUrl(),platformIconClass:this.formData.platformIconClass(),warningText:this.formData.warningText(),isActive:this.formData.isActive()};try{await this.attrs.onEditPlatform(this.attrs.platform.id,t),this.hide()}catch(e){console.error("Edit deposit platform error:",e),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.deposit.platforms.edit_error"))}finally{this.submitting=!1,r.redraw()}}}class dt extends A{view(t){const{platforms:e,submittingPlatform:s,onAddPlatform:n,onTogglePlatformStatus:o,onDeletePlatform:i}=t.attrs;return m("div",{className:"DepositPlatformManagementSection"},m("div",{className:"Section-header"},m("h3",null,a.translator.trans("funds.admin.deposit.platforms.title"))),m("div",{className:"DepositPlatformManagementSection-layout"},m("div",{className:"DepositPlatformManagementSection-form"},m("div",{className:"DepositPlatformManagementSection-formHeader"},m("h4",null,"Add New Platform"),m(b,{className:"Button Button--primary DepositPlatformManagementSection-addButton",icon:"fas fa-plus",type:"submit",form:"deposit-platform-form",loading:s,disabled:s},a.translator.trans("funds.admin.deposit.platforms.add_button"))),m(it,{onSubmit:n,onCancel:()=>{},submitting:s})),m("div",{className:"DepositPlatformManagementSection-list"},m("h4",null,"Existing Platforms"),m("div",{className:"Section-content"},e.length===0?m("div",{className:"helpText"},a.translator.trans("funds.admin.deposit.platforms.empty")):m("div",{className:"PlatformList"},e.filter(u=>u!=null).map(u=>m(W,{key:typeof u.id=="function"?u.id():u.id,platform:u,type:"deposit",onToggleStatus:()=>o(u),onDelete:()=>i(u),onEditPlatform:this.handleEdit.bind(this)})))))))}handleEdit(t){const e={id:typeof t.id=="function"?t.id():t.id,name:typeof t.name=="function"?t.name():t.name||"Unknown Platform",symbol:typeof t.symbol=="function"?t.symbol():t.symbol,network:typeof t.network=="function"?t.network():t.network,displayName:typeof t.displayName=="function"?t.displayName():t.displayName,minAmount:typeof t.minAmount=="function"?t.minAmount():t.minAmount,maxAmount:typeof t.maxAmount=="function"?t.maxAmount():t.maxAmount,fee:typeof t.fee=="function"?t.fee():t.fee||0,address:typeof t.address=="function"?t.address():t.address,qrCodeImageUrl:typeof t.qrCodeImageUrl=="function"?t.qrCodeImageUrl():t.qrCodeImageUrl,platformIconUrl:typeof t.platformIconUrl=="function"?t.platformIconUrl():t.platformIconUrl,platformIconClass:typeof t.platformIconClass=="function"?t.platformIconClass():t.platformIconClass,warningText:"",isActive:typeof t.isActive=="function"?t.isActive():t.isActive||!1,createdAt:typeof t.createdAt=="function"?t.createdAt():new Date,updatedAt:new Date};a.modal.show(lt,{platform:e,onEditPlatform:this.handleEditSubmit.bind(this)})}async handleEditSubmit(t,e){await this.attrs.onEditPlatform(t,e)}}const q={REQUIRED:{COMMON:["name","symbol","minAmount","fee","isActive"],WITHDRAWAL:[],DEPOSIT:["address"]},OPTIONAL:{COMMON:["network","maxAmount","networkTypeId","platformIconUrl","platformIconClass"],WITHDRAWAL:[],DEPOSIT:["qrCodeImageUrl","iconUrl","iconClass","warningText","networkConfig"]}};function U(l){return[...q.REQUIRED.COMMON,...q.REQUIRED[l.toUpperCase()]]}function V(l){return[...q.OPTIONAL.COMMON,...q.OPTIONAL[l.toUpperCase()]]}function mt(l,t){const s=U(t).filter(n=>!(n in l)||l[n]===null||l[n]===void 0);return{valid:s.length===0,missingFields:s}}const M={name:"平台名称",symbol:"货币符号",network:"网络类型",minAmount:"最小金额",maxAmount:"最大金额",fee:"手续费",isActive:"启用状态",networkTypeId:"网络类型",platformIconUrl:"平台图标URL",platformIconClass:"平台图标CSS类",address:"收款地址",qrCodeImageUrl:"二维码图片URL",iconUrl:"图标URL",iconClass:"图标CSS类",warningText:"警告文本",networkConfig:"网络配置",id:"ID",createdAt:"创建时间",updatedAt:"更新时间"},G={name:{required:!0,minLength:1,maxLength:255},symbol:{required:!0,minLength:1,maxLength:50},network:{required:!1,maxLength:50},minAmount:{required:!0,min:0},maxAmount:{required:!1,min:0,max:999999999},fee:{required:!0,min:0,max:1e3},isActive:{required:!0},networkTypeId:{required:!1,min:1},platformIconUrl:{required:!1,maxLength:500},platformIconClass:{required:!1,maxLength:100},address:{required:!0,minLength:10,maxLength:500},qrCodeImageUrl:{required:!1,maxLength:500},iconUrl:{required:!1,maxLength:500},iconClass:{required:!1,maxLength:100},warningText:{required:!1,maxLength:1e3},networkConfig:{required:!1},id:{required:!1,min:1},createdAt:{required:!1},updatedAt:{required:!1}};class N{static validatePlatformData(t,e){const s={},n={},o=mt(t,e);return o.valid||o.missingFields.forEach(i=>{s[i]=[`${M[i]} 是必要字段`]}),Object.entries(t).forEach(([i,u])=>{const w=N.validateField(i,u,e);w.length>0&&(s[i]=w);const g=N.getFieldWarnings(i,u,e);g.length>0&&(n[i]=g)}),{valid:Object.keys(s).length===0,errors:s,warnings:n}}static validateField(t,e,s){const n=[],o=G[t];if(!o)return n;const i=M[t]||t;if(o.required&&(e==null||e===""))return n.push(`${i} 不能为空`),n;if(e==null||e==="")return n;switch(t){case"symbol":typeof e=="string"&&!/^[A-Z0-9]{1,10}$/.test(e)&&n.push("货币符号只能包含大写字母和数字，长度1-10位");break;case"qrCodeImageUrl":typeof e=="string"&&e&&!N.isValidUrl(e)&&n.push("请输入有效的URL地址");break}return n}static getFieldWarnings(t,e,s){const n=[];return s==="deposit"&&(t==="address"&&typeof e=="string"&&e&&e.length>100&&n.push("地址较长，请确认正确性"),t==="fee"&&typeof e=="number"&&e>0&&n.push("存款平台通常不收取手续费")),s==="withdrawal"&&t==="maxAmount"&&!e&&n.push("建议设置最大提现金额以控制风险"),n}static formatFieldsForDisplay(t,e,s={}){const n={},o=U(e),i=V(e);return o.forEach(u=>{u in t&&(n[u]=N.formatFieldValue(u,t[u]))}),s.includeOptional!==!1&&i.forEach(u=>{u in t&&t[u]!==null&&t[u]!==void 0&&(n[u]=N.formatFieldValue(u,t[u]))}),s.excludeSystem&&(delete n.id,delete n.createdAt,delete n.updatedAt),n}static formatFieldValue(t,e){if(e==null)return null;switch(t){case"minAmount":case"maxAmount":case"fee":return typeof e=="number"?e.toFixed(8):e;case"isActive":return e?"启用":"禁用";case"createdAt":case"updatedAt":return e instanceof Date?e.toLocaleString():e;default:return e}}static getFieldConfig(t){const e={},s=U(t),n=V(t);return[...s,...n].forEach(o=>{e[o]={label:M[o]||o,required:s.includes(o),validation:G[o],...N.getFieldInputConfig(o)}}),e}static getFieldInputConfig(t){switch(t){case"name":return{type:"text",placeholder:"例如：币安交易所",maxLength:255};case"symbol":return{type:"text",placeholder:"例如：USDT, BTC",maxLength:50,transform:"uppercase"};case"network":return{type:"text",placeholder:"例如：TRC20, ERC20",maxLength:50,transform:"uppercase"};case"minAmount":case"maxAmount":case"fee":return{type:"number",min:0,step:1e-8};case"address":return{type:"text",placeholder:"收款地址",maxLength:500};case"qrCodeImageUrl":return{type:"url",placeholder:"https://example.com/qr.png",maxLength:500};case"warningText":return{type:"textarea",placeholder:"重要提示信息",maxLength:1e3};case"isActive":return{type:"boolean",default:!0};default:return{type:"text"}}}static sanitizePlatformData(t,e){const s={};return[...U(e),...V(e)].forEach(o=>{o in t&&(s[o]=N.sanitizeFieldValue(o,t[o]))}),s}static sanitizeFieldValue(t,e){if(e==null||e==="")return null;switch(t){case"name":case"address":case"warningText":return typeof e=="string"?e.trim():e;case"symbol":case"network":return typeof e=="string"?e.trim().toUpperCase():e;case"minAmount":case"maxAmount":case"fee":const s=parseFloat(e);return isNaN(s)?null:Math.max(0,s);case"isActive":return!!e;default:return e}}static compareData(t,e){const s={};return new Set([...Object.keys(t),...Object.keys(e)]).forEach(o=>{const i=t[o],u=e[o];i!==u&&(s[o]={old:i,new:u})}),s}static isValidUrl(t){try{return!!new URL(t)}catch{return!1}}}function z(l,t){return N.validatePlatformData(l,t)}function H(l,t){return N.sanitizePlatformData(l,t)}const ct=()=>({async create(l){try{const t="withdrawal",e=H(l,t),s=z(e,t);if(!s.valid){const i=Object.values(s.errors).flat();throw new Error(i.join(", "))}const{platformService:n}=await D(async()=>{const{platformService:i}=await Promise.resolve().then(()=>P);return{platformService:i}},void 0),o=await n.create("withdrawal",e);return a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.platforms.add_success").toString()),o}catch(t){throw a.alerts.show({type:"error",dismissible:!0},t instanceof Error?t.message:a.translator.trans("funds.admin.platforms.add_error").toString()),t}},async update(l,t){try{const e="withdrawal",s=H(t,e),n=z(s,e);if(!n.valid){const u=Object.values(n.errors).flat();throw new Error(u.join(", "))}const{platformService:o}=await D(async()=>{const{platformService:u}=await Promise.resolve().then(()=>P);return{platformService:u}},void 0),i=await o.update(l,s);return a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.platforms.edit_success").toString()),i}catch(e){throw a.alerts.show({type:"error",dismissible:!0},e instanceof Error?e.message:a.translator.trans("funds.admin.platforms.edit_error").toString()),e}},async toggleStatus(l){try{const{platformService:t}=await D(async()=>{const{platformService:n}=await Promise.resolve().then(()=>P);return{platformService:n}},void 0),e=await t.toggleStatus(l),s=e.isActive();return a.alerts.show({type:"success",dismissible:!0},a.translator.trans(`funds.admin.platforms.${s?"enable":"disable"}_success`)),e}catch(t){throw a.alerts.show({type:"error",dismissible:!0},t instanceof Error?t.message:"Failed to toggle platform status"),t}},async delete(l){try{const{platformService:t}=await D(async()=>{const{platformService:e}=await Promise.resolve().then(()=>P);return{platformService:e}},void 0);await t.delete(l),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.platforms.delete_success").toString())}catch(t){throw a.alerts.show({type:"error",dismissible:!0},t instanceof Error?t.message:"Failed to delete platform"),t}},async load(){try{const{platformService:l}=await D(async()=>{const{platformService:t}=await Promise.resolve().then(()=>P);return{platformService:t}},void 0);return await l.find("withdrawal")}catch(l){throw a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.platforms.load_error").toString()),l}}}),ut=()=>({async updateStatus(l,t){try{const{withdrawalService:e}=await D(async()=>{const{withdrawalService:s}=await Promise.resolve().then(()=>K);return{withdrawalService:s}},void 0);await e.update(l,{status:t})}catch(e){throw a.alerts.show({type:"error",dismissible:!0},e instanceof Error?e.message:`Failed to update request status to ${t}`),e}},async load(){try{const{withdrawalService:l}=await D(async()=>{const{withdrawalService:t}=await Promise.resolve().then(()=>K);return{withdrawalService:t}},void 0);return await l.find({include:"user,platform"})}catch(l){throw a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.requests.load_error").toString()),l}}});var h=(l=>(l.NETWORK_ERROR="network_error",l.PERMISSION_DENIED="permission_denied",l.VALIDATION_ERROR="validation_error",l.NOT_FOUND="not_found",l.SERVER_ERROR="server_error",l.TIMEOUT="timeout",l))(h||{});class d extends Error{constructor(t,e="server_error",s,n){super(t),this.name="ServiceError",this.type=e,this.code=s,this.details=n}}class ft{constructor(){this.modelType="withdrawal-requests",this.platformModelType="withdrawal-platforms"}async find(t={}){try{const e={include:t.include||"user,platform",sort:t.sort||"-created_at",...t};return t.page&&(e.page=t.page),t.filter&&(e.filter=t.filter),await f.store.find(this.modelType,e)}catch(e){throw this.handleError(e,"Failed to fetch funds requests")}}async findById(t,e={}){try{const s={include:e.include||"user,platform"};return await f.store.find(this.modelType,String(t),s)}catch(s){if(this.isNotFoundError(s))return null;throw this.handleError(s,`Failed to fetch funds request ${t}`)}}async create(t){try{return this.validateCreateAttributes(t),await f.store.createRecord(this.modelType).save(t)}catch(e){throw this.handleError(e,"Failed to create funds request")}}async update(t,e){try{if(!this.canModify(t))throw new d("You do not have permission to modify this funds request",h.PERMISSION_DENIED);return await t.save(e)}catch(s){throw this.handleError(s,"Failed to update funds request")}}async delete(t){try{if(!this.canDelete(t))throw new d("You do not have permission to delete this funds request",h.PERMISSION_DENIED);await t.delete()}catch(e){throw this.handleError(e,"Failed to delete funds request")}}async submitRequest(t){try{await this.validateWithdrawalRequest(t);const e={platformId:t.platformId,amount:t.amount,accountDetails:t.accountDetails,message:t.message||"",status:"pending"};return await this.create(e)}catch(e){throw this.handleError(e,"Failed to submit funds request")}}async getUserHistory(t,e={}){const s=t||f.session.user?.id();if(!s)throw new d("User not authenticated",h.PERMISSION_DENIED);const n={...e,filter:{user:s,...e.filter},include:e.include||"platform",sort:e.sort||"-created_at"};return await this.find(n)}async getPendingRequests(t={}){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);const e={...t,filter:{status:"pending",...t.filter},include:t.include||"user,platform",sort:t.sort||"created_at"};return await this.find(e)}async approve(t,e){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);if(!t.isPending())throw new d("Only pending requests can be approved",h.VALIDATION_ERROR);const s={status:"approved"};return e&&(s.adminNote=e),await this.update(t,s)}async reject(t,e){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);if(!t.isPending())throw new d("Only pending requests can be rejected",h.VALIDATION_ERROR);const s={status:"rejected"};return e&&(s.adminNote=e),await this.update(t,s)}async cancel(t){if(!t.canBeModified())throw new d("This request cannot be cancelled",h.VALIDATION_ERROR);const e=f.session.user;if(!e||String(t.userId())!==e.id()&&!e.isAdmin())throw new d("You can only cancel your own requests",h.PERMISSION_DENIED);return await this.delete(t)}canModify(t){const e=f.session.user;return e?e.isAdmin()?!0:String(t.userId())===e.id()&&t.canBeModified():!1}canCreate(){return!!f.session.user}canDelete(t){const e=f.session.user;return e?e.isAdmin()?!0:String(t.userId())===e.id()&&t.canBeModified():!1}async getPlatforms(){try{return await f.store.find(this.platformModelType)}catch(t){throw this.handleError(t,"Failed to fetch funds platforms")}}async validateWithdrawalRequest(t){const{platformId:e,amount:s}=t,n=await f.store.find(this.platformModelType,String(e));if(!n)throw new d("Invalid platform selected",h.VALIDATION_ERROR);if(!n.isActive?.())throw new d("Selected platform is not available",h.VALIDATION_ERROR);const o=n.minAmount?.()||0,i=n.maxAmount?.();if(s<o)throw new d(`Minimum funds amount is ${o}`,h.VALIDATION_ERROR);if(i&&s>i)throw new d(`Maximum funds amount is ${i}`,h.VALIDATION_ERROR);const u=f.session.user;if(u){const w=parseFloat(u.attribute("money")||"0"),g=n.fee?.()||0,y=s+g;if(w<y)throw new d(`Insufficient balance. Required: ${y}, Available: ${w}`,h.VALIDATION_ERROR)}}validateCreateAttributes(t){const e=["platformId","amount","accountDetails"];for(const s of e)if(!t[s])throw new d(`${s} is required`,h.VALIDATION_ERROR);if(typeof t.amount!="number"||t.amount<=0)throw new d("Amount must be a positive number",h.VALIDATION_ERROR)}handleError(t,e){if(t instanceof d)return t;if(t.response&&t.response.errors){const s=t.response.errors[0];return new d(s.detail||e,h.VALIDATION_ERROR,s.code,s)}return t.name==="TypeError"||t.message?.includes("fetch")?new d("Network error occurred",h.NETWORK_ERROR):new d(t.message||e,h.SERVER_ERROR)}isNotFoundError(t){return t.status===404||t.response?.status===404||t.message?.includes("not found")}}const ht=new ft,K=Object.freeze(Object.defineProperty({__proto__:null,withdrawalService:ht},Symbol.toStringTag,{value:"Module"}));class pt{async create(t){if(!t.selectedPlatform)throw new Error("Selected platform is required");const e=parseInt(t.selectedPlatform.id());if(!e)throw new Error("Platform ID is required");if(!t.amount||t.amount<=0)throw new Error("Amount is required and must be greater than 0");if(!t.depositTime)throw new Error("Deposit time is required");const s=await f.request({method:"POST",url:f.forum.attribute("apiUrl")+"/deposit-records",body:{data:{type:"deposit-records",attributes:{platformId:e,amount:t.amount,depositTime:t.depositTime.toISOString(),userMessage:t.userMessage}}}}),n=f.store.pushPayload(s);return Array.isArray(n)?n[0]:n}async getUserHistory(){const t=await f.request({method:"GET",url:f.forum.attribute("apiUrl")+"/deposit-records",params:{include:"user,processedByUser"}});return f.store.pushPayload(t)}async getAll(t={}){const e={include:"user,processedByUser"};Object.keys(t).length>0&&(e.filter=t);const s=await f.request({method:"GET",url:f.forum.attribute("apiUrl")+"/deposit-records",params:e});return f.store.pushPayload(s)}async update(t,e){const s=await f.request({method:"PATCH",url:`${f.forum.attribute("apiUrl")}/deposit-records/${t}`,body:{data:{type:"deposit-records",id:t,attributes:e}}}),n=f.store.pushPayload(s);return Array.isArray(n)?n[0]:n}async approve(t,e){return this.update(t,{status:"approved",adminNotes:e})}async reject(t,e){return this.update(t,{status:"rejected",adminNotes:e})}async find(t={}){const e={...t};e.include&&(e.include=e.include.split(",").filter(n=>n.trim()!=="platform").join(","),e.include||delete e.include);const s=await f.request({method:"GET",url:f.forum.attribute("apiUrl")+"/deposit-records",params:e});return f.store.pushPayload(s)}async delete(t){await f.request({method:"DELETE",url:`${f.forum.attribute("apiUrl")}/deposit-records/${t.id()}`}),f.store.remove(t)}}const x=new pt;class gt{constructor(){this.withdrawalModelType="withdrawal-platforms",this.depositModelType="deposit-platforms"}async find(t,e={}){const s=t==="withdrawal"?this.withdrawalModelType:this.depositModelType;try{const n={sort:e.sort||"name",...e};e.page&&(n.page=e.page),e.filter&&(n.filter=e.filter),e.include&&(n.include=e.include);const o=await f.store.find(s,n);return Array.isArray(o)?o:[o]}catch(n){throw this.handleError(n,`Failed to fetch ${t} platforms`)}}async findById(t,e,s={}){const n=t==="withdrawal"?this.withdrawalModelType:this.depositModelType;try{const o={};return s.include&&(o.include=s.include),await f.store.find(n,String(e),o)}catch(o){if(this.isNotFoundError(o))return null;throw this.handleError(o,`Failed to fetch ${t} platform ${e}`)}}async create(t,e){const s=t==="withdrawal"?this.withdrawalModelType:this.depositModelType;try{return this.validateCreateAttributes(t,e),await f.store.createRecord(s).save(e)}catch(n){throw this.handleError(n,`Failed to create ${t} platform`)}}async update(t,e){try{if(!this.canModify(t))throw new d("You do not have permission to modify this platform",h.PERMISSION_DENIED);return await t.save(e)}catch(s){throw this.handleError(s,"Failed to update platform")}}async delete(t){try{if(!this.canDelete(t))throw new d("You do not have permission to delete this platform",h.PERMISSION_DENIED);await t.delete()}catch(e){throw this.handleError(e,"Failed to delete platform")}}async getActive(t,e={}){const s={...e,filter:{isActive:!0,...e.filter}};return await this.find(t,s)}async toggleStatus(t){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);const e=t.isActive();return await this.update(t,{isActive:!e})}async updateConfig(t,e){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);return await this.update(t,e)}async getBySymbol(t,e){return await this.find(e,{filter:{symbol:t},sort:"name"})}validateAmount(t,e){const s=[];if(typeof e!="number"||e<=0)return s.push("Amount must be a positive number"),{valid:!1,errors:s};const n=t.minAmount?t.minAmount():0,o=t.maxAmount?t.maxAmount():null;return e<n&&s.push(`Amount must be at least ${n}`),o&&e>o&&s.push(`Amount cannot exceed ${o}`),{valid:s.length===0,errors:s}}async getPlatformStats(t,e){if(!f.session.user?.isAdmin())throw new d("Admin permissions required",h.PERMISSION_DENIED);const s=t==="withdrawal"?"withdrawal-requests":"deposit-records";try{const n=t==="withdrawal"?"platform":"user,processedByUser",o=await f.store.find(s,{filter:{platform:e.toString()},include:n}),i=Array.isArray(o)?o:[o];return{total:i.length,pending:i.filter(w=>w.status()==="pending").length,approved:i.filter(w=>{if(t==="withdrawal")return w.status()==="approved";{const g=w.status();return g==="approved"||g==="confirmed"}}).length,rejected:i.filter(w=>w.status()==="rejected").length,totalAmount:i.reduce((w,g)=>t==="withdrawal"?w+(g.amount()||0):w,0)}}catch(n){throw this.handleError(n,"Failed to fetch platform statistics")}}async getPlatformsBySymbolGrouped(t){const e=await this.getActive(t),s={};for(const n of e){const o=n.symbol();s[o]||(s[o]=[]),s[o].push(n)}return s}async getSortedPlatforms(t,e="name",s="asc"){const n=s==="desc"?`-${e}`:e;return await this.getActive(t,{sort:n})}canModify(t){const e=f.session.user;return!!(e&&e.isAdmin())}canCreate(){const t=f.session.user;return!!(t&&t.isAdmin())}canDelete(t){const e=f.session.user;return!!(e&&e.isAdmin())}validateCreateAttributes(t,e){const n=["name","symbol","minAmount"];for(const o of n)if(!e[o])throw new d(`${o} is required for ${t} platforms`,h.VALIDATION_ERROR);if(typeof e.minAmount!="number"||e.minAmount<0)throw new d("minAmount must be a non-negative number",h.VALIDATION_ERROR);if(e.maxAmount!==void 0&&(typeof e.maxAmount!="number"||e.maxAmount<e.minAmount))throw new d("maxAmount must be a number greater than or equal to minAmount",h.VALIDATION_ERROR);if(e.fee!==void 0&&(typeof e.fee!="number"||e.fee<0))throw new d("fee must be a non-negative number",h.VALIDATION_ERROR);if(typeof e.symbol!="string"||!e.symbol.trim())throw new d("Symbol is required",h.VALIDATION_ERROR)}handleError(t,e){if(t instanceof d)return t;if(t.response&&t.response.errors){const s=t.response.errors[0];return new d(s.detail||e,h.VALIDATION_ERROR,s.code,s)}return t.name==="TypeError"||t.message?.includes("fetch")?new d("Network error occurred",h.NETWORK_ERROR):new d(t.message||e,h.SERVER_ERROR)}isNotFoundError(t){return t.status===404||t.response?.status===404||t.message?.includes("not found")}}const R=new gt,P=Object.freeze(Object.defineProperty({__proto__:null,platformService:R},Symbol.toStringTag,{value:"Module"}));class wt{constructor(){this.settingsEndpoint="/settings"}async getSetting(t,e){try{if(f.forum){const s=f.forum.attribute(t);if(s!=null)return s}return e}catch(s){throw this.handleError(s,`Failed to get setting: ${t}`)}}async saveSetting(t,e){try{if(!t||typeof t!="string")throw new d("Setting key must be a non-empty string",h.VALIDATION_ERROR);const s=this.prepareValueForStorage(e);await f.store.createRecord("settings").save({[t]:s}),f.forum&&f.forum.pushAttributes({[t]:e})}catch(s){throw this.handleError(s,`Failed to save setting: ${t}`)}}async saveSettings(t){try{if(!t||typeof t!="object")throw new d("Settings must be an object",h.VALIDATION_ERROR);const e={},s={};for(const[o,i]of Object.entries(t)){if(!o||typeof o!="string")throw new d(`Setting key '${o}' must be a non-empty string`,h.VALIDATION_ERROR);e[o]=this.prepareValueForStorage(i),s[o]=i}await f.store.createRecord("settings").save(e),f.forum&&f.forum.pushAttributes(s)}catch(e){throw this.handleError(e,"Failed to save multiple settings")}}async deleteSetting(t){try{if(!t||typeof t!="string")throw new d("Setting key must be a non-empty string",h.VALIDATION_ERROR);await this.saveSetting(t,null)}catch(e){throw this.handleError(e,`Failed to delete setting: ${t}`)}}async getSettingsWithPrefix(t){try{if(!t||typeof t!="string")throw new d("Prefix must be a non-empty string",h.VALIDATION_ERROR);const e={};if(f.forum){const s=f.forum.data.attributes??{};for(const[n,o]of Object.entries(s))n.startsWith(t)&&(e[n]=o)}return e}catch(e){throw this.handleError(e,`Failed to get settings with prefix: ${t}`)}}canManageSettings(){const t=f.session.user;return!!(t&&t.isAdmin())}async getExtensionSetting(t,e,s){const n=`${t}.${e}`;return await this.getSetting(n,s)}async saveExtensionSetting(t,e,s){const n=`${t}.${e}`;return await this.saveSetting(n,s)}async getWithdrawalSetting(t,e){return await this.getExtensionSetting("wusong8899-funds",t,e)}async saveWithdrawalSetting(t,e){return await this.saveExtensionSetting("wusong8899-funds",t,e)}async getAllWithdrawalSettings(){return await this.getSettingsWithPrefix("wusong8899-funds.")}prepareValueForStorage(t){return t==null?"":typeof t=="string"?t:typeof t=="boolean"?t?"1":"0":typeof t=="number"?String(t):JSON.stringify(t)}handleError(t,e){if(t instanceof d)return t;if(t.status===403||t.response?.status===403)return new d("Admin permissions required to manage settings",h.PERMISSION_DENIED);if(t.response&&t.response.errors){const s=t.response.errors[0];return new d(s.detail||e,h.VALIDATION_ERROR,s.code,s)}return t.name==="TypeError"||t.message?.includes("fetch")?new d("Network error occurred while managing settings",h.NETWORK_ERROR):new d(t.message||e,h.SERVER_ERROR)}}const bt=new wt,yt=Object.freeze(Object.defineProperty({__proto__:null,settingsService:bt},Symbol.toStringTag,{value:"Module"}));class At extends A{view(){return r("div",null,"Withdrawals Content")}}class vt extends A{view(){return r("div",null,"Deposits Content")}}class It extends tt{constructor(){super(...arguments),this.depositPlatforms=[],this.depositRecords=[],this.users={}}getConfig(){return{pageTitle:a.translator.trans("funds.admin.page.title").toString(),extensionId:"WithdrawalManagement",platformOperations:ct(),transactionOperations:ut(),settingsComponent:et,tabs:[{key:"withdrawals",label:a.translator.trans("funds.admin.tabs.withdrawals").toString(),component:At},{key:"deposits",label:a.translator.trans("funds.admin.tabs.deposits").toString(),component:vt}],translations:{platformPrefix:"funds.admin.platforms",transactionPrefix:"funds.admin.requests"}}}renderActiveTabContent(){return this.activeTab==="withdrawals"?r("div",null,r(at,{platforms:this.platforms,submittingPlatform:this.submittingPlatform,onAddPlatform:this.addPlatform.bind(this),onEditPlatform:this.editPlatform.bind(this),onTogglePlatformStatus:this.togglePlatformStatus.bind(this),onDeletePlatform:this.deletePlatform.bind(this)}),r(nt,{requests:this.transactions,onUpdateRequestStatus:this.updateTransactionStatus.bind(this),onDeleteRequest:this.deleteWithdrawalRequest.bind(this)})):this.activeTab==="deposits"?r("div",null,r(dt,{platforms:this.depositPlatforms,submittingPlatform:this.submittingPlatform,onAddPlatform:this.addDepositPlatform.bind(this),onEditPlatform:this.editDepositPlatform.bind(this),onTogglePlatformStatus:this.toggleDepositPlatformStatus.bind(this),onDeletePlatform:this.deleteDepositPlatform.bind(this)}),r(ot,{platforms:this.depositPlatforms,records:this.depositRecords,loading:this.loading,onApproveRecord:this.approveDepositRecord.bind(this),onRejectRecord:this.rejectDepositRecord.bind(this),onDeleteRecord:this.deleteDepositRecord.bind(this)})):super.renderActiveTabContent()}async loadData(){try{await this.loadPlatforms(),await this.loadTransactions(),await this.loadUserData(),await this.loadDepositPlatforms(),await this.loadDepositRecords()}catch(t){console.error("Error loading data:",t)}finally{this.loading=!1,r.redraw()}}async addDepositPlatform(t){if(!this.submittingPlatform){this.submittingPlatform=!0,r.redraw();try{const e={...t,minAmount:parseFloat(t.minAmount)||0,maxAmount:t.maxAmount&&t.maxAmount.trim()?parseFloat(t.maxAmount):null,fee:t.fee&&t.fee.trim()?parseFloat(t.fee):0,isActive:t.isActive!==void 0?t.isActive:!0};await R.create("deposit",e),await this.loadDepositPlatforms(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.platforms.add_success"))}catch(e){console.error("Error adding deposit platform:",e);let s=a.translator.trans("funds.admin.deposit.platforms.add_error").toString();e instanceof d&&(s=e.message),a.alerts.show({type:"error",dismissible:!0},s)}finally{this.submittingPlatform=!1,r.redraw()}}}async toggleDepositPlatformStatus(t){try{await R.toggleStatus(t),await this.loadDepositPlatforms(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.platforms.status_updated")),r.redraw()}catch(e){console.error("Error toggling deposit platform status:",e);let s=a.translator.trans("funds.admin.deposit.platforms.status_error").toString();e instanceof d&&(s=e.message),a.alerts.show({type:"error",dismissible:!0},s)}}async editDepositPlatform(t,e){try{const s=this.depositPlatforms.find(o=>(typeof o.id=="function"?o.id():o.id)===t);if(!s)throw new Error("Deposit platform not found");const n={...e,minAmount:parseFloat(e.minAmount)||0,maxAmount:e.maxAmount&&e.maxAmount.trim()?parseFloat(e.maxAmount):null,fee:e.fee&&e.fee.trim()?parseFloat(e.fee):0,isActive:e.isActive!==void 0?e.isActive:!0};await R.update(s,n),await this.loadDepositPlatforms(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.platforms.edit_success")),r.redraw()}catch(s){console.error("Error editing deposit platform:",s);let n=a.translator.trans("funds.admin.deposit.platforms.edit_error").toString();throw s instanceof d&&(n=s.message),a.alerts.show({type:"error",dismissible:!0},n),s}}async deleteDepositPlatform(t){const e=(typeof t.name=="function"?t.name():t.name)||"Unknown Platform";a.modal.show(T,{title:a.translator.trans("funds.admin.platforms.delete_confirm_title"),message:a.translator.trans("funds.admin.platforms.delete_confirm_message",{name:e}),confirmText:a.translator.trans("funds.admin.platforms.delete_confirm_button"),cancelText:a.translator.trans("funds.admin.platforms.delete_cancel_button"),dangerous:!0,icon:"fas fa-trash",onConfirm:async()=>{try{await R.delete(t),await this.loadDepositPlatforms(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.platforms.delete_success"))}catch(s){console.error("Error deleting deposit platform:",s);let n=a.translator.trans("funds.admin.deposit.platforms.delete_error").toString();s instanceof d&&(n=s.message),a.alerts.show({type:"error",dismissible:!0},n)}r.redraw()},onCancel:()=>{a.modal.close()}})}async updateDepositRecordStatus(t,e){try{await x.update(t.id(),{status:e}),await this.loadDepositRecords(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.records.status_updated")),r.redraw()}catch(s){console.error("Error updating deposit record:",s);let n=a.translator.trans("funds.admin.deposit.records.status_error").toString();s instanceof d&&(n=s.message),a.alerts.show({type:"error",dismissible:!0},n)}}deleteWithdrawalRequest(t){const e=typeof t.id=="function"?t.id():t.id,s=typeof t.amount=="function"?t.amount():t.attributes?.amount||0;let n="Unknown User";if(typeof t.user=="function"){const o=t.user();o&&typeof o.displayName=="function"?n=o.displayName():o&&o.attributes?.displayName&&(n=o.attributes.displayName)}a.modal.show(T,{title:a.translator.trans("funds.admin.requests.delete_confirm_title"),message:a.translator.trans("funds.admin.requests.delete_confirm_message",{info:`${n} - ${s}`}),confirmText:a.translator.trans("funds.admin.requests.delete_confirm_button"),cancelText:a.translator.trans("funds.admin.requests.delete_cancel_button"),dangerous:!0,icon:"fas fa-trash",onConfirm:async()=>{try{const o=a.store.getById("withdrawal-requests",e);o&&(await o.delete(),await this.loadTransactions(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.requests.delete_success")))}catch(o){console.error("Error deleting request:",o),a.alerts.show({type:"error",dismissible:!0},a.translator.trans("funds.admin.requests.delete_error"))}},onCancel:()=>{a.modal.close()}})}async loadDepositPlatforms(){try{this.depositPlatforms=await R.find("deposit",{sort:"name"}),console.log("Loaded deposit platforms:",this.depositPlatforms)}catch(t){console.error("Error loading deposit platforms:",t),this.depositPlatforms=[]}}async loadUserData(){if(this.transactions.length===0)return;const e=[...new Set(this.transactions.map(s=>{const n=s?.data?.relationships?.user?.data||s?.relationships?.user?.data;return n?n.id:null}).filter(s=>s!=null))].filter(s=>!this.users[s]);if(e.length>0)try{const s=e.map(o=>a.store.find("users",o).catch(i=>(console.error(`Error loading user ${o}:`,i),null))),n=await Promise.all(s);e.forEach((o,i)=>{n[i]&&(this.users[o]=n[i])})}catch(s){console.error("Error loading users:",s)}}async loadDepositRecords(){try{const t=await x.find({include:"user,platform",sort:"-createdAt"});this.depositRecords=t,console.log("Loaded deposit records:",this.depositRecords)}catch(t){console.error("Error loading deposit records:",t),this.depositRecords=[]}}async approveDepositRecord(t,e,s){try{const n={status:"approved"};e!==void 0&&(n.creditedAmount=e),s&&(n.adminNotes=s),await x.update(t.id(),n),await this.loadDepositRecords(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.records.approve_success")),r.redraw()}catch(n){console.error("Error approving deposit record:",n);let o=a.translator.trans("funds.admin.deposit.records.approve_error").toString();throw n instanceof d&&(o=n.message),a.alerts.show({type:"error",dismissible:!0},o),n}}async rejectDepositRecord(t,e){try{await x.update(t.id(),{status:"rejected",adminNotes:e}),await this.loadDepositRecords(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.records.reject_success")),r.redraw()}catch(s){console.error("Error rejecting deposit record:",s);let n=a.translator.trans("funds.admin.deposit.records.reject_error").toString();throw s instanceof d&&(n=s.message),a.alerts.show({type:"error",dismissible:!0},n),s}}async deleteDepositRecord(t){try{await x.delete(t),await this.loadDepositRecords(),a.alerts.show({type:"success",dismissible:!0},a.translator.trans("funds.admin.deposit.records.delete_success")),r.redraw()}catch(e){console.error("Error deleting deposit record:",e);let s=a.translator.trans("funds.admin.deposit.records.delete_error").toString();throw e instanceof d&&(s=e.message),a.alerts.show({type:"error",dismissible:!0},s),e}}}function J(l){const t=[];return l.name!==void 0&&(!l.name||typeof l.name!="string")&&t.push("Platform name is required"),l.symbol!==void 0&&(!l.symbol||typeof l.symbol!="string")&&t.push("Symbol is required"),t}function Q(l,t){const e=[];if(l.minAmount!==void 0&&(typeof l.minAmount!="number"||l.minAmount<0)&&e.push("Minimum amount must be a non-negative number"),l.maxAmount!==void 0&&l.maxAmount!==null){(typeof l.maxAmount!="number"||l.maxAmount<0)&&e.push("Maximum amount must be a non-negative number");const s=l.minAmount??t??0;l.maxAmount<s&&e.push("Maximum amount must be greater than or equal to minimum amount")}return l.fee!==void 0&&l.fee!==null&&(typeof l.fee!="number"||l.fee<0)&&e.push("Fee must be a non-negative number"),e}function Nt(l){const t=[];return l.network!==void 0&&l.network!==null&&l.network!==""&&typeof l.network!="string"&&t.push("Network must be a string"),l.address!==void 0&&l.address!==null&&l.address!==""&&typeof l.address!="string"&&t.push("Deposit address must be a string"),t}function Z(l){if(l.length>0)throw new d(l.join(", "),h.VALIDATION_ERROR)}function Dt(l,t){const e=[...J(l),...Q(l,t)];Z(e)}function Rt(l,t){const e=[...J(l),...Q(l,t),...Nt(l)];Z(e)}class Et extends c{constructor(){super(...arguments),this.name=c.attribute("name"),this.symbol=c.attribute("symbol"),this.network=c.attribute("network"),this.displayName=c.attribute("displayName"),this.minAmount=c.attribute("minAmount"),this.maxAmount=c.attribute("maxAmount"),this.fee=c.attribute("fee"),this.platformIconUrl=c.attribute("platformIconUrl"),this.platformIconClass=c.attribute("platformIconClass"),this.isActive=c.attribute("isActive"),this.createdAt=c.attribute("createdAt",c.transformDate),this.updatedAt=c.attribute("updatedAt",c.transformDate),this.bestIcon=c.attribute("bestIcon")}apiEndpoint(){const t=this.id();return t?`/withdrawal-platforms/${t}`:"/withdrawal-platforms"}getDisplayName(){return this.displayName()||this.name()}isValidAmount(t){const e=this.minAmount(),s=this.maxAmount();return t>=e&&t<=s}getTotalCost(t){return t+this.fee()}async save(t){t&&this.validateAttributes(t);try{return await super.save(t||{})}catch(e){throw this.handleSaveError(e)}}async delete(){if(!this.canDelete())throw new d("You do not have permission to delete this platform",h.PERMISSION_DENIED);if(await this.isInUse())throw new d("Cannot delete platform that has pending funds requests",h.VALIDATION_ERROR);try{await super.delete()}catch(t){throw this.handleDeleteError(t)}}async toggleStatus(){if(!this.canModify())throw new d("You do not have permission to modify this platform",h.PERMISSION_DENIED);return await this.save({isActive:!this.isActive()})}clone(){const t=f.store.createRecord("withdrawal-platforms");return t.pushAttributes({name:this.name()+" (Copy)",symbol:this.symbol(),network:this.network(),minAmount:this.minAmount(),maxAmount:this.maxAmount(),fee:this.fee(),platformIconUrl:this.platformIconUrl(),platformIconClass:this.platformIconClass(),isActive:!1}),t}validateAmount(t){const e=[];return typeof t!="number"||t<=0?(e.push("Amount must be a positive number"),{valid:!1,errors:e}):(t<this.minAmount()&&e.push(`Amount must be at least ${this.minAmount()} ${this.symbol()}`),this.maxAmount()&&t>this.maxAmount()&&e.push(`Amount cannot exceed ${this.maxAmount()} ${this.symbol()}`),{valid:e.length===0,errors:e})}validateUserBalance(t,e){const s=[],n=this.getTotalCost(t);if(e<n){const o=this.fee()>0?` (including ${this.fee()} ${this.symbol()} fee)`:"";s.push(`Insufficient balance. Required: ${n} ${this.symbol()}${o}, Available: ${e} ${this.symbol()}`)}return{valid:s.length===0,errors:s}}canModify(){const t=f.session.user;return!!(t&&t.isAdmin())}canDelete(){const t=f.session.user;return!!(t&&t.isAdmin())}canView(){if(this.isActive())return!0;const t=f.session.user;return!!(t&&t.isAdmin())}async isInUse(){try{const t=this.id();if(!t)return!1;const e=await f.store.find("withdrawal-requests",{filter:{platform:t,status:"pending"}});return(Array.isArray(e)?e:[e]).length>0}catch{return!0}}getFormattedFee(){const t=this.fee();return t===0?"Free":`${t} ${this.symbol()}`}getFormattedLimits(){const t=this.minAmount(),e=this.maxAmount(),s=this.symbol();return e?`${t} - ${e} ${s}`:`Min: ${t} ${s}`}validateAttributes(t){Dt(t,this.minAmount())}handleSaveError(t){if(t instanceof d)return t;if(t.response&&t.response.errors){const e=t.response.errors[0];return new d(e.detail||"Failed to save withdrawal platform",h.VALIDATION_ERROR,e.code,e)}return new d(t.message||"Failed to save withdrawal platform",h.SERVER_ERROR)}handleDeleteError(t){return t instanceof d?t:t.status===403||t.response?.status===403?new d("You do not have permission to delete this platform",h.PERMISSION_DENIED):new d(t.message||"Failed to delete withdrawal platform",h.SERVER_ERROR)}}const E={PENDING:"pending",APPROVED:"approved",REJECTED:"rejected"};class _t extends c{constructor(){super(...arguments),this.amount=c.attribute("amount"),this.accountDetails=c.attribute("accountDetails"),this.message=c.attribute("message"),this.status=c.attribute("status"),this.platformId=c.attribute("platformId"),this.userId=c.attribute("userId"),this.createdAt=c.attribute("createdAt",t=>c.transformDate(t)),this.updatedAt=c.attribute("updatedAt",t=>c.transformDate(t)),this.user=c.hasOne("user"),this.platform=c.hasOne("platform")}apiEndpoint(){const t=this.id();return t?`/withdrawal-requests/${t}`:"/withdrawal-requests"}isPending(){return this.status()===E.PENDING}isApproved(){return this.status()===E.APPROVED}isRejected(){return this.status()===E.REJECTED}canBeModified(){return this.isPending()}statusLabel(){const t=this.status();return f.translator.trans(`funds.forum.status.${t}`).toString()}statusColor(){switch(this.status()){case E.APPROVED:return"success";case E.REJECTED:return"danger";case E.PENDING:default:return"warning"}}async save(t){t&&this.validateAttributes(t);try{return await super.save(t||{})}catch(e){throw this.handleSaveError(e)}}async delete(){if(!this.canDelete())throw new d("You do not have permission to delete this request",h.PERMISSION_DENIED);const t=f.session.user;if(t&&!t.isAdmin()&&!this.canBeModified())throw new d("This request cannot be deleted as it has already been processed",h.VALIDATION_ERROR);try{await super.delete()}catch(e){throw this.handleDeleteError(e)}}clone(){const t=f.store.createRecord("withdrawal-requests");return t.pushAttributes({platformId:this.platformId(),amount:this.amount(),accountDetails:this.accountDetails(),message:this.message()}),t}getTotalCost(){const t=this.platform(),e=t&&t.fee()||0;return this.amount()+e}getFormattedAmount(){const t=this.platform(),e=t?t.symbol():"";return`${this.amount()} ${e}`.trim()}getFormattedTotalCost(){const t=this.platform(),e=t?t.symbol():"",s=t&&t.fee()||0;return s>0?`${this.amount()} + ${s} (fee) = ${this.getTotalCost()} ${e}`.trim():this.getFormattedAmount()}canModify(){const t=f.session.user;return t?t.isAdmin()?!0:String(this.userId())===t.id()&&this.canBeModified():!1}canDelete(){const t=f.session.user;return t?t.isAdmin()?!0:String(this.userId())===t.id()&&this.canBeModified():!1}canView(){const t=f.session.user;return t?t.isAdmin()?!0:String(this.userId())===t.id():!1}validateAttributes(t){const e=[];if(t.amount!==void 0&&(typeof t.amount!="number"||t.amount<=0)&&e.push("Amount must be a positive number"),t.accountDetails!==void 0&&(!t.accountDetails||typeof t.accountDetails!="string")&&e.push("Account details are required"),t.platformId!==void 0&&(!t.platformId||typeof t.platformId!="number")&&e.push("Platform selection is required"),e.length>0)throw new d(e.join(", "),h.VALIDATION_ERROR)}handleSaveError(t){if(t instanceof d)return t;if(t.response&&t.response.errors){const e=t.response.errors[0];return new d(e.detail||"Failed to save funds request",h.VALIDATION_ERROR,e.code,e)}return new d(t.message||"Failed to save funds request",h.SERVER_ERROR)}handleDeleteError(t){return t instanceof d?t:t.status===403||t.response?.status===403?new d("You do not have permission to delete this request",h.PERMISSION_DENIED):new d(t.message||"Failed to delete funds request",h.SERVER_ERROR)}}class St extends c{constructor(){super(...arguments),this.name=c.attribute("name"),this.symbol=c.attribute("symbol"),this.network=c.attribute("network"),this.networkTypeId=c.attribute("networkTypeId"),this.displayName=c.attribute("displayName"),this.minAmount=c.attribute("minAmount"),this.maxAmount=c.attribute("maxAmount"),this.fee=c.attribute("fee"),this.address=c.attribute("address"),this.qrCodeImageUrl=c.attribute("qrCodeImageUrl"),this.platformIconUrl=c.attribute("platformIconUrl"),this.platformIconClass=c.attribute("platformIconClass"),this.warningText=c.attribute("warningText"),this.networkConfig=c.attribute("networkConfig"),this.isActive=c.attribute("isActive"),this.createdAt=c.attribute("createdAt",t=>c.transformDate(t)),this.updatedAt=c.attribute("updatedAt",t=>c.transformDate(t)),this.networkType=c.hasOne("networkType"),this.bestIcon=c.attribute("bestIcon")}getDisplayName(){return this.displayName()||this.name()}getFullDisplayName(){const t=this.getDisplayName(),e=this.network();return e?`${t} (${e})`:t}isValidAmount(t){const e=this.minAmount()||0,s=this.maxAmount();return t>=e&&(!s||t<=s)}getTotalCost(t){return t+(this.fee()||0)}async save(t){t&&this.validateAttributes(t);try{return await super.save(t||{})}catch(e){throw this.handleSaveError(e)}}async delete(){if(!this.canDelete())throw new d("You do not have permission to delete this platform",h.PERMISSION_DENIED);if(await this.isInUse())throw new d("Cannot delete platform that has pending deposit records",h.VALIDATION_ERROR);try{await super.delete()}catch(t){throw this.handleDeleteError(t)}}async toggleStatus(){if(!this.canModify())throw new d("You do not have permission to modify this platform",h.PERMISSION_DENIED);return await this.save({isActive:!this.isActive()})}clone(){const t=f.store.createRecord("deposit-platforms");return t.pushAttributes({name:this.name()+" (Copy)",symbol:this.symbol(),network:this.network(),networkTypeId:this.networkTypeId(),minAmount:this.minAmount(),maxAmount:this.maxAmount(),fee:this.fee(),address:this.address(),qrCodeImageUrl:this.qrCodeImageUrl(),platformIconUrl:this.platformIconUrl(),platformIconClass:this.platformIconClass(),warningText:this.warningText(),isActive:!1}),t}validateAmount(t){const e=[];if(typeof t!="number"||t<=0)return e.push("Amount must be a positive number"),{valid:!1,errors:e};const s=this.minAmount()||0;t<s&&e.push(`Amount must be at least ${s} ${this.symbol()}`);const n=this.maxAmount();return n&&t>n&&e.push(`Amount cannot exceed ${n} ${this.symbol()}`),{valid:e.length===0,errors:e}}canModify(){const t=f.session.user;return!!(t&&t.isAdmin())}canDelete(){const t=f.session.user;return!!(t&&t.isAdmin())}canView(){if(this.isActive())return!0;const t=f.session.user;return!!(t&&t.isAdmin())}async isInUse(){try{const t=this.id();if(!t)return!1;const e=await f.store.find("deposit-records",{filter:{platform:t.toString(),status:"pending"}});return(Array.isArray(e)?e:[e]).length>0}catch{return!0}}getFormattedFee(){const t=this.fee()||0;return t===0?"Free":`${t} ${this.symbol()}`}getFormattedLimits(){const t=this.minAmount()||0,e=this.maxAmount(),s=this.symbol();return e?`${t} - ${e} ${s}`:`Min: ${t} ${s}`}generateDepositAddress(t){const e=this.address();if(e&&typeof e=="string")return e;throw new d("No deposit address configured for this platform",h.VALIDATION_ERROR)}validateAttributes(t){Rt(t,this.minAmount()||void 0)}handleSaveError(t){if(t instanceof d)return t;if(t.response&&t.response.errors){const e=t.response.errors[0];return new d(e.detail||"Failed to save deposit platform",h.VALIDATION_ERROR,e.code,e)}return new d(t.message||"Failed to save deposit platform",h.SERVER_ERROR)}handleDeleteError(t){return t instanceof d?t:t.status===403||t.response?.status===403?new d("You do not have permission to delete this platform",h.PERMISSION_DENIED):new d(t.message||"Failed to delete deposit platform",h.SERVER_ERROR)}}class xt extends c{constructor(){super(...arguments),this.userId=c.attribute("userId"),this.platformId=c.attribute("platformId"),this.amount=c.attribute("amount"),this.depositTime=c.attribute("depositTime",c.transformDate),this.userMessage=c.attribute("userMessage"),this.status=c.attribute("status"),this.statusText=c.attribute("statusText"),this.processedAt=c.attribute("processedAt",c.transformDate),this.processedBy=c.attribute("processedBy"),this.adminNotes=c.attribute("adminNotes"),this.createdAt=c.attribute("createdAt",c.transformDate),this.updatedAt=c.attribute("updatedAt",c.transformDate),this.formattedCreatedAt=c.attribute("formattedCreatedAt"),this.formattedProcessedAt=c.attribute("formattedProcessedAt"),this.isPending=c.attribute("isPending"),this.isApproved=c.attribute("isApproved"),this.isRejected=c.attribute("isRejected"),this.user=c.hasOne("user"),this.processedByUser=c.hasOne("processedByUser"),this.platform=c.hasOne("platform")}getStatusColor(){switch(this.status()){case"pending":return"warning";case"approved":return"success";case"rejected":return"danger";default:return"secondary"}}getStatusIcon(){switch(this.status()){case"pending":return"fas fa-clock";case"approved":return"fas fa-check-circle";case"rejected":return"fas fa-times-circle";default:return"fas fa-question-circle"}}canEdit(t){return t?t.isAdmin()?!0:this.userId().toString()===t.id()&&this.isPending():!1}canDelete(t){return t&&t.isAdmin()||!1}getFormattedAmount(){const t=this.amount();return t?t.toFixed(2):"0.00"}getFormattedDepositTime(){const t=this.depositTime();return t?t.toLocaleDateString()+" "+t.toLocaleTimeString():""}}a.initializers.add("wusong8899-funds",()=>{a.store.models["withdrawal-platforms"]=Et,a.store.models["withdrawal-requests"]=_t,a.store.models["deposit-platforms"]=St,a.store.models["deposit-records"]=xt,a.extensionData.for("wusong8899-funds").registerPage(It)})})(flarum.core.compat["common/app"],flarum.core.compat["admin/app"],m,flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/components/LoadingIndicator"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/helpers/icon"],flarum.core.compat["common/Component"],flarum.core.compat["common/utils/withAttr"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/components/Switch"],flarum.core.compat["common/helpers/humanTime"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=admin.js.map

module.exports={};